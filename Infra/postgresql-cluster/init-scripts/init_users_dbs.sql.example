-- PostgreSQL 초기화 스크립트 (Initialization Script)
-- 주의: 이 스크립트는 데이터 볼륨이 비어 있을 때 최초 1회만 실행됩니다.

---------------------------------------------------------
-- 1. n8n 설정
---------------------------------------------------------
-- 사용자 생성 (존재하지 않을 경우에만 생성하도록 DO 블록 활용)
DO $$
BEGIN
    IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'app_user') THEN
        CREATE USER app_user WITH PASSWORD '<password>';
    END IF;
END
$$;

-- 데이터베이스 생성 및 권한 부여
CREATE DATABASE app_db OWNER app_user;
GRANT ALL PRIVILEGES ON DATABASE app_db TO app_user;

-- 해당 DB로 접속하여 스키마 권한 설정
\connect app_db
-- PostgreSQL 15 이상 대응: public 스키마 권한 명시적 부여
GRANT ALL ON SCHEMA public TO app_user;
-- n8n 사용자가 public 스키마의 소유권을 갖게 하여 확장을 자유롭게 함
ALTER SCHEMA public OWNER TO app_user;
