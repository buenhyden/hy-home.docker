version: "3.9"

networks:
  infra_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.19.0.0/16
  kind:
    external: true # 이미 존재하는 docker 네트워크(이름: kind)에 부착

volumes:
  grafana_data: {}
  prometheus_data: {}
  loki_data: {}
  tempo_data: {}
  minio_data: {}
  pg_data: {}
  es_data: {}
  kafka_data: {}
  redis_data: {}

services:
  traefik:
    image: traefik:v3.0
    command:
      - "--api.dashboard=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
    volumes:
      - ./traefik/dynamic:/etc/traefik/dynamic
      - ./traefik/certs:/etc/traefik/certs
    ports: ["80:80", "443:443", "8080:8080"] # 8080 대시보드
    networks: ["infra_net", "kind"]

  grafana:
    image: grafana/grafana:11.2.0
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes: ["grafana_data:/var/lib/grafana"]
    ports: ["3000:3000"]
    networks: ["infra_net"]

  prometheus:
    image: prom/prometheus:v2.55.0
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ${HOME}/.kube/config:/kubeconfig:ro
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
    ports: ["9090:9090"]
    networks: ["infra_net"]

  alloy:
    image: grafana/alloy:latest
    volumes:
      - ./alloy/config.alloy:/etc/alloy/config.alloy:ro
    ports:
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
    networks: ["infra_net"]

  loki:
    image: grafana/loki:3.0.0
    command: ["-config.file=/etc/loki/config.yml"]
    volumes:
      - ./loki/config.yml:/etc/loki/config.yml:ro
      - loki_data:/data
    ports: ["3100:3100"]
    networks: ["infra_net"]

  tempo:
    image: grafana/tempo:2.6.0
    command: ["-config.file=/etc/tempo/tempo.yml"]
    volumes:
      - ./tempo/tempo.yml:/etc/tempo/tempo.yml:ro
      - tempo_data:/var/tempo
    ports: ["3200:3200", "4317:14317", "4318:14318"]
    networks: ["infra_net"]

  minio:
    image: minio/minio:RELEASE.2025-09-...
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=MINIO_ADMIN
      - MINIO_ROOT_PASSWORD=ChangeMe_Long!
    volumes: ["minio_data:/data"]
    ports: ["9000:9000", "9001:9001"]
    networks: ["infra_net"]

  postgres:
    image: bitnami/postgresql:17
    environment:
      - POSTGRES_PASSWORD=ChangeMe_Long!
      - POSTGRES_DB=app
      - POSTGRES_USER=app
    volumes: ["pg_data:/bitnami/postgresql"]
    ports: ["5432:5432"]
    networks: ["infra_net"]

  redis:
    image: bitnami/redis:7.2
    environment:
      - ALLOW_EMPTY_PASSWORD=no
      - REDIS_PASSWORD=ChangeMe_Long!
    volumes: ["redis_data:/bitnami/redis"]
    ports: ["6379:6379"]
    networks: ["infra_net"]

  kafka:
    image: bitnami/kafka:3.7
    environment:
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_KRAFT_CLUSTER_ID=9h2k8J60QLOyN7zO6C5x1g # 예시
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
    volumes: ["kafka_data:/bitnami/kafka"]
    ports: ["9092:9092"]
    networks: ["infra_net"]

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.15.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
    volumes: ["es_data:/usr/share/elasticsearch/data"]
    ports: ["9200:9200"]
    networks: ["infra_net"]

  kibana:
    image: docker.elastic.co/kibana/kibana:8.15.0
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    ports: ["5601:5601"]
    networks: ["infra_net"]
