name: CI/CD Pipeline

on:
  workflow_dispatch:
    inputs:
      services:
        description: >-
          Specific services to test (space-separated, empty for all changed)
        required: false
        default: ""
  pull_request:
    branches: ["main"]
    paths:
      - "Infra/**"
      - "scripts/**"
      - ".github/PULL_REQUEST_TEMPLATE.md"
      - ".github/workflows/**"

jobs:
  # 1. Lint & Validation Job
  lint:
    name: Lint YAML and Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python (for yamllint)
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint YAML files
        run: yamllint .

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Lint shell scripts
        run: |
          find scripts -type f -name "*.sh" -print0 | \
            xargs -0 shellcheck

  # 2. Validate Docker Compose and Detect Changed Services
  validate:
    name: Validate Compose and Detect Changes
    runs-on: ubuntu-latest
    needs: lint
    outputs:
      services: ${{ steps.changed.outputs.services }}
      services_json: ${{ steps.changed.outputs.services_json }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Compose and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose-plugin jq

      - name: Validate Docker Compose configuration
        run: docker compose -f Infra/docker-compose.yml config

      - name: Initialize changed services outputs (manual dispatch)
        id: init_changed
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ -n "${{ github.event.inputs.services }}" ]; then
            SERVICES="${{ github.event.inputs.services }}"
            SERVICES_JSON=$(printf '%s\n' $SERVICES | \
              awk '{printf "\"%s\",", $0}' | sed 's/,$//')
            SERVICES_JSON="[${SERVICES_JSON}]"
            echo "services=$SERVICES" >> $GITHUB_OUTPUT
            echo "services_json=$SERVICES_JSON" >> $GITHUB_OUTPUT
          else
            echo "services=" >> $GITHUB_OUTPUT
            echo "services_json=[]" >> $GITHUB_OUTPUT
          fi

      - name: Determine changed Infra services (PR only)
        if: github.event_name == 'pull_request'
        id: changed
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }} \
            --depth=1 || true
          BASE=origin/${{ github.event.pull_request.base.ref }}
          CHANGED_FILES=$(git diff --name-only $BASE...HEAD || true)

          # Only match files under Infra/<service>/ to ignore top-level files
          SERVICES=$(echo "$CHANGED_FILES" | \
            grep -E '^Infra/[^/]+/' | \
            awk -F'/' '{print $2}' | \
            sort -u | tr '\n' ' ')

          if [ -z "$SERVICES" ]; then
            SERVICES_JSON='[]'
          else
            SERVICES_JSON=$(printf '%s\n' $SERVICES | \
              awk '{printf "\"%s\",", $0}' | sed 's/,$//')
            SERVICES_JSON="[${SERVICES_JSON}]"
          fi

          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "services_json=$SERVICES_JSON" >> $GITHUB_OUTPUT

      - name: Run shell script tests
        run: |
          scripts/tests/test_detect_changed_services.sh
          scripts/tests/test_validate_compose_change.sh

      - name: Verify PR declared services match detected
        if: >-
          github.event_name == 'pull_request' &&
          steps.changed.outputs.services != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = context.payload.pull_request.body || '';
            const matches = [
              ...body.matchAll(/Infra\/([A-Za-z0-9_.-]+)/g)
            ].map(m => m[1]);
            const prSet = [...new Set(matches)].sort();

            const detectedRaw = `${{ steps.changed.outputs.services }}`;
            const detected = detectedRaw.trim()
              ? detectedRaw.split(/\s+/).filter(Boolean).sort()
              : [];

            if (JSON.stringify(prSet) !== JSON.stringify(detected)) {
              const comment = `:warning: 서비스 불일치 감지
              PR에 선언된 서비스: ${prSet.join(', ') || '(없음)'}
              감지된 변경 서비스: ${detected.join(', ') || '(없음)'}

              PR 본문을 수정하거나 변경된 파일을 확인하세요.`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });

              throw new Error(
                'PR 서비스 목록과 감지된 변경 서비스가 일치하지 않습니다.'
              );
            }

      - name: Post changed services to PR (if any)
        if: >-
          github.event_name == 'pull_request' &&
          steps.changed.outputs.services != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const services = `${{ steps.changed.outputs.services }}`.trim();
            if (!services) return;

            const body = `Detected changed Infra services: ${services}

            To smoke-test locally, run:
            \`./scripts/validate_compose_change.sh <service> --up\``;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

  # 3. Smoke Tests (Matrix-based on Changed Services)
  smoke-tests:
    name: Smoke Test ${{ matrix.service }}
    needs: validate
    runs-on: ubuntu-latest
    if: needs.validate.outputs.services_json != '[]'
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        service: ${{ fromJson(needs.validate.outputs.services_json) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose-plugin jq

      - name: Smoke test service
        run: |
          echo "Smoke testing ${{ matrix.service }}"
          ./scripts/validate_compose_change.sh \
            "${{ matrix.service }}" --up
        timeout-minutes: 10

      - name: Save logs on failure
        if: failure()
        run: |
          mkdir -p logs
          echo "Smoke test failed for ${{ matrix.service }}" \
            > logs/failed_${{ matrix.service }}.txt
          echo "Service: ${{ matrix.service }}" \
            >> logs/failed_${{ matrix.service }}.txt
          docker compose -f Infra/docker-compose.yml logs \
            --no-color --tail 200 ${{ matrix.service }} \
            > logs/${{ github.run_id }}_${{ matrix.service }}.logs.txt \
            || true

      - name: Upload failure artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failed-${{ matrix.service }}
          path: logs/

  # 4. Collect and Report Failures
  collect-failures:
    name: Collect Test Failures
    needs: smoke-tests
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download failure artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./failed_artifacts

      - name: List failure artifacts
        run: ls -la failed_artifacts || true

      - name: Post summary and fail if any failures
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = 'failed_artifacts';

            if (!fs.existsSync(path)) return;

            const files = fs.readdirSync(path)
              .filter(f => f.startsWith('failed_'));

            if (files.length === 0) return;

            const serviceList = files
              .map(f => `- ${f.replace('failed_', '').replace('.txt', '')}`)
              .join('\n');

            const body = `:x: Smoke tests failed for the following services:

            ${serviceList}

            Check the workflow artifacts for detailed logs.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

            throw new Error(
              'Some smoke tests failed. See PR comment for details.'
            );

  # 5. PowerShell Tests (Windows)
  powershell-tests:
    name: PowerShell Script Tests
    runs-on: windows-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force `
            -Scope CurrentUser -ErrorAction Stop

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          $files = Get-ChildItem -Path scripts -Filter *.ps1 `
            -Recurse | Select-Object -ExpandProperty FullName
          $violations = $false

          foreach ($f in $files) {
            $res = Invoke-ScriptAnalyzer -Path $f
            if ($res) {
              Write-Host "Issues in $f"
              $res | Format-Table
              $violations = $true
            }
          }

          if ($violations) { exit 1 }

      - name: Run PowerShell tests
        shell: pwsh
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          .\scripts\tests\test_new_infra_service.ps1
          .\scripts\tests\test_new_infra_service_idempotent.ps1
          .\scripts\tests\test_detect_changed_services.ps1
          .\scripts\tests\test_validate_compose_change.ps1
