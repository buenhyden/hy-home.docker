name: open-webui

x-labels-base: &labels-base
  hy-home.managed: 'true'
  hy-home.tier: ai

volumes:
  ollama-webui:
  #   driver: local
  #   driver_opts:
  #     o: bind
  #     type: none
  #     device: ${DEFAULT_AI_MODEL_DIR}/webui

services:
  # 2. Open WebUI 서비스 (선택 사항: ChatGPT 같은 웹 인터페이스)
  open-webui:
    extends:
      file: ../../../infra/common-optimizations.yml
      service: template-infra-med
    image: ghcr.io/open-webui/open-webui:v0.8.5-cuda
    container_name: open-webui
    environment:
      - OLLAMA_BASE_URL=http://ollama:${OLLAMA_PORT:-11434}
      - VECTOR_DB_URL=http://qdrant:${QDRANT_PORT:-6333}
      - RAG_EMBEDDING_ENGINE=ollama
      - RAG_EMBEDDING_MODEL=qwen3-embedding:0.6b
    volumes:
      - ollama-webui:/app/backend/data
    networks:
      infra_net:
        ipv4_address: 172.19.0.42
    labels:
      <<: *labels-base
      traefik.enable: 'true'
      traefik.http.routers.open-webui.rule: Host(`chat.${DEFAULT_URL}`)
      traefik.http.routers.open-webui.entrypoints: websecure
      traefik.http.routers.open-webui.tls: 'true'
      traefik.http.services.open-webui.loadbalancer.server.port: 8080
    logging:
      driver: loki
      options:
        loki-url: 'http://localhost:3100/loki/api/v1/push'
        loki-external-labels: 'container_name={{.Name}}'
