name: open-webui

include:
  - ../../../common-optimizations.yml


volumes:
  ollama-webui:
  #   driver: local
  #   driver_opts:
  #     o: bind
  #     type: none
  #     device: ${DEFAULT_AI_MODEL_DIR}/webui

services:
  # 2. Open WebUI 서비스 (선택 사항: ChatGPT 같은 웹 인터페이스)
  open-webui:
    <<: [*default-restart, *security-baseline, *resource-med]
    profiles:
      - ollama
    image: ghcr.io/open-webui/open-webui:v0.8.5-cuda

    # ports:
    #   - "${OLLAMA_WEBUI_HOST_PORT}:${OLLAMA_WEBUI_PORT}" # 브라우저에서 localhost:3000 으로 접속
    environment:
      - OLLAMA_BASE_URL=http://ollama:${OLLAMA_PORT:-11434} # 도커 네트워크 내부 통신
      # --- RAG 설정 추가 ---
      # 벡터 DB 연결 설정
      - VECTOR_DB_URL=http://qdrant:${QDRANT_PORT:-6333}
      # 임베딩(텍스트를 숫자로 변환) 작업을 Ollama에게 맡김
      - RAG_EMBEDDING_ENGINE=ollama
      - RAG_EMBEDDING_MODEL=qwen3-embedding:0.6b
    volumes:
      - ollama-webui:/app/backend/data
    restart: unless-stopped
    networks:
      infra_net:
        ipv4_address: 172.19.0.42
    labels:
      - 'traefik.enable=true'

      # 챗봇 UI 라우터 (https://chat.${DEFAULT_URL})
      - 'traefik.http.routers.open-webui.rule=Host(`chat.${DEFAULT_URL}`)'
      - 'traefik.http.routers.open-webui.entrypoints=websecure'
      - 'traefik.http.routers.open-webui.tls=true'

      # [중요] 내부 포트 8080 연결 (Open WebUI 기본 포트)
      - 'traefik.http.services.open-webui.loadbalancer.server.port=8080'
    logging: *default-logging
