name: ollama

x-labels-base: &labels-base
  hy-home.managed: 'true'
  hy-home.tier: ai

volumes:
  ollama-data:
    # driver: local
    # driver_opts:
    #   o: bind
    #   type: none
    #   device: ${DEFAULT_AI_MODEL_DIR}/ollama

services:
  ollama:
    profiles:
      - ollama
    extends:
      file: ../../../infra/common-optimizations.yml
      service: template-infra-high
    image: ollama/ollama:0.13.5
    container_name: ollama
    # 하지만 Ollama는 NVIDIA runtime을 사용하므로 cap_drop이 문제될 수 있음.
    # 여기서는 base-resource-high만 가져오고 security는 개별 설정 권장.
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          memory: 4G
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    labels:
      <<: *labels-base
      traefik.enable: 'true'
      traefik.http.routers.ollama.rule: Host(`ollama.${DEFAULT_URL}`)
      traefik.http.routers.ollama.entrypoints: websecure
      traefik.http.routers.ollama.tls: 'true'
      traefik.http.services.ollama.loadbalancer.server.port: ${OLLAMA_PORT:-11434}
      traefik.http.routers.ollama.middlewares: sso-auth@file
    logging:
      driver: loki
      options:
        loki-url: 'http://localhost:3100/loki/api/v1/push'
        loki-external-labels: 'container_name={{.Name}}'

  ollama-exporter:
    extends:
      file: ../../../infra/common-optimizations.yml
      service: template-infra-low
    image: lucabecker42/ollama-exporter:1.0.1
    container_name: ollama-exporter
    environment:
      - OLLAMA_HOST=ollama:${OLLAMA_PORT:-11434}
    expose:
      - '${OLLAMA_EXPORTER_PORT:-11435}'
    networks:
      infra_net:
        ipv4_address: 172.19.0.43
    depends_on:
      ollama:
        condition: service_healthy

networks:
  infra_net:
    name: infra_net
    external: true
