name: ollama

include:
  - ../../../common-optimizations.yml


volumes:
  ollama-data:
    # driver: local
    # driver_opts:
    #   o: bind
    #   type: none
    #   device: ${DEFAULT_AI_MODEL_DIR}/ollama

services:
  ollama:
    <<: [*default-restart, *resource-high]
    profiles:
      - ollama
    image: ollama/ollama:0.13.5
    container_name: ollama
    security_opt:
      - no-new-privileges:true
    expose:
      - '${OLLAMA_PORT:-11434}'
    environment:
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_ORIGINS=*
      - OLLAMA_MODELS=/root/.ollama/models
      # GPU 오버라이드는 dev compose나 환경변수로 처리
    volumes:
      - ollama-data:/root/.ollama
    networks:
      infra_net:
        ipv4_address: 172.19.0.42
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:11434/api/tags']
      interval: 10s
      timeout: 5s
      retries: 5


    labels:
      - 'traefik.enable=true'
      # Ollama API 라우터 (https://ollama.${DEFAULT_URL})
      - 'traefik.http.routers.ollama.rule=Host(`ollama.${DEFAULT_URL}`)'
      - 'traefik.http.routers.ollama.entrypoints=websecure'
      - 'traefik.http.routers.ollama.tls=true'

      # [중요] 내부 포트 11434 연결
      - 'traefik.http.services.ollama.loadbalancer.server.port=${OLLAMA_PORT:-11434}'
      # [보안] Ollama API에 SSO 인증 추가 권장 (외부 접근 제어)
      - 'traefik.http.routers.ollama.middlewares=sso-auth@file'
    restart: unless-stopped
    logging: *default-logging

  ollama-exporter:
    profiles:
      - ollama
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 128M
    image: lucabecker42/ollama-exporter:1.0.1
    container_name: ollama-exporter
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    environment:
      - OLLAMA_HOST=ollama:${OLLAMA_PORT:-11434}
    expose:
      - '${OLLAMA_EXPORTER_PORT:-11435}'
    restart: unless-stopped
    networks:
      infra_net:
        ipv4_address: 172.19.0.43
    depends_on:
      ollama:
        condition: service_healthy
    logging: *default-logging
networks:
  infra_net:
    name: infra_net
    external: true
