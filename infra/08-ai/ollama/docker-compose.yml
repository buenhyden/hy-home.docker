# Hy-Home System Optimization Headers (Standardized)
x-security-baseline: &security-baseline
  security_opt:
    - no-new-privileges:true
  cap_drop:
    - ALL

x-logging: &default-logging
  driver: 'json-file'
  options:
    max-size: '5m'
    max-file: '2'

x-resource-low: &resource-low
  deploy:
    resources:
      limits: { cpus: '0.2', memory: 128M }
      reservations: { memory: 64M }

x-resource-med: &resource-med
  deploy:
    resources:
      limits: { cpus: '0.5', memory: 512M }
      reservations: { memory: 256M }

x-resource-high: &resource-high
  deploy:
    resources:
      limits: { cpus: '1.0', memory: 1G }
      reservations: { memory: 512M }

x-restart: &default-restart
  restart: unless-stopped

name: ollama

volumes:
  ollama-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_AI_DIR}/ollama/data

services:
  ollama:
    <<: [*default-restart, *resource-high]
    profiles:
      - ollama
    image: ollama/ollama:0.13.5
    container_name: ollama
    security_opt:
      - no-new-privileges:true
    expose:
      - '${OLLAMA_PORT:-11434}'
    environment:
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_ORIGINS=*
      - OLLAMA_MODELS=/root/.ollama/models
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    volumes:
      - ollama-data:/root/.ollama
    networks:
      infra_net:
        ipv4_address: 172.19.0.80
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:11434/api/tags']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.ollama.rule=Host(`ollama.${DEFAULT_URL}`)'
      - 'traefik.http.routers.ollama.entrypoints=websecure'
      - 'traefik.http.routers.ollama.tls=true'
      - 'traefik.http.services.ollama.loadbalancer.server.port=${OLLAMA_PORT:-11434}'
      - 'traefik.http.routers.ollama.middlewares=sso-auth@file'
    logging: *default-logging

  ollama-exporter:
    profiles:
      - ollama
    <<: [*default-restart, *resource-low]
    image: lucabecker42/ollama-exporter:1.0.1
    container_name: ollama-exporter
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    environment:
      - OLLAMA_HOST=http://ollama:11434
    expose:
      - '${OLLAMA_EXPORTER_PORT:-11435}'
    networks:
      infra_net:
        ipv4_address: 172.19.0.83 # Restored to free IP in AI range
    depends_on:
      ollama:
        condition: service_healthy
    logging: *default-logging

networks:
  infra_net:
    name: infra_net
    external: true
