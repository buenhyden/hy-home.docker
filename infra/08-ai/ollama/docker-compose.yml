name: ollama

x-labels-base: &labels-base
  hy-home.managed: 'true'
  hy-home.tier: ai
  observability.logs: 'true'

x-logging: &default-logging
  driver: 'loki'
  options:
    loki-url: 'http://localhost:3100/loki/api/v1/push'
    loki-external-labels: 'container_name={{.Name}},tier=ai'

volumes:
  ollama-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_AI_MODEL_DIR}/ollama

services:
  ollama:
    profiles:
      - ollama
    extends:
      file: ../../../infra/common-optimizations.yml
      service: template-infra-high
    image: ollama/ollama:0.13.5
    container_name: ollama
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          memory: 4G
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    labels:
      <<: *labels-base
      traefik.enable: 'true'
      traefik.http.routers.ollama.rule: Host(`ollama.${DEFAULT_URL}`)
      traefik.http.routers.ollama.entrypoints: websecure
      traefik.http.routers.ollama.tls: 'true'
      traefik.http.services.ollama.loadbalancer.server.port: ${OLLAMA_PORT:-11434}
      traefik.http.routers.ollama.middlewares: sso-auth@file
    logging: *default-logging
    networks:
      - infra_net
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:11434/api/tags || exit 1']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 1m

  ollama-exporter:
    extends:
      file: ../../../infra/common-optimizations.yml
      service: template-infra-low
    image: lucabecker42/ollama-exporter:1.0.1
    container_name: ollama-exporter
    environment:
      - OLLAMA_HOST=ollama:${OLLAMA_PORT:-11434}
    expose:
      - '${OLLAMA_EXPORTER_PORT:-11435}'
    networks:
      - infra_net
    depends_on:
      ollama:
        condition: service_healthy
    labels: *labels-base
    logging: *default-logging

networks:
  infra_net:
    name: infra_net
    external: true
