x-tier-label: &tier-label
  hy-home.tier: messaging

volumes:
  kafka-1-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_MESSAGE_BROKER_DIR}/kafka/kafka1-data
  kafka-2-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_MESSAGE_BROKER_DIR}/kafka/kafka2-data
  kafka-3-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_MESSAGE_BROKER_DIR}/kafka/kafka3-data
  kafka-connect-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_MESSAGE_BROKER_DIR}/kafka/kafka-connect

x-kafka-broker-common: &kafka-broker-common
  image: confluentinc/cp-kafka:8.1.1
  profiles: ['messaging']
  extends:
    file: ../../common-optimizations.yml
    service: base-security
  deploy:
    resources:
      limits:
        cpus: '1.5'
        memory: 1.5G
      reservations:
        memory: 1G
    labels:
      <<: *tier-label
  restart: unless-stopped
  networks:
    - infra_net
  environment: &kafka-broker-env-common
    CLUSTER_ID: ${KAFKA_CLUSTER_ID}
    KAFKA_PROCESS_ROLES: 'broker,controller'
    KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka-1:${KAFKA_CONTROLLER_PORT:-9093},2@kafka-2:${KAFKA_CONTROLLER_PORT:-9093},3@kafka-3:${KAFKA_CONTROLLER_PORT:-9093}'
    KAFKA_LISTENERS: 'PLAINTEXT://0.0.0.0:${KAFKA_INTERNAL_PORT:-19092},CONTROLLER://0.0.0.0:${KAFKA_CONTROLLER_PORT:-9093},EXTERNAL://0.0.0.0:${KAFKA_EXTERNAL_PORT:-9092}'
    KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: 'CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT'
    KAFKA_CONTROLLER_LISTENER_NAMES: 'CONTROLLER'
    KAFKA_INTER_BROKER_LISTENER_NAME: 'PLAINTEXT'
    KAFKA_DEFAULT_REPLICATION_FACTOR: 3
    KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
    KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
    KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
    KAFKA_MIN_INSYNC_REPLICAS: 2
    KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
    KAFKA_LOG_DIRS: '/var/lib/kafka/data'
    KAFKA_NUM_PARTITIONS: 3
    KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
    KAFKA_GROUP_MAX_SESSION_TIMEOUT_MS: 45000
    KAFKA_REQUEST_TIMEOUT_MS: 10000
    KAFKA_CONTROLLER_QUORUM_FETCH_TIMEOUT_MS: 10000
    KAFKA_CONTROLLER_QUORUM_REQUEST_TIMEOUT_MS: 10000
    KAFKA_HEAP_OPTS: '-Xms1G -Xmx1G'
    KAFKA_JMX_OPTS: '-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.rmi.server.hostname=${KAFKA_JMX_HOSTNAME:-localhost} -Dcom.sun.management.jmxremote.rmi.port=${KAFKA_JMX_PORT:-9101} -javaagent:/usr/share/jmx_exporter/jmx_prometheus_javaagent-1.5.0.jar=9404:/usr/share/jmx_exporter/kafka-config.yaml'
  healthcheck:
    test:
      [
        'CMD-SHELL',
        'unset KAFKA_JMX_OPTS; kafka-broker-api-versions --bootstrap-server localhost:${KAFKA_INTERNAL_PORT:-19092} >/dev/null 2>&1 || exit 1',
      ]
    interval: 15s
    timeout: 30s
    retries: 5
    start_period: 30s

services:
  kafka-1:
    <<: *kafka-broker-common
    container_name: kafka-1
    hostname: kafka-1
    volumes:
      - kafka-1-data:/var/lib/kafka/data
      - ./jmx-exporter:/usr/share/jmx_exporter
    ports:
      - '${KAFKA_EXTERNAL_1_HOST_PORT:-9092}:${KAFKA_EXTERNAL_PORT:-9092}'
      - '${KAFKA_JMX_1_HOST_PORT:-19101}:${KAFKA_JMX_PORT:-9101}'
      - '${KAFKA_JMX_EXPORTER_1_HOST_PORT:-19404}:${KAFKA_JMX_EXPORTER_PORT:-9404}'
    environment:
      <<: *kafka-broker-env-common
      KAFKA_NODE_ID: 1
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://kafka-1:${KAFKA_INTERNAL_PORT:-19092},EXTERNAL://localhost:${KAFKA_EXTERNAL_1_HOST_PORT:-9092}'
      KAFKA_JMX_PORT: ${KAFKA_JMX_PORT:-9101}
      KAFKA_JMX_HOSTNAME: kafka-1

  kafka-2:
    <<: *kafka-broker-common
    container_name: kafka-2
    hostname: kafka-2
    volumes:
      - kafka-2-data:/var/lib/kafka/data
      - ./jmx-exporter:/usr/share/jmx_exporter
    ports:
      - '${KAFKA_EXTERNAL_2_HOST_PORT:-9094}:${KAFKA_EXTERNAL_PORT:-9092}'
      - '${KAFKA_JMX_2_HOST_PORT:-29101}:${KAFKA_JMX_PORT:-9101}'
      - '${KAFKA_JMX_EXPORTER_2_HOST_PORT:-29404}:${KAFKA_JMX_EXPORTER_PORT:-9404}'
    environment:
      <<: *kafka-broker-env-common
      KAFKA_NODE_ID: 2
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://kafka-2:${KAFKA_INTERNAL_PORT:-19092},EXTERNAL://localhost:${KAFKA_EXTERNAL_2_HOST_PORT:-9094}'
      KAFKA_JMX_PORT: ${KAFKA_JMX_PORT:-9101}
      KAFKA_JMX_HOSTNAME: kafka-2

  kafka-3:
    <<: *kafka-broker-common
    container_name: kafka-3
    hostname: kafka-3
    volumes:
      - kafka-3-data:/var/lib/kafka/data
      - ./jmx-exporter:/usr/share/jmx_exporter
    ports:
      - '${KAFKA_EXTERNAL_3_HOST_PORT:-9096}:${KAFKA_EXTERNAL_PORT:-9092}'
      - '${KAFKA_JMX_3_HOST_PORT:-39101}:${KAFKA_JMX_PORT:-9101}'
      - '${KAFKA_JMX_EXPORTER_3_HOST_PORT:-39404}:${KAFKA_JMX_EXPORTER_PORT:-9404}'
    environment:
      <<: *kafka-broker-env-common
      KAFKA_NODE_ID: 3
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://kafka-3:${KAFKA_INTERNAL_PORT:-19092},EXTERNAL://localhost:${KAFKA_EXTERNAL_3_HOST_PORT:-9096}'
      KAFKA_JMX_PORT: ${KAFKA_JMX_PORT:-9101}
      KAFKA_JMX_HOSTNAME: kafka-3

  schema-registry:
    profiles: ['messaging']
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-med
    image: confluentinc/cp-schema-registry:8.1.1
    container_name: schema-registry
    networks:
      - infra_net
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_LISTENERS: 'http://0.0.0.0:${SCHEMA_REGISTRY_PORT:-8081}'
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: 'PLAINTEXT://kafka-1:19092,PLAINTEXT://kafka-2:19092,PLAINTEXT://kafka-3:19092'
    read_only: true
    tmpfs:
      - /tmp
    expose:
      - ${SCHEMA_REGISTRY_PORT:-8081}
    labels:
      <<: *tier-label
      traefik.enable: 'true'
      traefik.http.routers.schema-registry.rule: Host(`schema-registry.${DEFAULT_URL}`)
      traefik.http.routers.schema-registry.entrypoints: websecure
      traefik.http.routers.schema-registry.tls: 'true'
      traefik.http.services.schema-registry.loadbalancer.server.port: ${SCHEMA_REGISTRY_PORT:-8081}
    depends_on:
      kafka-1: { condition: service_healthy }
      kafka-2: { condition: service_healthy }
      kafka-3: { condition: service_healthy }
    healthcheck:
      test:
        ['CMD-SHELL', 'curl -fsS http://localhost:${SCHEMA_REGISTRY_PORT:-8081}/subjects || exit 1']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s

  kafka-connect:
    profiles: ['messaging']
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-high
    image: confluentinc/cp-kafka-connect:8.1.1
    container_name: kafka-connect
    read_only: true
    tmpfs:
      - /tmp
      - /etc/kafka
    depends_on:
      kafka-1: { condition: service_healthy }
      kafka-2: { condition: service_healthy }
      kafka-3: { condition: service_healthy }
      schema-registry: { condition: service_started }
    networks:
      - infra_net
    environment:
      CONNECT_BOOTSTRAP_SERVERS: 'kafka-1:19092,kafka-2:19092,kafka-3:19092'
      CONNECT_GROUP_ID: 'kafka-connect-cluster'
      CONNECT_CONFIG_STORAGE_TOPIC: _connect-configs
      CONNECT_OFFSET_STORAGE_TOPIC: _connect-offsets
      CONNECT_STATUS_STORAGE_TOPIC: _connect-status
      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_KEY_CONVERTER: 'org.apache.kafka.connect.json.JsonConverter'
      CONNECT_VALUE_CONVERTER: 'org.apache.kafka.connect.json.JsonConverter'
      CONNECT_KEY_CONVERTER_SCHEMAS_ENABLE: 'false'
      CONNECT_VALUE_CONVERTER_SCHEMAS_ENABLE: 'false'
      CONNECT_INTERNAL_KEY_CONVERTER: 'org.apache.kafka.connect.json.JsonConverter'
      CONNECT_INTERNAL_VALUE_CONVERTER: 'org.apache.kafka.connect.json.JsonConverter'
      CONNECT_REST_ADVERTISED_HOST_NAME: kafka-connect
      CONNECT_REST_PORT: ${KAFKA_CONNECT_PORT:-8083}
      CONNECT_PLUGIN_PATH: '/usr/share/java,/usr/share/confluent-hub-components'
      CONNECT_OFFSET_FLUSH_INTERVAL_MS: 10000
      CONNECT_LOG4J_ROOT_LOGLEVEL: 'INFO'
      CONNECT_LOG4J_LOGGERS: 'org.apache.kafka.connect.runtime.rest=WARN,org.reflections=ERROR'
      CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_URL: 'http://schema-registry:${SCHEMA_REGISTRY_PORT:-8081}'
      CONNECT_KEY_CONVERTER_SCHEMA_REGISTRY_URL: 'http://schema-registry:${SCHEMA_REGISTRY_PORT:-8081}'
    volumes:
      - kafka-connect-data:/var/lib/kafka-connect
    labels:
      <<: *tier-label
      traefik.enable: 'true'
      traefik.http.routers.kafka-connect.rule: Host(`kafka-connect.${DEFAULT_URL}`)
      traefik.http.routers.kafka-connect.entrypoints: websecure
      traefik.http.routers.kafka-connect.tls: 'true'
      traefik.http.services.kafka-connect.loadbalancer.server.port: ${KAFKA_CONNECT_PORT:-8083}
    healthcheck:
      test:
        ['CMD-SHELL', 'curl -fsS http://localhost:${KAFKA_CONNECT_PORT:-8083}/connectors || exit 1']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s

  kafka-rest-proxy:
    profiles: ['messaging']
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-med
    image: confluentinc/cp-kafka-rest:8.1.1
    container_name: kafka-rest-proxy
    networks:
      - infra_net
    labels:
      <<: *tier-label
      traefik.enable: 'true'
      traefik.http.routers.kafka-rest.rule: Host(`kafka-rest.${DEFAULT_URL}`)
      traefik.http.routers.kafka-rest.entrypoints: websecure
      traefik.http.routers.kafka-rest.tls: 'true'
      traefik.http.services.kafka-rest.loadbalancer.server.port: ${KAFKA_REST_PROXY_PORT:-8082}
    environment:
      KAFKA_REST_HOST_NAME: kafka-rest-proxy
      KAFKA_REST_LISTENERS: 'http://0.0.0.0:${KAFKA_REST_PROXY_PORT:-8082}'
      KAFKA_REST_BOOTSTRAP_SERVERS: 'PLAINTEXT://kafka-1:19092,PLAINTEXT://kafka-2:19092,PLAINTEXT://kafka-3:19092'
      KAFKA_REST_SCHEMA_REGISTRY_URL: 'http://schema-registry:${SCHEMA_REGISTRY_PORT:-8081}'
    depends_on:
      kafka-1: { condition: service_healthy }
      kafka-2: { condition: service_healthy }
      kafka-3: { condition: service_healthy }
      schema-registry: { condition: service_started }
    healthcheck:
      test:
        ['CMD-SHELL', 'curl -fsS http://localhost:${KAFKA_REST_PROXY_PORT:-8082}/topics || exit 1']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s

  kafbat-ui:
    profiles: ['messaging']
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-med
    image: ghcr.io/kafbat/kafka-ui:main
    container_name: kafbat-ui
    read_only: true
    tmpfs:
      - /tmp
    environment:
      KAFKA_CLUSTERS_0_NAME: ${KAFKA_CLUSTER_ID}
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: 'kafka-1:19092,kafka-2:19092,kafka-3:19092'
      KAFKA_CLUSTERS_0_SCHEMAREGISTRY: http://schema-registry:${SCHEMA_REGISTRY_PORT:-8081}
      KAFKA_CLUSTERS_0_KAFKACONNECT_0_NAME: kafka-connect
      KAFKA_CLUSTERS_0_KAFKACONNECT_0_ADDRESS: http://kafka-connect:${KAFKA_CONNECT_PORT:-8083}
      KAFKA_CLUSTERS_0_METRICS_PORT: ${KAFKA_JMX_PORT:-9101}
      KAFKA_CLUSTERS_0_METRICS_TYPE: PROMETHEUS
      KAFKA_CLUSTERS_0_METRICS_STORE_PROMETHEUS_URL: 'http://prometheus:9090'
      KAFKA_CLUSTERS_0_METRICS_STORE_PROMETHEUS_REMOTEWRITE: 'true'
      KAFKA_CLUSTERS_0_METRICS_STORE_KAFKA_TOPIC: 'kafka_metrics'
      DYNAMIC_CONFIG_ENABLED: 'true'
    volumes:
      - ./kafbat-ui/dynamic_config.yaml:/etc/kafkaui/dynamic_config.yaml
    labels:
      <<: *tier-label
      traefik.enable: 'true'
      traefik.http.routers.kafka-ui.rule: Host(`kafbat-ui.${DEFAULT_URL}`)
      traefik.http.routers.kafka-ui.entrypoints: websecure
      traefik.http.routers.kafka-ui.tls: 'true'
      traefik.http.services.kafka-ui.loadbalancer.server.port: ${KAFKA_UI_PORT:-8080}
      traefik.http.routers.kafka-ui.middlewares: sso-auth@file
    depends_on:
      kafka-1: { condition: service_healthy }
      kafka-2: { condition: service_healthy }
      kafka-3: { condition: service_healthy }
      schema-registry: { condition: service_started }
      kafka-connect: { condition: service_started }
    healthcheck:
      test:
        - 'CMD-SHELL'
        - 'wget --no-verbose --tries=1 --spider http://localhost:${KAFKA_UI_PORT:-8080}/actuator/health'
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s

  kafka-exporter:
    profiles: ['messaging']
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-low
    image: danielqsj/kafka-exporter:v1.9.0
    container_name: kafka-exporter
    read_only: true
    command:
      - --kafka.server=kafka-1:19092
      - --kafka.server=kafka-2:19092
      - --kafka.server=kafka-3:19092
    networks:
      - infra_net
    depends_on:
      kafka-1: { condition: service_healthy }
      kafka-2: { condition: service_healthy }
      kafka-3: { condition: service_healthy }
    healthcheck:
      test:
        ['CMD-SHELL', 'curl -fsS http://localhost:${KAFKA_EXPORTER_PORT:-9308}/metrics || exit 1']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s

  kafka-init:
    profiles: ['messaging']
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-low
    image: confluentinc/cp-kafka:8.1.1
    container_name: kafka-init
    networks:
      - infra_net
    depends_on:
      kafka-1: { condition: service_healthy }
    entrypoint: ['/bin/sh', '-c']
    command:
      - |
        echo "Creating internal topics..."
        kafka-topics --bootstrap-server kafka-1:19092 --create --if-not-exists --topic infra-events --partitions 3 --replication-factor 3
        kafka-topics --bootstrap-server kafka-1:19092 --create --if-not-exists --topic application-logs --partitions 6 --replication-factor 3
        echo "Kafka initialization complete."
    labels:
      <<: *tier-label
      hy-home.scope: infra
    deploy:
      resources:
        limits: { memory: 256M }
