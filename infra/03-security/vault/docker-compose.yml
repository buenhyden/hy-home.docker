name: vault

volumes:
  vault-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_SECURITY_DIR}/vault

services:
  vault:
    profiles:
      - vault
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-med
    image: hashicorp/vault:1.21.2
    container_name: vault

    restart: unless-stopped
    ports:
      - '${VAULT_HOST_PORT:-8200}:${VAULT_PORT:-8200}'
    expose:
      - ${VAULT_PORT:-8200}
    environment:
      VAULT_ADDR: 'http://0.0.0.0:${VAULT_PORT:-8200}'
      VAULT_API_ADDR: 'http://0.0.0.0:${VAULT_PORT:-8200}'
      KEYCLOAK_URL: '${KEYCLOAK_URL}'
      REALM_NAME: '${KEYCLOAK_REALM}'
      CLIENT_ID: '${OAUTH2_PROXY_CLIENT_ID}'
      # CLIENT_SECRET은 Docker Secret으로 주입 (/run/secrets/oauth2_proxy_client_secret)
    secrets:
      - oauth2_proxy_client_secret
    volumes:
      - vault-data:/vault/file
      - ./config:/vault/config
    command: vault server -config=/vault/config/vault.hcl
    cap_add:
      - IPC_LOCK
    networks:
      - infra_net
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'curl -fsS "http://localhost:${VAULT_PORT:-8200}/v1/sys/health?standbyok=true&sealedcode=200&uninitcode=200" || wget -q --spider "http://localhost:${VAULT_PORT:-8200}/v1/sys/health?standbyok=true&sealedcode=200&uninitcode=200" || exit 1',
        ]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    labels:
      traefik.enable: 'true'
      traefik.http.routers.vault.rule: Host(`vault.${DEFAULT_URL}`)
      traefik.http.routers.vault.entrypoints: websecure
      traefik.http.routers.vault.tls: 'true'
      traefik.http.services.vault.loadbalancer.server.port: ${VAULT_PORT:-8200}

secrets:
  oauth2_proxy_client_secret:
    external: true
