name: n8n

x-logging: &default-logging
  driver: 'json-file'
  options:
    max-size: '5m'
    max-file: '2'

x-n8n-common-env: &n8n-common-env
  GENERIC_TIMEZONE: ${DEFAULT_TIMEZONE:-Asia/Seoul}
  TZ: ${DEFAULT_TIMEZONE:-Asia/Seoul}
  # DB 설정
  DB_TYPE: postgresdb
  DB_POSTGRESDB_HOST: ${POSTGRES_MNG_HOSTNAME}
  DB_POSTGRESDB_PORT: ${POSTGRES_PORT:-5432}
  DB_POSTGRESDB_DATABASE: n8n
  DB_POSTGRESDB_USER: ${N8N_DB_USER}
  DB_POSTGRESDB_PASSWORD_FILE: /run/secrets/n8n_db_password
  # 실행 모드 & Redis(Valkey)
  EXECUTIONS_MODE: queue
  QUEUE_BULL_REDIS_HOST: n8n-valkey
  QUEUE_BULL_REDIS_PORT: ${VALKEY_PORT:-6379}
  QUEUE_BULL_PREFIX: n8n
  QUEUE_BULL_REDIS_PASSWORD_FILE: /run/secrets/n8n_valkey_password
  # Task Runner 설정
  N8N_RUNNERS_ENABLED: true
  N8N_RUNNERS_MODE: external
  N8N_RUNNERS_BROKER_LISTEN_ADDRESS: 0.0.0.0
  N8N_NATIVE_PYTHON_RUNNER: true
  N8N_RUNNERS_AUTH_TOKEN_FILE: /run/secrets/n8n_runner_auth_token
  N8N_RUNNER_TASK_TIMEOUT: 300
  # 보안
  N8N_ENCRYPTION_KEY_FILE: /run/secrets/n8n_encryption_key
  N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: true

volumes:
  n8n-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_WORKFLOW_DIR}/n8n
  n8n-valkey-data:
    # driver: local
    # driver_opts:
    #   o: bind
    #   type: none
    #   device: ${DEFAULT_WORKFLOW_DIR}/valkey

secrets:
  n8n_valkey_password:
    external: true
  n8n_db_password:
    external: true
  n8n_encryption_key:
    external: true
  n8n_runner_auth_token:
    external: true

services:
  n8n:
    image: n8nio/n8n:2.6.2
    container_name: n8n
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          memory: 1G
    expose:
      - ${N8N_PORT:-5678}
    secrets:
      - n8n_valkey_password
      - n8n_db_password
      - n8n_encryption_key
      - n8n_runner_auth_token
    environment:
      <<: *n8n-common-env # 공통 환경변수 불러오기
      # Main 노드 전용 설정
      N8N_PROXY_HOPS: 1
      N8N_PROTOCOL: https
      N8N_HOST: n8n.${DEFAULT_URL}
      N8N_PORT: ${N8N_PORT:-5678}
      WEBHOOK_URL: https://n8n.${DEFAULT_URL}
      N8N_PUSH_BACKEND: websocket
      N8N_PUBLIC_API_DISABLED: false
      N8N_API_KEY_GENERATED_ENABLED: true
      N8N_EDITOR_BASE_URL: https://n8n.${DEFAULT_URL}
      N8N_PUBLIC_API_BASE_URL: https://n8n.${DEFAULT_URL}
      # 모니터링
      N8N_METRICS: true
      N8N_METRICS_PREFIX: n8n_
      N8N_METRICS_INCLUDE_WORKFLOW_ID_LABEL: true
      N8N_METRICS_INCLUDE_NODE_TYPE_LABEL: true
      N8N_METRICS_INCLUDE_QUEUE_METRICS: true
      QUEUE_HEALTH_CHECK_ACTIVE: true
    labels:
      - 'traefik.enable=true'
      - 'hy-home.scope=infra'
      - 'hy-home.tier=workflow'
      - 'observability.logs=true'
      # n8n UI & Webhook 라우터 (https://n8n.${DEFAULT_URL})
      - 'traefik.http.routers.n8n.rule=Host(`n8n.${DEFAULT_URL}`)'
      - 'traefik.http.routers.n8n.entrypoints=websecure'
      - 'traefik.http.routers.n8n.tls=true'
      - 'traefik.http.routers.n8n.service=n8n'
      # [중요] n8n 내부 포트 (5678) 연결
      - 'traefik.http.services.n8n.loadbalancer.server.port=${N8N_PORT:-5678}'
    volumes:
      - n8n-data:/home/node/.n8n
      - ./custom:/home/node/.n8n/custom
    depends_on:
      n8n-valkey:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', 'nc -z localhost ${N8N_PORT:-5678} || exit 1'] # 간단한 포트 체크 방식
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    networks:
      infra_net:
        ipv4_address: 172.19.0.14
    logging: *default-logging
  n8n-worker:
    image: n8nio/n8n:2.6.2
    container_name: n8n-worker
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
    depends_on:
      n8n:
        condition: service_healthy
      n8n-valkey:
        condition: service_healthy
    environment:
      <<: *n8n-common-env
    secrets:
      - n8n_valkey_password
      - n8n_db_password
      - n8n_encryption_key
      - n8n_runner_auth_token
    networks:
      infra_net:
        ipv4_address: 172.19.0.17
    command: worker
    logging: *default-logging
    volumes:
      - n8n-data:/home/node/.n8n
      - ./custom:/home/node/.n8n/custom

  n8n-task-runner:
    image: n8nio/runners:2.6.2
    container_name: n8n-task-runner
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    secrets:
      - n8n_runner_auth_token
    environment:
      - N8N_RUNNERS_TASK_BROKER_URI=http://n8n:${N8N_BROKER_PORT:-5679}
      - N8N_RUNNERS_AUTH_TOKEN_FILE=/run/secrets/n8n_runner_auth_token
    networks:
      infra_net:
        ipv4_address: 172.19.0.74
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
    logging: *default-logging
  n8n-valkey:
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
    image: valkey/valkey:9.0.2-alpine
    container_name: n8n-valkey
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    secrets:
      - n8n_valkey_password
    networks:
      infra_net:
        ipv4_address: 172.19.0.15
    restart: unless-stopped
    volumes:
      - n8n-valkey-data:/data
    command: >
      sh -c '
      valkey-server
      --requirepass "$$(cat /run/secrets/n8n_valkey_password)"
      --appendonly yes
      --port 6379
      '
    # 클러스터 내부 통신 포트는 expose
    expose:
      - '${VALKEY_PORT:-6379}'
      - '${VALKEY_BUS_PORT:-16379}'
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'V_PASS=$$(cat /run/secrets/n8n_valkey_password); valkey-cli -a $$V_PASS -h 127.0.0.1 -p 6379 ping | grep PONG',
        ]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    logging: *default-logging

  n8n-valkey-exporter:
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 128M
    image: oliver006/redis_exporter:v1.80.1-alpine
    container_name: n8n-valkey-exporter
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    expose:
      - '${VALKEY_EXPORTER_PORT:-9121}'
    networks:
      infra_net:
        ipv4_address: 172.19.0.16
    restart: unless-stopped
    secrets:
      - n8n_valkey_password
    entrypoint:
      - /bin/sh
      - -c
    command:
      - |
        echo "Starting Valkey Exporter..."
        # -redis.password-file 플래그로 직접 파일 경로 전달 (환경변수 export 없음)
        exec /redis_exporter \
          -redis.addr=redis://n8n-valkey:6379 \
          -redis.password-file=/run/secrets/n8n_valkey_password \
          -web.listen-address=:${VALKEY_EXPORTER_PORT:-9121}
    depends_on:
      n8n-valkey:
        condition: service_healthy
    logging: *default-logging
networks:
  infra_net:
    name: infra_net
    external: true
