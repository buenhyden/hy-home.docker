x-common:
  security: &security { security_opt: [no-new-privileges:true], cap_drop: [ALL] }
  logging: &logging { driver: 'json-file', options: { max-size: '5m', max-file: '2' } }
  res-low: &res-low { deploy: { resources: { limits: { cpus: '0.2', memory: 128M }, reservations: { memory: 64M } } } }
  res-med: &res-med { deploy: { resources: { limits: { cpus: '0.5', memory: 512M }, reservations: { memory: 256M } } } }
  res-high: &res-high { deploy: { resources: { limits: { cpus: '1.0', memory: 1G }, reservations: { memory: 512M } } } }
  restart: &restart { restart: unless-stopped }
  labels-base: &labels-base { traefik.enable: 'true', hy-home.managed: 'true' }

name: sonarqube
x-logging: &default-logging
volumes:
  sonarqube-data-volume:
    # driver: local
    # driver_opts:
    #   o: bind
    #   type: none
    #   device: ${DEFAULT_TOOLING_DIR}/sonarqube/data
  sonarqube-logs-volume:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_TOOLING_DIR}/sonarqube/logs

services:
  sonarqube:
    profiles:
      - sonarqube
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
    image: sonarqube:26.1.0.118079-community
    container_name: sonarqube
    hostname: sonarqube
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    expose:
      - ${SONARQUBE_PORT:-9000}
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'wget -q --spider http://localhost:${SONARQUBE_PORT:-9000}/api/system/health || exit 1',
        ]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    volumes:
      - sonarqube-data-volume:/opt/sonarqube/data
      - sonarqube-logs-volume:/opt/sonarqube/logs
    networks:
      - infra_net
    logging: *logging
    secrets:
      - sonarqube_db_password
    environment:
      - SONAR_JDBC_URL=jdbc:postgresql://${POSTGRES_MNG_HOSTNAME}:${POSTGRES_PORT:-5432}/${SONARQUBE_DBNAME}
      - SONAR_JDBC_USERNAME=${SONARQUBE_DB_USER}
      - SONAR_JDBC_PASSWORD_FILE=/run/secrets/sonarqube_db_password
      - SONAR_WEB_JAVAOPTS=-Xmx512m -Xms512m
      - SONAR_SEARCH_JAVAOPTS=-Xmx512m -Xms512m
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.sonarqube.rule=Host(`sonarqube.${DEFAULT_URL}`)'
      - 'traefik.http.routers.sonarqube.entrypoints=websecure'
      - 'traefik.http.routers.sonarqube.tls=true'
      - 'traefik.http.services.sonarqube.loadbalancer.server.port=${SONARQUBE_PORT:-9000}'

networks:
  infra_net:
    name: infra_net
    external: true

secrets:
  sonarqube_db_password:
    external: true
