name: mng-db

x-optimizations:
  security-baseline: &security-baseline
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
  logging-loki: &logging-loki
    driver: loki
    options:
      loki-url: 'http://localhost:3100/loki/api/v1/push'
      loki-external-labels: 'job=infra,container={{.Name}}'
  labels-base: &labels-base
    hy-home.scope: infra
    observability.logs: 'true'
  restart-base: &default-restart
    restart: unless-stopped

volumes:
  mng-pg-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_MANAGEMENT_DIR}/pg
  mng-valkey-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_MANAGEMENT_DIR}/valkey
  redisinsight-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_MANAGEMENT_DIR}/redisinsight

secrets:
  mng_valkey_password:
    external: true
  mng_postgres_password:
    external: true
  n8n_db_password:
    external: true
  keycloak_db_password:
    external: true
  airflow_db_password:
    external: true
  terrakube_db_password:
    external: true
  sonarqube_db_password:
    external: true

networks:
  infra_net:
    name: infra_net
    external: true

services:
  mng-valkey:
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.2'
          memory: 256M
    image: valkey/valkey:9.0.2-alpine
    container_name: mng-valkey
    <<: [*default-restart, *security-baseline]
    labels:
      <<: *labels-base
      hy-home.tier: data
      traefik.enable: 'false'
    secrets:
      - mng_valkey_password
    networks:
      infra_net:
        ipv4_address: 172.19.0.70
    volumes:
      - mng-valkey-data:/data
    command: >
      sh -c '
      valkey-server
      --requirepass "$$(cat /run/secrets/mng_valkey_password)"
      --appendonly yes
      --port 6379
      '
    expose:
      - '${VALKEY_PORT:-6379}'
      - '${VALKEY_BUS_PORT:-16379}'
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'V_PASS=$$(cat /run/secrets/mng_valkey_password); valkey-cli -a $$V_PASS -h 127.0.0.1 -p 6379 ping | grep PONG',
        ]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    logging: *logging-loki

  mng-valkey-exporter:
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 64M
    image: oliver006/redis_exporter:v1.81.0-alpine
    container_name: mng-valkey-exporter
    <<: [*default-restart, *security-baseline]
    labels:
      <<: *labels-base
      hy-home.tier: data
    read_only: true
    expose:
      - '${VALKEY_EXPORTER_PORT:-9121}'
    networks:
      infra_net:
        ipv4_address: 172.19.0.71
    secrets:
      - mng_valkey_password
    entrypoint:
      - /bin/sh
      - -c
    command:
      - |
        echo "Reading password from secret..."
        export VALKEY_PASSWORD=$(cat /run/secrets/mng_valkey_password | tr -d '\n')

        echo "Starting Redis Exporter..."
        exec /redis_exporter \
          -redis.addr=redis://mng-valkey:6379 \
          -redis.password="$$VALKEY_PASSWORD" \
          -web.listen-address=:${VALKEY_EXPORTER_PORT:-9121}
    depends_on:
      mng-valkey:
        condition: service_healthy
    logging: *logging-loki

  redisinsight:
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    image: redis/redisinsight:3.0.3
    container_name: redisinsight
    <<: [*default-restart, *security-baseline]
    networks:
      infra_net:
        ipv4_address: 172.19.0.68
    volumes:
      - redisinsight-data:/db
    labels:
      <<: *labels-base
      traefik.enable: 'true'
      hy-home.tier: data
      traefik.http.routers.redisinsight.rule: Host(`redisinsight.${DEFAULT_URL}`)
      traefik.http.routers.redisinsight.entrypoints: websecure
      traefik.http.routers.redisinsight.tls: 'true'
      traefik.http.routers.redisinsight.middlewares: sso-auth@file
      traefik.http.services.redisinsight.loadbalancer.server.port: ${REDIS_INSIGHT_PORT:-8001}
    logging: *logging-loki

  mng-pg:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    image: postgres:17-bookworm
    container_name: mng-pg
    <<: [*default-restart, *security-baseline]
    networks:
      infra_net:
        ipv4_address: 172.19.0.72
    shm_size: 256mb
    environment:
      POSTGRES_PASSWORD_FILE: /run/secrets/mng_postgres_password
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - '${POSTGRES_HOST_PORT:-25432}:${POSTGRES_PORT:-5432}'
    expose:
      - '${POSTGRES_PORT:-5432}'
    secrets:
      - mng_postgres_password
    volumes:
      - mng-pg-data:/var/lib/postgresql/data
      - ./pg/init-scripts/init_users_dbs.sql:/docker-entrypoint-initdb.d/init_users_dbs.sql
    healthcheck:
      test: ['CMD', 'pg_isready', '-U', 'postgres']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    labels:
      <<: *labels-base
      hy-home.tier: data
    logging: *logging-loki

  mng-pg-init:
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
    image: postgres:17-alpine
    container_name: mng-pg-init
    restart: 'no'
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    networks:
      - infra_net
    environment:
      PGPASSWORD_FILE: /run/secrets/mng_postgres_password
      POSTGRES_HOSTNAME: ${POSTGRES_MNG_HOSTNAME}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_DB: ${POSTGRES_DB}
    command: >
      sh -c "
      echo 'DB 연결 대기 중...';
      until pg_isready -h $$POSTGRES_HOSTNAME -p $$POSTGRES_PORT -U $$POSTGRES_USER; do
        sleep 2;
      done;
      echo 'SQL 스크립트 실행 시작...';
      export PGPASSWORD=$(cat /run/secrets/mng_postgres_password | tr -d '\n');
      export N8N_DB_PASSWORD=$(cat /run/secrets/n8n_db_password | tr -d '\n');
      export KEYCLOAK_DB_PASSWORD=$(cat /run/secrets/keycloak_db_password | tr -d '\n');
      export AIRFLOW_DB_PASSWORD=$(cat /run/secrets/airflow_db_password | tr -d '\n');
      export TERRAKUBE_DB_PASSWORD=$(cat /run/secrets/terrakube_db_password | tr -d '\n');
      export SONARQUBE_DB_PASSWORD=$(cat /run/secrets/sonarqube_db_password | tr -d '\n');
      psql -h \"$$POSTGRES_HOSTNAME\" -p \"$$POSTGRES_PORT\" -U \"$$POSTGRES_USER\" -d \"$${POSTGRES_DB}\" -f /home/postgres/init-scripts/init_users_dbs.sql;
      unset PGPASSWORD;
      unset N8N_DB_PASSWORD;
      unset KEYCLOAK_DB_PASSWORD;
      unset AIRFLOW_DB_PASSWORD;
      unset TERRAKUBE_DB_PASSWORD;
      unset SONARQUBE_DB_PASSWORD;
      echo 'SQL 스크립트 실행 완료.';"
    volumes:
      - ./pg/init-scripts/init_users_dbs.sql:/home/postgres/init-scripts/init_users_dbs.sql
    depends_on:
      mng-pg:
        condition: service_healthy
    secrets:
      - mng_postgres_password
      - n8n_db_password
      - keycloak_db_password
      - airflow_db_password
      - terrakube_db_password
      - sonarqube_db_password
    healthcheck:
      test: ['CMD', 'pg_isready', '-U', 'postgres']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    logging:
      driver: 'loki'
      options:
        loki-url: 'http://localhost:3100/loki/api/v1/push'
        loki-external-labels: 'container_name=mng-pg-init,tier=data'

  mng-pg-exporter:
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 64M
    image: prometheuscommunity/postgres-exporter:v0.18.1
    container_name: mng-pg-exporter
    security_opt:
      - no-new-privileges:true
    read_only: true
    <<: *default-restart
    networks:
      infra_net:
        ipv4_address: 172.19.0.73
    expose:
      - '${POSTGRES_EXPORTER_PORT:-9187}'
    secrets:
      - mng_postgres_password
    depends_on:
      mng-pg:
        condition: service_healthy
    entrypoint: ['/bin/sh', '-c']
    command:
      - |
        export PGPASSWORD=$$(cat /run/secrets/mng_postgres_password | tr -d '\n')
        # pg-0에 직접 접속
        export DATA_SOURCE_NAME="postgresql://postgres:$$PGPASSWORD@mng-pg:5432/postgres?sslmode=disable"
        exec /bin/postgres_exporter
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'wget -qO- http://localhost:${POSTGRES_EXPORTER_PORT:-9187}/metrics > /dev/null 2>&1 || exit 1',
        ]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    logging:
      driver: 'loki'
      options:
        loki-url: 'http://localhost:3100/loki/api/v1/push'
        loki-external-labels: 'container_name=mng-pg-exporter,tier=data'
