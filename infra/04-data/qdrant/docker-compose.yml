name: qdrant

x-labels-base: &labels-base
  hy-home.managed: 'true'
  hy-home.tier: data

volumes:
  qdrant-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_DATA_DIR}/qdrant/data

services:
  qdrant:
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-med
    image: qdrant/qdrant:v1.17
    container_name: qdrant
    ports:
      - '${QDRANT_HOST_PORT:-6333}:${QDRANT_PORT:-6333}'
    environment:
      - QDRANT__TELEMETRY_DISABLED=false # 메트릭 수집 활성화
    volumes:
      - qdrant-data:/qdrant/storage
    networks:
      - infra_net
    healthcheck:
      test:
        [
          'CMD',
          'bash',
          '-c',
          "exec 3<>/dev/tcp/127.0.0.1/6333 && echo -e 'GET /readyz HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && grep -q 'HTTP/1.1 200' <&3",
        ]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    # Qdrant 대시보드(Web UI)를 보고 싶다면 아래 라벨 주석 해제
    labels:
      <<: *labels-base
      traefik.enable: 'true'
      traefik.http.routers.qdrant.rule: Host(`qdrant.${DEFAULT_URL}`)
      traefik.http.routers.qdrant.entrypoints: websecure
      traefik.http.routers.qdrant.tls: 'true'
      traefik.http.services.qdrant.loadbalancer.server.port: ${QDRANT_PORT:-6333}
    logging:
      driver: loki
      options:
        loki-url: 'http://localhost:3100/loki/api/v1/push'
        loki-external-labels: 'container_name={{.Name}}'
