name: postgresql-cluster

x-logging: &default-logging
  driver: 'json-file'
  options:
    max-size: '5m'
    max-file: '2'

x-restart: &default-restart
  restart: unless-stopped

volumes:
  pg0-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_DATA_DIR}/pg/pg0-data
  pg1-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_DATA_DIR}/pg/pg1-data
  pg2-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_DATA_DIR}/pg/pg2-data
  etcd1-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_DATA_DIR}/etcd/etcd1-data
  etcd2-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_DATA_DIR}/etcd/etcd2-data
  etcd3-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_DATA_DIR}/etcd/etcd3-data

secrets:
  service_postgres_password:
    external: true
  patroni_superuser_password:
    external: true
  patroni_replication_password:
    external: true

services:
  # ##############################################################
  # etcd 3노드 (Patroni DCS)
  # ##############################################################
  etcd-1:
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    image: quay.io/coreos/etcd:v3.6.7
    container_name: etcd-1
    user: '1000:1000'
    command:
      - /usr/local/bin/etcd
      - --name=etcd-1
      - --data-dir=/etcd-data
      - --initial-advertise-peer-urls=http://etcd-1:${ETCD_PEER_PORT:-2380}
      - --listen-peer-urls=http://0.0.0.0:${ETCD_PEER_PORT:-2380}
      - --listen-client-urls=http://0.0.0.0:${ETCD_CLIENT_PORT:-2379}
      - --advertise-client-urls=http://etcd-1:${ETCD_CLIENT_PORT:-2379}
      - --initial-cluster=etcd-1=http://etcd-1:${ETCD_PEER_PORT:-2380},etcd-2=http://etcd-2:${ETCD_PEER_PORT:-2380},etcd-3=http://etcd-3:${ETCD_PEER_PORT:-2380}
      - --initial-cluster-state=new
      - --initial-cluster-token=pg-ha-etcd
    healthcheck:
      test: ['CMD', 'etcdctl', 'endpoint', 'health', '--endpoints=http://localhost:2379']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    volumes:
      - etcd1-data:/etcd-data
    expose:
      - ${ETCD_CLIENT_PORT:-2379}
    networks:
      infra_net:
        ipv4_address: 172.19.0.50
    logging: *default-logging
    <<: *default-restart

  etcd-2:
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    image: quay.io/coreos/etcd:v3.6.7
    container_name: etcd-2
    user: '1000:1000'
    command:
      - /usr/local/bin/etcd
      - --name=etcd-2
      - --data-dir=/etcd-data
      - --initial-advertise-peer-urls=http://etcd-2:${ETCD_PEER_PORT:-2380}
      - --listen-peer-urls=http://0.0.0.0:${ETCD_PEER_PORT:-2380}
      - --listen-client-urls=http://0.0.0.0:${ETCD_CLIENT_PORT:-2379}
      - --advertise-client-urls=http://etcd-2:${ETCD_CLIENT_PORT:-2379}
      - --initial-cluster=etcd-1=http://etcd-1:${ETCD_PEER_PORT:-2380},etcd-2=http://etcd-2:${ETCD_PEER_PORT:-2380},etcd-3=http://etcd-3:${ETCD_PEER_PORT:-2380}
      - --initial-cluster-state=new
      - --initial-cluster-token=pg-ha-etcd
    healthcheck:
      test: ['CMD', 'etcdctl', 'endpoint', 'health', '--endpoints=http://localhost:2379']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    volumes:
      - etcd2-data:/etcd-data
    expose:
      - ${ETCD_CLIENT_PORT:-2379}
    networks:
      infra_net:
        ipv4_address: 172.19.0.51
    logging: *default-logging
    <<: *default-restart

  etcd-3:
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    image: quay.io/coreos/etcd:v3.6.7
    container_name: etcd-3
    user: '1000:1000'
    command:
      - /usr/local/bin/etcd
      - --name=etcd-3
      - --data-dir=/etcd-data
      - --initial-advertise-peer-urls=http://etcd-3:${ETCD_PEER_PORT:-2380}
      - --listen-peer-urls=http://0.0.0.0:${ETCD_PEER_PORT:-2380}
      - --listen-client-urls=http://0.0.0.0:${ETCD_CLIENT_PORT:-2379}
      - --advertise-client-urls=http://etcd-3:${ETCD_CLIENT_PORT:-2379}
      - --initial-cluster=etcd-1=http://etcd-1:${ETCD_PEER_PORT:-2380},etcd-2=http://etcd-2:${ETCD_PEER_PORT:-2380},etcd-3=http://etcd-3:${ETCD_PEER_PORT:-2380}
      - --initial-cluster-state=new
      - --initial-cluster-token=pg-ha-etcd
    healthcheck:
      test: ['CMD', 'etcdctl', 'endpoint', 'health', '--endpoints=http://localhost:2379']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    volumes:
      - etcd3-data:/etcd-data
    expose:
      - ${ETCD_CLIENT_PORT:-2379}
    networks:
      infra_net:
        ipv4_address: 172.19.0.52
    logging: *default-logging
    <<: *default-restart

  # ##############################################################
  # Patroni + PostgreSQL 17 노드 3개
  # ##############################################################
  pg-0:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          memory: 1G
    image: ghcr.io/zalando/spilo-17:4.0-p3
    container_name: pg-0
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    hostname: pg-0
    entrypoint: ['/bin/sh', '/usr/local/bin/spilo-entrypoint-with-secrets.sh']
    environment:
      SCOPE: 'pg-ha'
      # etcd 클러스터 주소
      ETCD3_HOSTS: 'etcd-1:2379,etcd-2:2379,etcd-3:2379'
      PATRONI_SUPERUSER_USERNAME: ${PATRONI_SUPERUSER_USERNAME:-postgres}
      PATRONI_REPLICATION_USERNAME: ${PATRONI_REPLICATION_USERNAME:-replicator}
      # --------------------------------------------------------------------
      # 2. Patroni 네이티브 오버라이드 (세부 설정 제어)
      # --------------------------------------------------------------------
      PATRONI_NAME: pg-0
      PATRONI_NAMESPACE: /service/
      # 네트워크 바인딩 (이 설정은 유지)
      # REST API
      PATRONI_RESTAPI_LISTEN: 0.0.0.0:${PATRONI_RESTAPI_PORT:-8008}
      PATRONI_RESTAPI_CONNECT_ADDRESS: pg-0:${PATRONI_RESTAPI_PORT:-8008}
      # PostgreSQL listen / connect
      PATRONI_POSTGRESQL_LISTEN: 0.0.0.0:${POSTGRES_PORT:-5432}
      PATRONI_POSTGRESQL_CONNECT_ADDRESS: pg-0:${POSTGRES_PORT:-5432}
    volumes:
      - pg0-data:/home/postgres/pgdata
      - ./scripts/spilo-entrypoint-with-secrets.sh:/usr/local/bin/spilo-entrypoint-with-secrets.sh:ro
    expose:
      - ${POSTGRES_PORT:-5432}
    secrets:
      - patroni_superuser_password
      - patroni_replication_password
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    networks:
      infra_net:
        ipv4_address: 172.19.0.53
    logging: *default-logging
    depends_on:
      etcd-1:
        condition: service_healthy
      etcd-2:
        condition: service_healthy
      etcd-3:
        condition: service_healthy
    <<: *default-restart

  pg-1:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          memory: 1G
    image: ghcr.io/zalando/spilo-17:4.0-p3
    container_name: pg-1
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    hostname: pg-1
    entrypoint: ['/bin/sh', '/usr/local/bin/spilo-entrypoint-with-secrets.sh']
    environment:
      SCOPE: 'pg-ha'
      # etcd 클러스터 주소
      ETCD3_HOSTS: 'etcd-1:2379,etcd-2:2379,etcd-3:2379'
      PATRONI_SUPERUSER_USERNAME: ${PATRONI_SUPERUSER_USERNAME:-postgres}
      PATRONI_REPLICATION_USERNAME: ${PATRONI_REPLICATION_USERNAME:-replicator}
      # --------------------------------------------------------------------
      # 2. Patroni 네이티브 오버라이드 (세부 설정 제어)
      # --------------------------------------------------------------------
      PATRONI_NAME: pg-1
      PATRONI_NAMESPACE: /service/
      # 네트워크 바인딩 (이 설정은 유지)
      # REST API
      PATRONI_RESTAPI_LISTEN: 0.0.0.0:${PATRONI_RESTAPI_PORT:-8008}
      PATRONI_RESTAPI_CONNECT_ADDRESS: pg-1:${PATRONI_RESTAPI_PORT:-8008}
      # PostgreSQL listen / connect
      PATRONI_POSTGRESQL_LISTEN: 0.0.0.0:${POSTGRES_PORT:-5432}
      PATRONI_POSTGRESQL_CONNECT_ADDRESS: pg-1:${POSTGRES_PORT:-5432}
    volumes:
      - pg1-data:/home/postgres/pgdata
      - ./scripts/spilo-entrypoint-with-secrets.sh:/usr/local/bin/spilo-entrypoint-with-secrets.sh:ro
    networks:
      infra_net:
        ipv4_address: 172.19.0.54
    logging: *default-logging
    secrets:
      - patroni_superuser_password
      - patroni_replication_password
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    expose:
      - ${POSTGRES_PORT:-5432}
    depends_on:
      etcd-1:
        condition: service_healthy
      etcd-2:
        condition: service_healthy
      etcd-3:
        condition: service_healthy
    <<: *default-restart

  pg-2:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          memory: 1G
    image: ghcr.io/zalando/spilo-17:4.0-p3
    container_name: pg-2
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    hostname: pg-2
    entrypoint: ['/bin/sh', '/usr/local/bin/spilo-entrypoint-with-secrets.sh']
    environment:
      SCOPE: 'pg-ha'
      # etcd 클러스터 주소
      ETCD3_HOSTS: 'etcd-1:2379,etcd-2:2379,etcd-3:2379'
      PATRONI_SUPERUSER_USERNAME: ${PATRONI_SUPERUSER_USERNAME:-postgres}
      PATRONI_REPLICATION_USERNAME: ${PATRONI_REPLICATION_USERNAME:-replicator}
      # 계정 비밀번호 (Spilo가 initdb 시 사용)
      # --------------------------------------------------------------------
      # 2. Patroni 네이티브 오버라이드 (세부 설정 제어)
      # --------------------------------------------------------------------
      PATRONI_NAME: pg-2
      PATRONI_NAMESPACE: /service/
      # 네트워크 바인딩 (이 설정은 유지)
      # REST API
      PATRONI_RESTAPI_LISTEN: 0.0.0.0:${PATRONI_RESTAPI_PORT:-8008}
      PATRONI_RESTAPI_CONNECT_ADDRESS: pg-2:${PATRONI_RESTAPI_PORT:-8008}
      # PostgreSQL listen / connect
      PATRONI_POSTGRESQL_LISTEN: 0.0.0.0:${POSTGRES_PORT:-5432}
      PATRONI_POSTGRESQL_CONNECT_ADDRESS: pg-2:${POSTGRES_PORT:-5432}
    volumes:
      - pg2-data:/home/postgres/pgdata
      - ./scripts/spilo-entrypoint-with-secrets.sh:/usr/local/bin/spilo-entrypoint-with-secrets.sh:ro
    networks:
      infra_net:
        ipv4_address: 172.19.0.55
    logging: *default-logging
    expose:
      - ${POSTGRES_PORT:-5432}
    secrets:
      - patroni_superuser_password
      - patroni_replication_password
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    depends_on:
      etcd-1:
        condition: service_healthy
      etcd-2:
        condition: service_healthy
      etcd-3:
        condition: service_healthy
    <<: *default-restart

  # ##############################################################
  # HAProxy 라우터 (Writer/Reader 분리)
  # ##############################################################
  pg-router:
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    image: haproxy:3.3.1
    container_name: pg-router
    volumes:
      - ./config/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    ports:
      - '${POSTGRES_WRITE_HOST_PORT:-15432}:${POSTGRES_WRITE_PORT:-15432}' # Write endpoint
      - '${POSTGRES_READ_HOST_PORT:-15433}:${POSTGRES_READ_PORT:-15433}' # Read endpoint
      # - "${HAPROXY_HOST_PORT}:${HAPROXY_PORT}" # Stats (옵션)
      - '${HAPROXY_METRICS_HOST_PORT:-8404}:${HAPROXY_METRICS_PORT:-8404}' # Stats (옵션)
    networks:
      infra_net:
        ipv4_address: 172.19.0.56
    labels:
      - 'traefik.enable=true'
      # HAProxy Stats UI 라우터
      # 도메인: haproxy.pg.${DEFAULT_URL}
      - 'traefik.http.routers.haproxy-stats.rule=Host(`pg-haproxy.${DEFAULT_URL}`)'
      - 'traefik.http.routers.haproxy-stats.entrypoints=websecure'
      - 'traefik.http.routers.haproxy-stats.tls=true'
      # [중요] HAProxy 설정 파일(haproxy.cfg)에 정의된 Stats 포트(보통 8404)와 일치해야 함
      - 'traefik.http.services.haproxy-stats.loadbalancer.server.port=${HAPROXY_PORT:-7000}'
    depends_on:
      pg-0:
        condition: service_healthy
      pg-1:
        condition: service_healthy
      pg-2:
        condition: service_healthy
    <<: *default-restart
    logging: *default-logging

  pg-cluster-init:
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
    image: postgres:17-alpine
    container_name: pg-cluster-init
    environment:
      - POSTGRES_ROUTER_HOSTNAME=${POSTGRES_ROUTER_HOSTNAME}
      - POSTGRES_WRITE_PORT=${POSTGRES_WRITE_PORT:-15432}
      - POSTGRES_READ_PORT=${POSTGRES_READ_PORT:-15433}
      - POSTGRES_USER=${PATRONI_SUPERUSER_USERNAME:-postgres}
      - POSTGRES_DB=${POSTGRES_DB}
    secrets:
      - patroni_superuser_password
    depends_on:
      pg-router:
        condition: service_started
    command: >
      sh -c "
      echo 'DB 연결 대기 중...';
      until pg_isready -h $$POSTGRES_ROUTER_HOSTNAME -p $$POSTGRES_WRITE_PORT -U $$POSTGRES_USER; do
        sleep 2;
      done;
      echo 'SQL 스크립트 실행 시작...';
      export PGPASSWORD=\"$$(cat /run/secrets/patroni_superuser_password | tr -d '\n')\";
      psql -h "$$POSTGRES_ROUTER_HOSTNAME" -p "$$POSTGRES_WRITE_PORT" -U "$$POSTGRES_USER" -d "$$POSTGRES_DB" -f /home/postgres/init-scripts/init_users_dbs.sql;
      unset PGPASSWORD;
      echo 'SQL 스크립트 실행 완료.';"
    volumes:
      - './init-scripts/init_users_dbs.sql:/home/postgres/init-scripts/init_users_dbs.sql'
    networks:
      - infra_net
    restart: 'no'
    logging: *default-logging
  # ##############################################################
  # postgres-exporter (Prometheus / Alloy용 메트릭)
  # ##############################################################
  pg-0-exporter:
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 128M
    image: prometheuscommunity/postgres-exporter:v0.18.1
    container_name: pg-0-exporter
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    networks:
      infra_net:
        ipv4_address: 172.19.0.57
    logging: *default-logging
    expose:
      - '${POSTGRES_EXPORTER_PORT:-9187}'
    secrets:
      - service_postgres_password
    depends_on:
      pg-0:
        condition: service_healthy
    entrypoint: ['/bin/sh', '-c']
    command:
      - |
        export PGPASSWORD=$$(cat /run/secrets/service_postgres_password | tr -d '\n')
        # pg-0에 직접 접속
        export DATA_SOURCE_NAME="postgresql://postgres:$$PGPASSWORD@pg-0:5432/postgres?sslmode=require"
        exec /bin/postgres_exporter
    <<: *default-restart
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'wget -qO- http://localhost:${POSTGRES_EXPORTER_PORT:-9187}/metrics > /dev/null 2>&1 || exit 1',
        ]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
  pg-1-exporter:
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 128M
    image: prometheuscommunity/postgres-exporter:v0.18.1
    container_name: pg-1-exporter
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    networks:
      infra_net:
        ipv4_address: 172.19.0.58
    logging: *default-logging
    expose:
      - '${POSTGRES_EXPORTER_PORT:-9187}'
    secrets:
      - service_postgres_password
    depends_on:
      pg-1:
        condition: service_healthy
    entrypoint: ['/bin/sh', '-c']
    command:
      - |
        export PGPASSWORD=$$(cat /run/secrets/service_postgres_password | tr -d '\n')
        # pg-0에 직접 접속
        export DATA_SOURCE_NAME="postgresql://postgres:$$PGPASSWORD@pg-1:5432/postgres?sslmode=require"
        exec /bin/postgres_exporter
    <<: *default-restart
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'wget -qO- http://localhost:${POSTGRES_EXPORTER_PORT:-9187}/metrics > /dev/null 2>&1 || exit 1',
        ]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
  pg-2-exporter:
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 128M
    image: prometheuscommunity/postgres-exporter:v0.18.1
    container_name: pg-2-exporter
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    networks:
      infra_net:
        ipv4_address: 172.19.0.59
    logging: *default-logging
    expose:
      - '${POSTGRES_EXPORTER_PORT:-9187}'
    secrets:
      - service_postgres_password
    depends_on:
      pg-2:
        condition: service_healthy
    entrypoint: ['/bin/sh', '-c']
    command:
      - |
        export PGPASSWORD=$$(cat /run/secrets/service_postgres_password | tr -d '\n')
        # pg-0에 직접 접속
        export DATA_SOURCE_NAME="postgresql://postgres:$$PGPASSWORD@pg-2:5432/postgres?sslmode=require"
        exec /bin/postgres_exporter
    <<: *default-restart
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'wget -qO- http://localhost:${POSTGRES_EXPORTER_PORT:-9187}/metrics > /dev/null 2>&1 || exit 1',
        ]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
