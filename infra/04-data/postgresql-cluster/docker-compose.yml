name: postgresql-cluster

x-tier-label: &tier-label
  hy-home.tier: data

volumes:
  pg0-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_DATA_DIR}/pg/pg0-data
  pg1-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_DATA_DIR}/pg/pg1-data
  pg2-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_DATA_DIR}/pg/pg2-data
  etcd1-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_DATA_DIR}/etcd/etcd1-data
  etcd2-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_DATA_DIR}/etcd/etcd2-data
  etcd3-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_DATA_DIR}/etcd/etcd3-data

secrets:
  service_postgres_password: { external: true }
  patroni_superuser_password: { external: true }
  patroni_replication_password: { external: true }
  pg_haproxy_stats_password: { external: true }

networks:
  infra_net:
    name: infra_net
    external: true

services:
  etcd-1:
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-low
    image: quay.io/coreos/etcd:v3.6.7
    container_name: etcd-1
    user: '1000:1000'
    command:
      - /usr/local/bin/etcd
      - --name=etcd-1
      - --data-dir=/etcd-data
      - --initial-advertise-peer-urls=http://etcd-1:${ETCD_PEER_PORT:-2380}
      - --listen-peer-urls=http://0.0.0.0:${ETCD_PEER_PORT:-2380}
      - --listen-client-urls=http://0.0.0.0:${ETCD_CLIENT_PORT:-2379}
      - --advertise-client-urls=http://etcd-1:${ETCD_CLIENT_PORT:-2379}
      - --initial-cluster=etcd-1=http://etcd-1:${ETCD_PEER_PORT:-2380},etcd-2=http://etcd-2:${ETCD_PEER_PORT:-2380},etcd-3=http://etcd-3:${ETCD_PEER_PORT:-2380}
      - --initial-cluster-state=new
      - --initial-cluster-token=pg-ha-etcd
    healthcheck:
      test: ['CMD', 'etcdctl', 'endpoint', 'health', '--endpoints=http://localhost:2379']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    volumes:
      - etcd1-data:/etcd-data
    expose:
      - ${ETCD_CLIENT_PORT:-2379}

  etcd-2:
    <<: [] # Placeholder for inheritance if needed, but extends handles it.
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-low
    image: quay.io/coreos/etcd:v3.6.7
    container_name: etcd-2
    user: '1000:1000'
    command:
      - /usr/local/bin/etcd
      - --name=etcd-2
      - --data-dir=/etcd-data
      - --initial-advertise-peer-urls=http://etcd-2:${ETCD_PEER_PORT:-2380}
      - --listen-peer-urls=http://0.0.0.0:${ETCD_PEER_PORT:-2380}
      - --listen-client-urls=http://0.0.0.0:${ETCD_CLIENT_PORT:-2379}
      - --advertise-client-urls=http://etcd-2:${ETCD_CLIENT_PORT:-2379}
      - --initial-cluster=etcd-1=http://etcd-1:${ETCD_PEER_PORT:-2380},etcd-2=http://etcd-2:${ETCD_PEER_PORT:-2380},etcd-3=http://etcd-3:${ETCD_PEER_PORT:-2380}
      - --initial-cluster-state=new
      - --initial-cluster-token=pg-ha-etcd
    healthcheck:
      test: ['CMD', 'etcdctl', 'endpoint', 'health', '--endpoints=http://localhost:2379']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    volumes:
      - etcd2-data:/etcd-data
    expose:
      - ${ETCD_CLIENT_PORT:-2379}

  etcd-3:
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-low
    image: quay.io/coreos/etcd:v3.6.7
    container_name: etcd-3
    user: '1000:1000'
    command:
      - /usr/local/bin/etcd
      - --name=etcd-3
      - --data-dir=/etcd-data
      - --initial-advertise-peer-urls=http://etcd-3:${ETCD_PEER_PORT:-2380}
      - --listen-peer-urls=http://0.0.0.0:${ETCD_PEER_PORT:-2380}
      - --listen-client-urls=http://0.0.0.0:${ETCD_CLIENT_PORT:-2379}
      - --advertise-client-urls=http://etcd-3:${ETCD_CLIENT_PORT:-2379}
      - --initial-cluster=etcd-1=http://etcd-1:${ETCD_PEER_PORT:-2380},etcd-2=http://etcd-2:${ETCD_PEER_PORT:-2380},etcd-3=http://etcd-3:${ETCD_PEER_PORT:-2380}
      - --initial-cluster-state=new
      - --initial-cluster-token=pg-ha-etcd
    healthcheck:
      test: ['CMD', 'etcdctl', 'endpoint', 'health', '--endpoints=http://localhost:2379']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    volumes:
      - etcd3-data:/etcd-data
    expose:
      - ${ETCD_CLIENT_PORT:-2379}

  pg-0:
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-high
    image: ghcr.io/zalando/spilo-17:4.0-p3
    container_name: pg-0
    hostname: pg-0
    entrypoint: ['/bin/sh', '/usr/local/bin/spilo-entrypoint-with-secrets.sh']
    environment:
      SCOPE: 'pg-ha'
      ETCD3_HOSTS: 'etcd-1:2379,etcd-2:2379,etcd-3:2379'
      PATRONI_SUPERUSER_USERNAME: ${PATRONI_SUPERUSER_USERNAME:-postgres}
      PATRONI_REPLICATION_USERNAME: ${PATRONI_REPLICATION_USERNAME:-replicator}
      PATRONI_NAME: pg-0
      PATRONI_NAMESPACE: /service/
      PATRONI_RESTAPI_LISTEN: 0.0.0.0:${PATRONI_RESTAPI_PORT:-8008}
      PATRONI_RESTAPI_CONNECT_ADDRESS: pg-0:${PATRONI_RESTAPI_PORT:-8008}
      PATRONI_POSTGRESQL_LISTEN: 0.0.0.0:${POSTGRES_PORT:-5432}
      PATRONI_POSTGRESQL_CONNECT_ADDRESS: pg-0:${POSTGRES_PORT:-5432}
    volumes:
      - pg0-data:/home/postgres/pgdata
      - ./scripts/spilo-entrypoint-with-secrets.sh:/usr/local/bin/spilo-entrypoint-with-secrets.sh:ro
    expose:
      - ${POSTGRES_PORT:-5432}
    secrets:
      - patroni_superuser_password
      - patroni_replication_password
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    depends_on:
      etcd-1: { condition: service_healthy }
      etcd-2: { condition: service_healthy }
      etcd-3: { condition: service_healthy }

  pg-1:
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-high
    image: ghcr.io/zalando/spilo-17:4.0-p3
    container_name: pg-1
    hostname: pg-1
    entrypoint: ['/bin/sh', '/usr/local/bin/spilo-entrypoint-with-secrets.sh']
    environment:
      SCOPE: 'pg-ha'
      ETCD3_HOSTS: 'etcd-1:2379,etcd-2:2379,etcd-3:2379'
      PATRONI_SUPERUSER_USERNAME: ${PATRONI_SUPERUSER_USERNAME:-postgres}
      PATRONI_REPLICATION_USERNAME: ${PATRONI_REPLICATION_USERNAME:-replicator}
      PATRONI_NAME: pg-1
      PATRONI_NAMESPACE: /service/
      PATRONI_RESTAPI_LISTEN: 0.0.0.0:${PATRONI_RESTAPI_PORT:-8008}
      PATRONI_RESTAPI_CONNECT_ADDRESS: pg-1:${PATRONI_RESTAPI_PORT:-8008}
      PATRONI_POSTGRESQL_LISTEN: 0.0.0.0:${POSTGRES_PORT:-5432}
      PATRONI_POSTGRESQL_CONNECT_ADDRESS: pg-1:${POSTGRES_PORT:-5432}
    volumes:
      - pg1-data:/home/postgres/pgdata
      - ./scripts/spilo-entrypoint-with-secrets.sh:/usr/local/bin/spilo-entrypoint-with-secrets.sh:ro

  pg-2:
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-high
    image: ghcr.io/zalando/spilo-17:4.0-p3
    container_name: pg-2
    hostname: pg-2
    entrypoint: ['/bin/sh', '/usr/local/bin/spilo-entrypoint-with-secrets.sh']
    environment:
      SCOPE: 'pg-ha'
      ETCD3_HOSTS: 'etcd-1:2379,etcd-2:2379,etcd-3:2379'
      PATRONI_SUPERUSER_USERNAME: ${PATRONI_SUPERUSER_USERNAME:-postgres}
      PATRONI_REPLICATION_USERNAME: ${PATRONI_REPLICATION_USERNAME:-replicator}
      PATRONI_NAME: pg-2
      PATRONI_NAMESPACE: /service/
      PATRONI_RESTAPI_LISTEN: 0.0.0.0:${PATRONI_RESTAPI_PORT:-8008}
      PATRONI_RESTAPI_CONNECT_ADDRESS: pg-2:${PATRONI_RESTAPI_PORT:-8008}
      PATRONI_POSTGRESQL_LISTEN: 0.0.0.0:${POSTGRES_PORT:-5432}
      PATRONI_POSTGRESQL_CONNECT_ADDRESS: pg-2:${POSTGRES_PORT:-5432}
    volumes:
      - pg2-data:/home/postgres/pgdata
      - ./scripts/spilo-entrypoint-with-secrets.sh:/usr/local/bin/spilo-entrypoint-with-secrets.sh:ro

  pg-router:
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-med
    image: haproxy:3.3.1
    container_name: pg-router
    volumes:
      - ./config/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    secrets:
      - pg_haproxy_stats_password
    command: >
      /bin/sh -c "
      export HAPROXY_STATS_PASSWORD=$$(cat /run/secrets/pg_haproxy_stats_password) &&
      exec haproxy -f /usr/local/etc/haproxy/haproxy.cfg
      "
    ports:
      - '${POSTGRES_WRITE_HOST_PORT:-15432}:${POSTGRES_WRITE_PORT:-15432}'
      - '${POSTGRES_READ_HOST_PORT:-15433}:${POSTGRES_READ_PORT:-15433}'
      - '${HAPROXY_METRICS_HOST_PORT:-8404}:${HAPROXY_METRICS_PORT:-8404}'
    labels:
      <<: *tier-label
      traefik.enable: 'true'
      traefik.http.routers.haproxy-stats.rule: Host(`pg-haproxy.${DEFAULT_URL}`)
      traefik.http.routers.haproxy-stats.entrypoints: websecure
      traefik.http.routers.haproxy-stats.tls: 'true'
      traefik.http.services.haproxy-stats.loadbalancer.server.port: ${HAPROXY_PORT:-7000}

  pg-cluster-init:
    extends:
      file: ../../common-optimizations.yml
      service: base-resource-low
    image: postgres:17-alpine
    container_name: pg-cluster-init
    environment:
      - POSTGRES_ROUTER_HOSTNAME=${POSTGRES_ROUTER_HOSTNAME}
      - POSTGRES_WRITE_PORT=${POSTGRES_WRITE_PORT:-15432}
      - POSTGRES_READ_PORT=${POSTGRES_READ_PORT:-15433}
      - POSTGRES_USER=${PATRONI_SUPERUSER_USERNAME:-postgres}
      - POSTGRES_DB=${POSTGRES_DB}
    secrets:
      - patroni_superuser_password
    depends_on:
      pg-router: { condition: service_started }
    command: >
      sh -c "
      until pg_isready -h $$POSTGRES_ROUTER_HOSTNAME -p $$POSTGRES_WRITE_PORT -U $$POSTGRES_USER; do
        sleep 2;
      done;
      export PGPASSWORD=$(cat /run/secrets/patroni_superuser_password | tr -d '\n');
      psql -h "$$POSTGRES_ROUTER_HOSTNAME" -p "$$POSTGRES_WRITE_PORT" -U "$$POSTGRES_USER" -d "$$POSTGRES_DB" -f /home/postgres/init-scripts/init_users_dbs.sql;
      "
    volumes:
      - './init-scripts/init_users_dbs.sql:/home/postgres/init-scripts/init_users_dbs.sql'
    restart: 'no'

  pg-0-exporter:
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-low
    image: prometheuscommunity/postgres-exporter:v0.18.1
    container_name: pg-0-exporter
    expose:
      - '${POSTGRES_EXPORTER_PORT:-9187}'
    secrets:
      - service_postgres_password
    depends_on:
      pg-0: { condition: service_healthy }
    entrypoint: [/bin/sh, -c]
    command:
      - |
        export PGPASSWORD=$$(cat /run/secrets/service_postgres_password | tr -d '\n')
        export DATA_SOURCE_NAME="postgresql://postgres:$$PGPASSWORD@pg-0:5432/postgres?sslmode=require"
        exec /bin/postgres_exporter
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'wget -qO- http://localhost:${POSTGRES_EXPORTER_PORT:-9187}/metrics > /dev/null 2>&1 || exit 1',
        ]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s

  pg-1-exporter:
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-low
    image: prometheuscommunity/postgres-exporter:v0.18.1
    container_name: pg-1-exporter
    expose:
      - '${POSTGRES_EXPORTER_PORT:-9187}'
    secrets:
      - service_postgres_password
    depends_on:
      pg-1: { condition: service_healthy }
    entrypoint: [/bin/sh, -c]
    command:
      - |
        export PGPASSWORD=$$(cat /run/secrets/service_postgres_password | tr -d '\n')
        export DATA_SOURCE_NAME="postgresql://postgres:$$PGPASSWORD@pg-1:5432/postgres?sslmode=require"
        exec /bin/postgres_exporter
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'wget -qO- http://localhost:${POSTGRES_EXPORTER_PORT:-9187}/metrics > /dev/null 2>&1 || exit 1',
        ]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s

  pg-2-exporter:
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-low
    image: prometheuscommunity/postgres-exporter:v0.18.1
    container_name: pg-2-exporter
    expose:
      - '${POSTGRES_EXPORTER_PORT:-9187}'
    secrets:
      - service_postgres_password
    depends_on:
      pg-2: { condition: service_healthy }
    entrypoint: [/bin/sh, -c]
    command:
      - |
        export PGPASSWORD=$$(cat /run/secrets/service_postgres_password | tr -d '\n')
        export DATA_SOURCE_NAME="postgresql://postgres:$$PGPASSWORD@pg-2:5432/postgres?sslmode=require"
        exec /bin/postgres_exporter
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'wget -qO- http://localhost:${POSTGRES_EXPORTER_PORT:-9187}/metrics > /dev/null 2>&1 || exit 1',
        ]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
