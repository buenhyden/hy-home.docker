name: valkey-cluster

x-logging: &default-logging
  driver: 'json-file'
  options:
    max-size: '5m'
    max-file: '2'

volumes:
  valkey-data-0:
    # driver: local
    # driver_opts:
    #   o: bind
    #   type: none
    #   device: ${DEFAULT_VALKEY_DATA_DIR}/node0
  valkey-data-1:
    # driver: local
    # driver_opts:
    #   o: bind
    #   type: none
    #   device: ${DEFAULT_VALKEY_DATA_DIR}/node1
  valkey-data-2:
    # driver: local
    # driver_opts:
    #   o: bind
    #   type: none
    #   device: ${DEFAULT_VALKEY_DATA_DIR}/node2
  valkey-data-3:
    # driver: local
    # driver_opts:
    #   o: bind
    #   type: none
    #   device: ${DEFAULT_VALKEY_DATA_DIR}/node3
  valkey-data-4:
    # driver: local
    # driver_opts:
    #   o: bind
    #   type: none
    #   device: ${DEFAULT_VALKEY_DATA_DIR}/node4
  valkey-data-5:
    # driver: local
    # driver_opts:
    #   o: bind
    #   type: none
    #   device: ${DEFAULT_VALKEY_DATA_DIR}/node5

services:
  # ##############################################################
  # Redis Cluster Nodes (6개: 3 master + 3 replica)
  # ##############################################################
  valkey-node-0:
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          memory: 256M
    image: valkey/valkey:9.0.1-alpine # Valkey 9.0.x
    container_name: valkey-node-0
    secrets:
      - valkey_password
    networks:
      infra_net:
        ipv4_address: 172.19.0.60
    restart: unless-stopped
    environment:
      NODE_NAME: valkey-node-0
      PORT: ${VALKEY0_PORT}
    volumes:
      # 공통 valkey.conf
      - ./config/valkey.conf:/usr/local/etc/valkey/valkey.conf:ro
      - ./scripts/valkey-start.sh:/usr/local/bin/valkey-start.sh:ro
      # 데이터 영속화
      - valkey-data-0:/data
    command: ['sh', '/usr/local/bin/valkey-start.sh']
    ports:
      - '${VALKEY0_PORT}:${VALKEY0_PORT}'
    expose:
      - ${VALKEY0_BUS_PORT}
    healthcheck:
      # secret 파일에서 비밀번호 읽어서 PING 체크
      test: [
          'CMD-SHELL',
          'VALKEY_PASSWORD=$(cat /run/secrets/valkey_password); valkey-cli -a
          $VALKEY_PASSWORD -h 127.0.0.1 -p ${VALKEY0_PORT} ping | grep PONG',
        ]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    logging: *default-logging

  valkey-node-1:
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          memory: 256M
    image: valkey/valkey:9.0.1-alpine # Valkey 9.0.x
    container_name: valkey-node-1
    secrets:
      - valkey_password
    networks:
      infra_net:
        ipv4_address: 172.19.0.61
    restart: unless-stopped
    environment:
      NODE_NAME: valkey-node-1
      PORT: ${VALKEY1_PORT}
    volumes:
      - ./config/valkey.conf:/usr/local/etc/valkey/valkey.conf:ro
      - ./scripts/valkey-start.sh:/usr/local/bin/valkey-start.sh:ro
      - valkey-data-1:/data
    command: ['sh', '/usr/local/bin/valkey-start.sh']
    ports:
      - '${VALKEY1_PORT}:${VALKEY1_PORT}'
    expose:
      - ${VALKEY1_BUS_PORT}
    healthcheck:
      test: [
          'CMD-SHELL',
          'VALKEY_PASSWORD=$(cat /run/secrets/valkey_password); valkey-cli -a
          $VALKEY_PASSWORD -h 127.0.0.1 -p ${VALKEY1_PORT} ping | grep PONG',
        ]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    logging: *default-logging

  valkey-node-2:
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          memory: 256M
    image: valkey/valkey:9.0.1-alpine # Valkey 9.0.x
    container_name: valkey-node-2
    secrets:
      - valkey_password
    networks:
      infra_net:
        ipv4_address: 172.19.0.62
    restart: unless-stopped
    environment:
      NODE_NAME: valkey-node-2
      PORT: ${VALKEY2_PORT}
    volumes:
      - ./config/valkey.conf:/usr/local/etc/valkey/valkey.conf:ro
      - ./scripts/valkey-start.sh:/usr/local/bin/valkey-start.sh:ro
      - valkey-data-2:/data
    command: ['sh', '/usr/local/bin/valkey-start.sh']
    ports:
      - '${VALKEY2_PORT}:${VALKEY2_PORT}'
    expose:
      - ${VALKEY2_BUS_PORT}
    healthcheck:
      test: [
          'CMD-SHELL',
          'VALKEY_PASSWORD=$(cat /run/secrets/valkey_password); valkey-cli -a
          $VALKEY_PASSWORD -h 127.0.0.1 -p ${VALKEY2_PORT} ping | grep PONG',
        ]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    logging: *default-logging

  valkey-node-3:
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          memory: 256M
    image: valkey/valkey:9.0.1-alpine # Valkey 9.0.x
    container_name: valkey-node-3
    secrets:
      - valkey_password
    networks:
      infra_net:
        ipv4_address: 172.19.0.63
    restart: unless-stopped
    environment:
      NODE_NAME: valkey-node-3
      PORT: ${VALKEY3_PORT}
    volumes:
      - ./config/valkey.conf:/usr/local/etc/valkey/valkey.conf:ro
      - ./scripts/valkey-start.sh:/usr/local/bin/valkey-start.sh:ro
      - valkey-data-3:/data
    command: ['sh', '/usr/local/bin/valkey-start.sh']
    ports:
      - '${VALKEY3_PORT}:${VALKEY3_PORT}'
    expose:
      - ${VALKEY3_BUS_PORT}
    healthcheck:
      test: [
          'CMD-SHELL',
          'VALKEY_PASSWORD=$(cat /run/secrets/valkey_password); valkey-cli -a
          $VALKEY_PASSWORD -h 127.0.0.1 -p ${VALKEY3_PORT} ping | grep PONG',
        ]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    logging: *default-logging

  valkey-node-4:
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          memory: 256M
    image: valkey/valkey:9.0.1-alpine # Valkey 9.0.x
    container_name: valkey-node-4
    secrets:
      - valkey_password
    networks:
      infra_net:
        ipv4_address: 172.19.0.64
    restart: unless-stopped
    environment:
      NODE_NAME: valkey-node-4
      PORT: ${VALKEY4_PORT}
    volumes:
      - ./config/valkey.conf:/usr/local/etc/valkey/valkey.conf:ro
      - ./scripts/valkey-start.sh:/usr/local/bin/valkey-start.sh:ro
      - valkey-data-4:/data
    command: ['sh', '/usr/local/bin/valkey-start.sh']
    ports:
      - '${VALKEY4_PORT}:${VALKEY4_PORT}'
    expose:
      - ${VALKEY4_BUS_PORT}
    healthcheck:
      test: [
          'CMD-SHELL',
          'VALKEY_PASSWORD=$(cat /run/secrets/valkey_password); valkey-cli -a
          $VALKEY_PASSWORD -h 127.0.0.1 -p ${VALKEY4_PORT} ping | grep PONG',
        ]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    logging: *default-logging

  valkey-node-5:
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          memory: 256M
    image: valkey/valkey:9.0.1-alpine # Valkey 9.0.x
    container_name: valkey-node-5
    secrets:
      - valkey_password
    networks:
      infra_net:
        ipv4_address: 172.19.0.65
    restart: unless-stopped
    environment:
      NODE_NAME: valkey-node-5
      PORT: ${VALKEY5_PORT}
    volumes:
      - ./config/valkey.conf:/usr/local/etc/valkey/valkey.conf:ro
      - ./scripts/valkey-start.sh:/usr/local/bin/valkey-start.sh:ro
      - valkey-data-5:/data
    command: ['sh', '/usr/local/bin/valkey-start.sh']
    ports:
      - '${VALKEY5_PORT}:${VALKEY5_PORT}'
    expose:
      - ${VALKEY5_BUS_PORT}
    healthcheck:
      test: [
          'CMD-SHELL',
          'VALKEY_PASSWORD=$(cat /run/secrets/valkey_password); valkey-cli -a
          $VALKEY_PASSWORD -h 127.0.0.1 -p ${VALKEY5_PORT} ping | grep PONG',
        ]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    logging: *default-logging

  # ##############################################################
  # Redis Cluster 초기화용 one-shot 컨테이너
  #   - 처음 한 번 실행해서 cluster create
  #   - 이미 클러스터 구성돼 있으면 noop로 끝나도록 스크립트 작성
  # ##############################################################
  valkey-cluster-init:
    image: valkey/valkey:9.0.1
    container_name: valkey-cluster-init
    secrets:
      - valkey_password
    networks:
      infra_net:
        ipv4_address: 172.19.0.66
    restart: 'no'
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 128M
    depends_on:
      valkey-node-0:
        condition: service_healthy
      valkey-node-1:
        condition: service_healthy
      valkey-node-2:
        condition: service_healthy
      valkey-node-3:
        condition: service_healthy
      valkey-node-4:
        condition: service_healthy
      valkey-node-5:
        condition: service_healthy
    volumes:
      - ./scripts/valkey-cluster-init.sh:/usr/local/bin/valkey-cluster-init.sh:ro
    command: ['sh', '/usr/local/bin/valkey-cluster-init.sh']
    logging: *default-logging
  # ##############################################################
  # Redis Exporter – Prometheus용 메트릭
  # ##############################################################

  valkey-exporter:
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 128M
    image: oliver006/redis_exporter:v1.80.1-alpine
    container_name: valkey-exporter
    ports:
      - '${VALKEY_EXPORTER_HOST_PORT}:${VALKEY_EXPORTER_PORT}'
    networks:
      infra_net:
        ipv4_address: 172.19.0.67
    restart: unless-stopped
    secrets:
      - valkey_password
    entrypoint:
      - /bin/sh
      - -c
    command:
      - |
        echo "Loading Valkey password..."
        export R_PWD=$$(cat /run/secrets/valkey_password | tr -d '\n')

        echo "Starting Exporter (Stateless Mode)..."
        # [수정] -redis.addr 옵션을 제거하거나 비워둡니다.
        # 이렇게 하면 Exporter는 단순히 대기 상태로 시작되며,
        # Prometheus가 "어디를 긁어오라(Scrape)"고 시킬 때 작동합니다.
        exec /redis_exporter \
          -redis.addr="redis://valkey-node-0:6379" \
          -redis.password="$$R_PWD" \
          -web.listen-address=:${VALKEY_EXPORTER_PORT}
    depends_on: # healthcheck를 사용하므로 condition으로 변경 (더 안정적)
      valkey-node-0:
        condition: service_healthy
      valkey-node-1:
        condition: service_healthy
      valkey-node-2:
        condition: service_healthy
      valkey-node-3:
        condition: service_healthy
      valkey-node-4:
        condition: service_healthy
      valkey-node-5:
        condition: service_healthy
    logging: *default-logging
