name: valkey-cluster

volumes:
  valkey0-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_DATA_DIR}/valkey/data-1
  valkey1-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_DATA_DIR}/valkey/data-1
  valkey2-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_DATA_DIR}/valkey/data-2
  valkey3-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_DATA_DIR}/valkey/data-3
  valkey4-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_DATA_DIR}/valkey/data-4
  valkey5-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_DATA_DIR}/valkey/data-5

secrets:
  service_valkey_password: { external: true }

services:
  valkey-node-0: &valkey-node
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-med
    image: valkey/valkey:9.0.2-alpine
    container_name: valkey-node-0
    read_only: true
    tmpfs:
      - /tmp
      - /run
    environment:
      - PORT=6379
      - NODE_NAME=valkey-node-0
    volumes:
      - valkey0-data:/data
      - ./config/valkey.conf:/usr/local/etc/valkey/valkey.conf:ro
      - ./scripts/valkey-start.sh:/usr/local/bin/valkey-start.sh:ro
    entrypoint: [/bin/sh, /usr/local/bin/valkey-start.sh]
    secrets:
      - service_valkey_password
    networks:
      - infra_net

  valkey-node-1:
    <<: *valkey-node
    container_name: valkey-node-1
    environment:
      - PORT=6380
      - NODE_NAME=valkey-node-1
    volumes:
      - valkey1-data:/data
      - ./config/valkey.conf:/usr/local/etc/valkey/valkey.conf:ro
      - ./scripts/valkey-start.sh:/usr/local/bin/valkey-start.sh:ro

  valkey-node-2:
    <<: *valkey-node
    container_name: valkey-node-2
    environment:
      - PORT=6381
      - NODE_NAME=valkey-node-2
    volumes:
      - valkey2-data:/data
      - ./config/valkey.conf:/usr/local/etc/valkey/valkey.conf:ro
      - ./scripts/valkey-start.sh:/usr/local/bin/valkey-start.sh:ro

  valkey-node-3:
    <<: *valkey-node
    container_name: valkey-node-3
    environment:
      - PORT=6382
      - NODE_NAME=valkey-node-3
    volumes:
      - valkey3-data:/data
      - ./config/valkey.conf:/usr/local/etc/valkey/valkey.conf:ro
      - ./scripts/valkey-start.sh:/usr/local/bin/valkey-start.sh:ro

  valkey-node-4:
    <<: *valkey-node
    container_name: valkey-node-4
    environment:
      - PORT=6383
      - NODE_NAME=valkey-node-4
    volumes:
      - valkey4-data:/data
      - ./config/valkey.conf:/usr/local/etc/valkey/valkey.conf:ro
      - ./scripts/valkey-start.sh:/usr/local/bin/valkey-start.sh:ro

  valkey-node-5:
    <<: *valkey-node
    container_name: valkey-node-5
    environment:
      - PORT=6384
      - NODE_NAME=valkey-node-5
    volumes:
      - valkey5-data:/data
      - ./config/valkey.conf:/usr/local/etc/valkey/valkey.conf:ro
      - ./scripts/valkey-start.sh:/usr/local/bin/valkey-start.sh:ro

  valkey-cluster-init:
    extends:
      file: ../../common-optimizations.yml
      service: base-resource-low
    image: valkey/valkey:9.0.2-alpine
    container_name: valkey-cluster-init
    restart: 'no'
    depends_on:
      valkey-node-0: { condition: service_started }
      valkey-node-1: { condition: service_started }
      valkey-node-2: { condition: service_started }
      valkey-node-3: { condition: service_started }
      valkey-node-4: { condition: service_started }
      valkey-node-5: { condition: service_started }
    volumes:
      - ./scripts/valkey-cluster-init.sh:/usr/local/bin/valkey-cluster-init.sh:ro
    entrypoint: [/bin/sh, /usr/local/bin/valkey-cluster-init.sh]
    secrets:
      - service_valkey_password
    networks:
      - infra_net

networks:
  infra_net:
    name: infra_net
    external: true
