name: opensearch

volumes:
  opensearch-data1:
    # driver: local
    # driver_opts:
    #   o: bind
    #   type: none
    #   device: ${DEFAULT_OPENSEARCH_DATA_DIR}/node1
  opensearch-data2:
    # driver: local
    # driver_opts:
    #   o: bind
    #   type: none
    #   device: ${DEFAULT_OPENSEARCH_DATA_DIR}/node2
  opensearch-data3:
    # driver: local
    # driver_opts:
    #   o: bind
    #   type: none
    #   device: ${DEFAULT_OPENSEARCH_DATA_DIR}/node3
  opensearch_certs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DEFAULT_DOCKER_PROJECT_PATH}/secrets/certs

services:
  # ######################################################
  # OpenSearch 노드 1 (cluster_manager + data + ingest)
  # ######################################################
  opensearch-node1:
    # image: opensearchproject/opensearch:3.4.0  # 2025-11 기준 최신 3.x 안정 버전
    build:
      context: . ## build Docker file location
      dockerfile: Dockerfile ## build file name
    container_name: opensearch-node1
    restart: unless-stopped
    # 비밀번호, 클러스터 이름, JVM 옵션 등은 env 파일에서 주입
    environment:
      # 노드/클러스터 기본 설정
      - node.name=opensearch-node1
      - cluster.name=${OPENSEARCH_CLUSTER_NAME}
      # 클러스터 디스커버리 설정 (3노드 모두 동일하게 설정)
      - discovery.seed_hosts=opensearch-node1,opensearch-node2,opensearch-node3
      - cluster.initial_cluster_manager_nodes=opensearch-node1,opensearch-node2,opensearch-node3
      # JVM Heap 설정 (env에서 값 가져옴)
      - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
      # 메모리 관련 bootstrap 체크 통과용
      - bootstrap.memory_lock=true
      # 노드 역할: 클러스터 매니저 + 데이터 + 인제스트 + 원격 클러스터 클라이언트
      - node.roles=cluster_manager,data,ingest,remote_cluster_client
      - plugins.security.ssl.http.enabled=true
      - plugins.security.ssl.http.pemcert_filepath=/usr/share/opensearch/config/certs/cert.pem
      - plugins.security.ssl.http.pemkey_filepath=/usr/share/opensearch/config/certs/key.pem
      - plugins.security.ssl.http.pemtrustedcas_filepath=/usr/share/opensearch/config/certs/rootCA.pem
    command: >
      bash -c "
      export OPENSEARCH_INITIAL_ADMIN_PASSWORD=$$(cat /run/secrets/opensearch_admin_password) &&
      exec /usr/share/opensearch/opensearch-docker-entrypoint.sh
      "
    ulimits:
      # 스왑 방지를 위해 memlock 무제한
      memlock:
        soft: -1
        hard: -1
      # OpenSearch 권장 파일 디스크립터 수
      nofile:
        soft: 65536
        hard: 65536
    # Performance Analyzer가 /dev/shm 를 많이 쓰므로 크기를 넉넉히
    shm_size: 1g
    volumes:
      # 데이터 영속화 볼륨
      - opensearch-data1:/usr/share/opensearch/data
      - opensearch_certs:/usr/share/opensearch/config/certs:ro
      - ./config/userdict_ko.txt:/usr/share/opensearch/config/userdict_ko.txt:ro
    secrets:
      - opensearch_admin_password
    ports:
      # REST API (TLS on 기본) – Loki/Alloy에서 로그/메트릭 수집, 앱 연결
      # - "${ES_HOST_PORT}:${ES_PORT}"
      # Performance Analyzer / 메트릭 포트
      - '${ES_PERFORMANCE_ANALYZER_HOST_PORT:-9600}:${ES_PERFORMANCE_ANALYZER_PORT:-9600}'
    labels:
      - 'traefik.enable=true'
      # 1. OpenSearch API 라우터 (https://opensearch.${DEFAULT_URL})
      - 'traefik.http.routers.opensearch.rule=Host(`opensearch.${DEFAULT_URL}`)'
      - 'traefik.http.routers.opensearch.entrypoints=websecure'
      - 'traefik.http.routers.opensearch.tls=true'
      - 'traefik.http.services.opensearch.loadbalancer.serversTransport=opensearch-transport@file'

      # [중요] OpenSearch는 기본적으로 HTTPS(Self-signed)를 사용하므로
      # Traefik이 백엔드(OpenSearch)와 통신할 때도 HTTPS를 써야 함.
      # serversTransport 설정을 통해 인증서 검증을 스킵해야 할 수 있음.
      - 'traefik.http.services.opensearch.loadbalancer.server.port=9200'
      - 'traefik.http.services.opensearch.loadbalancer.server.scheme=https' # 백엔드 통신 스킴 지정
    networks:
      - infra_net
    # memlock 사용을 위해 IPC_LOCK만 허용
    cap_drop:
      - ALL
    cap_add:
      - IPC_LOCK
    security_opt:
      - no-new-privileges:true

  # #######################################################
  # # OpenSearch 노드 2
  # #######################################################
  opensearch-node2:
    # image: opensearchproject/opensearch:3.4.0  # 2025-11 기준 최신 3.x 안정 버전
    build:
      context: . ## build Docker file location
      dockerfile: Dockerfile ## build file name
    container_name: opensearch-node2
    restart: unless-stopped
    environment:
      - node.name=opensearch-node2
      - cluster.name=${OPENSEARCH_CLUSTER_NAME}
      - discovery.seed_hosts=opensearch-node1,opensearch-node2,opensearch-node3
      - cluster.initial_cluster_manager_nodes=opensearch-node1,opensearch-node2,opensearch-node3
      - bootstrap.memory_lock=true
      - node.roles=cluster_manager,data,ingest,remote_cluster_client
      - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
    command: >
      bash -c "
      export OPENSEARCH_INITIAL_ADMIN_PASSWORD=$$(cat /run/secrets/opensearch_admin_password) &&
      exec /usr/share/opensearch/opensearch-docker-entrypoint.sh
      "
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    shm_size: 1g
    volumes:
      - opensearch-data2:/usr/share/opensearch/data
      - ./config/userdict_ko.txt:/usr/share/opensearch/config/userdict_ko.txt:ro
    secrets:
      - opensearch_admin_password
    expose:
      - '9200'
      - '9600'
    networks:
      - infra_net
    # memlock 사용을 위해 IPC_LOCK만 허용
    cap_drop:
      - ALL
    cap_add:
      - IPC_LOCK
    security_opt:
      - no-new-privileges:true

  # #######################################################
  # # OpenSearch 노드 3
  # #######################################################
  opensearch-node3:
    # image: opensearchproject/opensearch:3.4.0  # 2025-11 기준 최신 3.x 안정 버전
    build:
      context: . ## build Docker file location
      dockerfile: Dockerfile ## build file name
    container_name: opensearch-node3
    restart: unless-stopped
    environment:
      - node.name=opensearch-node3
      - cluster.name=${OPENSEARCH_CLUSTER_NAME}
      - discovery.seed_hosts=opensearch-node1,opensearch-node2,opensearch-node3
      - cluster.initial_cluster_manager_nodes=opensearch-node1,opensearch-node2,opensearch-node3
      - bootstrap.memory_lock=true
      - node.roles=cluster_manager,data,ingest,remote_cluster_client
      - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
    command: >
      bash -c "
      export OPENSEARCH_INITIAL_ADMIN_PASSWORD=$$(cat /run/secrets/opensearch_admin_password) &&
      exec /usr/share/opensearch/opensearch-docker-entrypoint.sh
      "
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    shm_size: 1g
    volumes:
      - opensearch-data3:/usr/share/opensearch/data
      - ./config/userdict_ko.txt:/usr/share/opensearch/config/userdict_ko.txt:ro
    secrets:
      - opensearch_admin_password
    expose:
      - '9200'
      - '9600'
    networks:
      - infra_net
    # memlock 사용을 위해 IPC_LOCK만 허용
    cap_drop:
      - ALL
    cap_add:
      - IPC_LOCK
    security_opt:
      - no-new-privileges:true

  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:3.4.0
    container_name: opensearch-dashboards
    restart: unless-stopped
    networks:
      - infra_net
    expose:
      - '5601' # Expose port 5601 for web access to OpenSearch Dashboards
    # ports:
    #   - "${KIBANA_HOST_PORT}:${KIBANA_PORT}"
    volumes:
      - ../../../secrets/certs/rootCA.pem:/usr/share/opensearch-dashboards/config/rootCA.pem:ro
    environment:
      - 'OPENSEARCH_HOSTS=["https://opensearch-node1:9200","https://opensearch-node2:9200","https://opensearch-node3:9200"]'
      - OPENSEARCH_USERNAME=${ELASTIC_USERNAME}
      # mkcert 기반 인증서(SAN 없음) 대응: 호스트 검증은 끄고 CA만 검증
      - OPENSEARCH_SSL_VERIFICATIONMODE=certificate
      - OPENSEARCH_SSL_CERTIFICATEAUTHORITIES=["/usr/share/opensearch-dashboards/config/rootCA.pem"]
    command: >
      bash -c "
      export OPENSEARCH_PASSWORD=$$(cat /run/secrets/opensearch_dashboard_password) &&
      exec /usr/share/opensearch-dashboards/bin/opensearch-dashboards
      "
    secrets:
      - opensearch_dashboard_password
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    labels:
      - 'traefik.enable=true'
      # 2. Dashboards 라우터 (https://dashboards.opensearch.${DEFAULT_URL})
      # (서브 도메인을 분리하여 라우팅)
      - 'traefik.http.routers.opensearch-dashboards.rule=Host(`opensearch-dashboard.${DEFAULT_URL}`)'
      - 'traefik.http.routers.opensearch-dashboards.entrypoints=websecure'
      - 'traefik.http.routers.opensearch-dashboards.tls=true'
      - 'traefik.http.services.opensearch-dashboards.loadbalancer.server.port=5601'
      - 'traefik.http.services.opensearch-dashboards.loadbalancer.server.scheme=https'
      - 'traefik.http.services.opensearch-dashboards.loadbalancer.serversTransport=opensearch-dashboards-transport@file'
    depends_on:
      opensearch-node1:
        condition: service_healthy
      opensearch-node2:
        condition: service_healthy
      opensearch-node3:
        condition: service_healthy

  opensearch-exporter:
    image: prometheuscommunity/elasticsearch-exporter:v1.10.0
    container_name: opensearch-exporter
    restart: unless-stopped
    command: >
      bash -c "
      export ES_PASSWORD=$$(cat /run/secrets/opensearch_exporter_password) &&
      exec /bin/elasticsearch_exporter --es.uri=https://opensearch-node1:9200 --es.all --es.indices --es.ssl-skip-verify
      "
    environment:
      - ES_USERNAME=${ELASTIC_USERNAME}
    secrets:
      - opensearch_exporter_password
    ports:
      - '${ES_EXPORTER_HOST_PORT:-9114}:${ES_EXPORTER_PORT:-9114}' # 9114
    networks:
      - infra_net
    depends_on:
      opensearch-node1:
        condition: service_healthy
      opensearch-node2:
        condition: service_healthy
      opensearch-node3:
        condition: service_healthy

secrets:
  opensearch_admin_password:
    external: true
  opensearch_dashboard_password:
    external: true
  opensearch_exporter_password:
    external: true
