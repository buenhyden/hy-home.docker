name: opensearch

x-logging: &default-logging
  driver: 'json-file'
  options:
    max-size: '5m'
    max-file: '2'

services:
  # ######################################################
  # OpenSearch 노드 1 (cluster_manager + data + ingest)
  # ######################################################
  opensearch:
    # image: opensearchproject/opensearch:3.4.0  # 2025-11 기준 최신 3.x 안정 버전
    build:
      context: . ## build Docker file location
      dockerfile: Dockerfile ## build file name
    container_name: opensearch
    restart: unless-stopped
    # 비밀번호, 클러스터 이름, JVM 옵션 등은 env 파일에서 주입
    environment:
      # JVM Heap 설정
      - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
      # 메모리 관련 bootstrap 체크 통과용
      - bootstrap.memory_lock=true
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=${OPENSEARCH_ADMIN_PASSWORD}
      - DISABLE_INSTALL_DEMO_CONFIG=true
    ulimits:
      # 스왑 방지를 위해 memlock 무제한
      memlock:
        soft: -1
        hard: -1
      # OpenSearch 권장 파일 디스크립터 수
      nofile:
        soft: 65536
        hard: 65536
    # Performance Analyzer가 /dev/shm 를 많이 쓰므로 크기를 넉넉히
    shm_size: 1g
    volumes:
      # 데이터 영속화 볼륨
      - opensearch-data:/usr/share/opensearch/data
      - ../../../secrets/certs:/usr/share/opensearch/config/certs:ro
      - ./opensearch/config/opensearch-security/config.yml:/usr/share/opensearch/config/opensearch-security/config.yml:ro
      - ./opensearch/config/opensearch-security/roles_mapping.yml:/usr/share/opensearch/config/opensearch-security/roles_mapping.yml:ro
      - ./opensearch/config/opensearch-security/internal_users.yml:/usr/share/opensearch/config/opensearch-security/internal_users.yml:ro
      - ./opensearch/config/opensearch-security/action_groups.yml:/usr/share/opensearch/config/opensearch-security/action_groups.yml:ro
      - ./opensearch/config/opensearch-security/roles.yml:/usr/share/opensearch/config/opensearch-security/roles.yml:ro
      - ./opensearch/config/opensearch-security/tenants.yml:/usr/share/opensearch/config/opensearch-security/tenants.yml:ro
      - ./opensearch/config/opensearch.yml:/usr/share/opensearch/config/opensearch.yml:ro
      - ./opensearch/config/userdict_ko.txt:/usr/share/opensearch/config/userdict_ko.txt:ro
    ports:
      # REST API (TLS on 기본) – Loki/Alloy에서 로그/메트릭 수집, 앱 연결
      - '${ES_HOST_1_PORT}:${ES_PORT}'
      # Performance Analyzer / 메트릭 포트
      - '${ES_PERFORMANCE_ANALYZER_HOST_PORT}:${ES_PERFORMANCE_ANALYZER_PORT}'
    extra_hosts:
      - 'keycloak.127.0.0.1.nip.io:172.19.0.13'
    labels:
      - 'traefik.enable=true'
      # 1. OpenSearch API 라우터 (https://opensearch.${DEFAULT_URL})
      - 'traefik.http.routers.opensearch.rule=Host(`opensearch.${DEFAULT_URL}`)'
      - 'traefik.http.routers.opensearch.entrypoints=websecure'
      - 'traefik.http.routers.opensearch.tls=true'
      - 'traefik.http.services.opensearch.loadbalancer.serversTransport=opensearch-transport@file'

      # [중요] OpenSearch는 기본적으로 HTTPS(Self-signed)를 사용하므로
      # Traefik이 백엔드(OpenSearch)와 통신할 때도 HTTPS를 써야 함.
      # serversTransport 설정을 통해 인증서 검증을 스킵해야 할 수 있음.
      - 'traefik.http.services.opensearch.loadbalancer.server.port=9200'
      - 'traefik.http.services.opensearch.loadbalancer.server.scheme=https' # 백엔드 통신 스킴 지정
    networks:
      infra_net:
        ipv4_address: 172.19.0.44
        aliases:
          - opensearch-node
          - opensearch-node1
    logging: *default-logging
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'curl -k -u admin:${OPENSEARCH_ADMIN_PASSWORD} --silent --fail "https://localhost:9200/_cluster/health?wait_for_status=yellow&timeout=30s" || exit 1',
        ]
      interval: 15s
      timeout: 15s
      retries: 5
      start_period: 60s
  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:3.4.0
    container_name: opensearch-dashboards
    restart: unless-stopped
    networks:
      infra_net:
        ipv4_address: 172.19.0.47
    expose:
      - '${KIBANA_PORT}' # Expose port 5601 for web access to OpenSearch Dashboards
    # ports:
    #   - "${KIBANA_HOST_PORT}:${KIBANA_PORT}"
    volumes:
      - ../../../secrets/certs:/usr/share/opensearch-dashboards/config/certs:ro
      - ./opensearch-dashboards/config/opensearch_dashboards.yml:/usr/share/opensearch-dashboards/config/opensearch_dashboards.yml:ro
    extra_hosts:
      - 'keycloak.127.0.0.1.nip.io:172.19.0.13'
    environment:
      - OPENSEARCH_USERNAME=${OPENSEARCH_DASHBOARD_USERNAME}
      - OPENSEARCH_PASSWORD=${OPENSEARCH_DASHBOARD_PASSWORD}
      # mkcert 기반 인증서(SAN 없음) 대응: 호스트 검증은 끄고 CA만 검증
    labels:
      - 'traefik.enable=true'
      # 2. Dashboards 라우터 (https://opensearch-dashboard.${DEFAULT_URL})
      # (서브 도메인을 분리하여 라우팅)
      - 'traefik.http.routers.opensearch-dashboards.rule=Host(`opensearch-dashboard.${DEFAULT_URL}`)'
      - 'traefik.http.routers.opensearch-dashboards.entrypoints=websecure'
      - 'traefik.http.routers.opensearch-dashboards.tls=true'
      - 'traefik.http.services.opensearch-dashboards.loadbalancer.server.port=${KIBANA_PORT}'
      - 'traefik.http.services.opensearch-dashboards.loadbalancer.server.scheme=https'
      - 'traefik.http.services.opensearch-dashboards.loadbalancer.serversTransport=opensearch-dashboards-transport@file'
    depends_on:
      opensearch:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'curl -fsSk -u ${OPENSEARCH_DASHBOARD_USERNAME}:${OPENSEARCH_DASHBOARD_PASSWORD} https://localhost:${KIBANA_PORT}/api/status >/dev/null 2>&1 || exit 1',
        ]
      interval: 15s
      timeout: 15s
      retries: 5
      start_period: 60s
    logging: *default-logging

  opensearch-exporter:
    image: prometheuscommunity/elasticsearch-exporter:v1.10.0
    container_name: opensearch-exporter
    restart: unless-stopped
    command:
      - '--es.uri=https://opensearch:9200'
      - '--es.all'
      - '--es.indices'
      - '--es.ssl-skip-verify' # OpenSearch 기본 TLS 인증서 검증 건너뛰기
    environment:
      - ES_USERNAME=${OPENSEARCH_EXPORTER_USERNAME}
      - ES_PASSWORD=${OPENSEARCH_EXPORTER_PASSWORD}
    ports:
      - '${ES_EXPORTER_HOST_PORT}:${ES_EXPORTER_PORT}' # 9114
    networks:
      infra_net:
        ipv4_address: 172.19.0.48
    depends_on:
      opensearch:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'curl -fsS http://localhost:${ES_EXPORTER_PORT}/metrics || wget -q --spider http://localhost:${ES_EXPORTER_PORT}/metrics || exit 1',
        ]
      interval: 15s
      timeout: 15s
      retries: 5
      start_period: 30s
    logging: *default-logging

volumes:
  opensearch-data:
    # driver: local
    # driver_opts:
    #   o: bind
    #   type: none
    #   device: ${DEFAULT_OPENSEARCH_DATA_DIR}/standalone
