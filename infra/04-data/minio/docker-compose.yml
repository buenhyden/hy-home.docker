# Hy-Home System Optimization Headers (Standardized)
x-security-baseline: &security-baseline
  security_opt:
    - no-new-privileges:true
  cap_drop:
    - ALL

x-logging: &default-logging
  driver: 'json-file'
  options:
    max-size: '5m'
    max-file: '2'

x-resource-low: &resource-low
  deploy:
    resources:
      limits: { cpus: '0.2', memory: 128M }
      reservations: { memory: 64M }

x-resource-med: &resource-med
  deploy:
    resources:
      limits: { cpus: '0.5', memory: 512M }
      reservations: { memory: 256M }

x-resource-high: &resource-high
  deploy:
    resources:
      limits: { cpus: '1.0', memory: 1G }
      reservations: { memory: 512M }

x-restart: &default-restart
  restart: unless-stopped

name: minio

volumes:
  minio-data:

services:
  minio:
    <<: [*default-restart, *security-baseline, *resource-med]
    image: minio/minio:RELEASE.2024-11-07T00-52-20Z
    container_name: minio
    command: server /data --console-address ":${MINIO_CONSOLE_PORT:-9001}"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-admin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      MINIO_BROWSER_REDIRECT_URL: https://minio-console.${DEFAULT_URL}
      MINIO_SERVER_URL: https://minio.${DEFAULT_URL}
    volumes:
      - minio-data:/data
    ports:
      - '${MINIO_HOST_PORT:-9000}:${MINIO_PORT:-9000}'
      - '${MINIO_CONSOLE_HOST_PORT:-9001}:${MINIO_CONSOLE_PORT:-9001}'
    networks:
      infra_net:
        ipv4_address: 172.19.0.35
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:${MINIO_PORT:-9000}/minio/health/live']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    labels:
      - 'traefik.enable=true'
      # API 라우터 (S3 호환 서버 포트)
      - 'traefik.http.routers.minio.rule=Host(`minio.${DEFAULT_URL}`)'
      - 'traefik.http.routers.minio.entrypoints=websecure'
      - 'traefik.http.routers.minio.tls=true'
      - 'traefik.http.services.minio.loadbalancer.server.port=${MINIO_PORT:-9000}'
      # Console 라우터 (관리 UI 포트)
      - 'traefik.http.routers.minio-console.rule=Host(`minio-console.${DEFAULT_URL}`)'
      - 'traefik.http.routers.minio-console.entrypoints=websecure'
      - 'traefik.http.routers.minio-console.tls=true'
      - 'traefik.http.services.minio-console.loadbalancer.server.port=${MINIO_CONSOLE_PORT:-9001}'
    logging: *default-logging

  createbuckets:
    image: minio/mc:RELEASE.2024-11-05T11-29-45Z
    container_name: minio-createbuckets
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc alias set myminio http://minio:${MINIO_PORT:-9000} ${MINIO_ROOT_USER:-admin} ${MINIO_ROOT_PASSWORD};
      /usr/bin/mc mb myminio/${MINIO_DEFAULT_BUCKETS:-default};
      /usr/bin/mc policy set public myminio/${MINIO_DEFAULT_BUCKETS:-default};
      exit 0;
      "
    networks:
      - infra_net
    logging: *default-logging

networks:
  infra_net:
    name: infra_net
    external: true
