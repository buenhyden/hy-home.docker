name: minio

volumes:
  minio-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_DATA_DIR}/minio/data-1

secrets:
  minio_root_username: { external: true }
  minio_app_username: { external: true }
  minio_root_password: { external: true }
  minio_app_user_password: { external: true }

services:
  minio:
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-med
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    container_name: minio
    command: server /data --console-address ":${MINIO_CONSOLE_HOST_PORT:-9001}"
    secrets:
      - minio_root_username
      - minio_root_password
    environment:
      MINIO_ROOT_USER_FILE: /run/secrets/minio_root_username
      MINIO_ROOT_PASSWORD_FILE: /run/secrets/minio_root_password
      MINIO_PROMETHEUS_AUTH_TYPE: 'public'
      MINIO_API_ROOT_ACCESS: 'on'
    networks:
      - infra_net
    volumes:
      - minio-data:/data
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://minio:9000/minio/health/live']
      interval: 30s
      timeout: 20s
      retries: 3
    labels:
      traefik.enable: 'true'
      traefik.http.routers.minio-api.rule: Host(`minio.${DEFAULT_URL}`)
      traefik.http.routers.minio-api.entrypoints: websecure
      traefik.http.routers.minio-api.tls: 'true'
      traefik.http.routers.minio-api.service: minio-api
      traefik.http.services.minio-api.loadbalancer.server.port: ${MINIO_PORT:-9000}
      traefik.http.routers.minio-console.rule: Host(`minio-console.${DEFAULT_URL}`)
      traefik.http.routers.minio-console.entrypoints: websecure
      traefik.http.routers.minio-console.tls: 'true'
      traefik.http.routers.minio-console.service: minio-console
      traefik.http.services.minio-console.loadbalancer.server.port: ${MINIO_CONSOLE_PORT:-9001}

  minio-create-buckets:
    extends:
      file: ../../common-optimizations.yml
      service: base-resource-low
    image: minio/mc:RELEASE.2025-08-13T08-35-41Z
    container_name: minio-create-buckets
    restart: 'no'
    secrets:
      - minio_root_username
      - minio_root_password
      - minio_app_username
      - minio_app_user_password
    depends_on:
      minio: { condition: service_healthy }
    entrypoint: [/bin/sh]
    command:
      - -c
      - |
        set -e
        ROOT_USER=$$(cat /run/secrets/minio_root_username)
        ROOT_PASS=$$(cat /run/secrets/minio_root_password)
        APP_USER=$$(cat /run/secrets/minio_app_username)
        APP_PASS=$$(cat /run/secrets/minio_app_user_password)
        export MC_CONFIG_DIR=/tmp/.mc
        mc alias set root http://minio:9000 "$$ROOT_USER" "$$ROOT_PASS"
        mc admin user add root "$$APP_USER" "$$APP_PASS" || true
        mc admin policy attach root readwrite --user="$$APP_USER"
        mc alias set myminio http://minio:9000 "$$APP_USER" "$$APP_PASS"
        mc mb myminio/tempo-bucket --ignore-existing
        mc mb myminio/loki-bucket --ignore-existing
        mc mb myminio/cdn-bucket --ignore-existing
        mc mb myminio/doc-intel-assets --ignore-existing
        mc anonymous set public myminio/cdn-bucket || true

networks:
  infra_net:
    name: infra_net
    external: true
