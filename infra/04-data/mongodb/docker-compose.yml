name: mongodb

x-tier-label: &tier-label
  hy-home.tier: data

volumes:
  mongo-key:
  mongodb1-data:
  mongodb2-data:
  mongodb3-data:

services:
  mongo-key-generator:
    image: alpine:3.23.2
    container_name: mongo-key-generator
    restart: 'no'
    volumes:
      - mongo-key:/data/configdb
    command: >
      /bin/sh -c "
        if [ ! -f /data/configdb/mongodb.key ]; then
          echo 'Generating MongoDB KeyFile...';
          apk add --no-cache openssl;
          openssl rand -base64 756 > /data/configdb/mongodb.key;
        else
          echo 'KeyFile already exists.';
        fi;
        echo 'Setting permissions...';
        chown 999:999 /data/configdb/mongodb.key;
        chmod 400 /data/configdb/mongodb.key;
        ls -l /data/configdb/mongodb.key;
      "

  mongodb-rep1:
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-med
    image: mongo:8.2.3-noble
    restart: unless-stopped
    container_name: mongodb-rep1
    hostname: mongodb-rep1
    labels: {}
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD_FILE: /run/secrets/mongodb_root_password
    volumes:
      - mongodb1-data:/data/db:rw
      - mongo-key:/data/configdb:ro
    secrets:
      - mongodb_root_password
    command:
      - '--replSet'
      - 'MyReplicaSet'
      - '--keyFile'
      - '/data/configdb/mongodb.key'
      - '--bind_ip_all'
    healthcheck:
      test: ['CMD', 'mongosh', '--eval', "db.adminCommand('ping')"]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    networks:
      - infra_net
    depends_on:
      mongo-key-generator:
        condition: service_completed_successfully

  mongodb-rep2:
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-med
    image: mongo:8.2.3-noble
    restart: unless-stopped
    container_name: mongodb-rep2
    hostname: mongodb-rep2
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD_FILE: /run/secrets/mongodb_root_password
    volumes:
      - mongodb2-data:/data/db:rw
      - mongo-key:/data/configdb:ro
    secrets:
      - mongodb_root_password
    command:
      - '--replSet'
      - 'MyReplicaSet'
      - '--keyFile'
      - '/data/configdb/mongodb.key'
      - '--bind_ip_all'
    healthcheck:
      test: ['CMD', 'mongosh', '--eval', "db.adminCommand('ping')"]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    networks:
      - infra_net
    depends_on:
      mongo-key-generator:
        condition: service_completed_successfully

  mongodb-arbiter:
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-low
    image: mongo:8.2.3-noble
    container_name: mongodb-arbiter
    hostname: mongodb-arbiter
    restart: unless-stopped
    volumes:
      - mongo-key:/data/configdb:ro
    command:
      - '--replSet'
      - 'MyReplicaSet'
      - '--keyFile'
      - '/data/configdb/mongodb.key'
      - '--bind_ip_all'
    networks:
      - infra_net
    depends_on:
      mongo-key-generator:
        condition: service_completed_successfully

  mongo-init:
    image: mongo:8.2.3-noble
    container_name: mongo-init
    restart: 'no'
    networks:
      - infra_net
    depends_on:
      mongodb-rep1:
        condition: service_healthy
      mongodb-rep2:
        condition: service_healthy
    command: >
      bash -c "
        echo 'Waiting for servers to be ready...';
        sleep 5;
        export MONGO_ROOT_PASSWORD=$$(cat /run/secrets/mongodb_root_password | tr -d '\n');
        mongosh --host mongodb-rep1 -u ${MONGODB_ROOT_USERNAME} -p $$MONGO_ROOT_PASSWORD --eval '
          try {
            rs.status();
            print(\"Replica set already initialized\");
          } catch (e) {
            print(\"Initializing replica set...\");
            rs.initiate({
              _id: \"MyReplicaSet\",
              members: [
                { _id: 0, host: \"mongodb-rep1:27017\", priority: 2 },
                { _id: 1, host: \"mongodb-rep2:27017\", priority: 1 },
                { _id: 2, host: \"mongodb-arbiter:27017\", arbiterOnly: true }
              ]
            });
          }
        '
      "
    secrets:
      - mongodb_root_password

  mongo-express:
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-low
    image: mongo-express:1.0.2-20-alpine3.19
    container_name: mongo-express
    hostname: mongo-express
    restart: unless-stopped
    environment:
      ME_CONFIG_MONGODB_ENABLE_ADMIN: 'true'
      ME_CONFIG_MONGODB_AUTH_DATABASE: admin
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${MONGODB_ROOT_USERNAME}
      ME_CONFIG_MONGODB_ADMINPASSWORD_FILE: /run/secrets/mongodb_root_password
      ME_CONFIG_MONGODB_SERVER: mongodb-rep1,mongodb-rep2,mongodb-arbiter
      ME_CONFIG_MONGODB_REPLICA_SET: MyReplicaSet
      ME_CONFIG_BASICAUTH_USERNAME: ${MONGO_EXPRESS_CONFIG_BASICAUTH_USERNAME}
      ME_CONFIG_BASICAUTH_PASSWORD_FILE: /run/secrets/mongo_express_basicauth_password
    expose:
      - ${MONGO_EXPRESS_PORT:-8081}
    labels:
      <<: *tier-label
      traefik.enable: 'true'
      traefik.http.routers.mongo-express.rule: Host(`mongo-express.${DEFAULT_URL}`)
      traefik.http.routers.mongo-express.entrypoints: websecure
      traefik.http.routers.mongo-express.tls: 'true'
      traefik.http.services.mongo-express.loadbalancer.server.port: ${MONGO_EXPRESS_PORT:-8081}
    networks:
      - infra_net
    depends_on:
      mongo-init:
        condition: service_completed_successfully
    secrets:
      - mongodb_root_password
      - mongo_express_basicauth_password

  mongodb-exporter:
    extends:
      file: ../../common-optimizations.yml
      service: template-infra-low
    image: percona/mongodb_exporter:2.37
    container_name: mongodb-exporter
    read_only: true
    tmpfs:
      - /tmp
    expose:
      - ${MONGO_EXPORTER_PORT:-9216}
    entrypoint:
      - /bin/sh
      - -c
    command: >
      export MONGO_ROOT_PASSWORD=$$(cat /run/secrets/mongodb_root_password | tr -d '\n') &&
      exec mongodb_exporter
      --mongodb.uri="mongodb://${MONGODB_ROOT_USERNAME}:$${MONGO_ROOT_PASSWORD}@mongodb-rep1:27017,mongodb-rep2:27017/?replicaSet=MyReplicaSet&authSource=admin"
      --collect.collection
      --collect.database
      --collect.indexusage
    depends_on:
      mongo-init:
        condition: service_completed_successfully
    secrets:
      - mongodb_root_password
    networks:
      - infra_net

secrets:
  mongodb_root_password: { external: true }
  mongo_express_basicauth_password: { external: true }

networks:
  infra_net:
    name: infra_net
    external: true
