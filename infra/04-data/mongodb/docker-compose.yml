# Hy-Home System Optimization Headers (Standardized)
x-security-baseline: &security-baseline
  security_opt:
    - no-new-privileges:true
  cap_drop:
    - ALL

x-logging: &default-logging
  driver: 'json-file'
  options:
    max-size: '5m'
    max-file: '2'

x-resource-low: &resource-low
  deploy:
    resources:
      limits: { cpus: '0.2', memory: 128M }
      reservations: { memory: 64M }

x-resource-med: &resource-med
  deploy:
    resources:
      limits: { cpus: '0.5', memory: 512M }
      reservations: { memory: 256M }

x-resource-high: &resource-high
  deploy:
    resources:
      limits: { cpus: '1.0', memory: 1G }
      reservations: { memory: 512M }

x-restart: &default-restart
  restart: unless-stopped

name: mongodb

volumes:
  mongodb-rep1-data:
  mongodb-rep2-data:
  mongodb-arbiter-data:
  mongo-key-data:

services:
  # ============================================================================
  # Key Generation (Replica Set Auth)
  # ============================================================================
  mongo-key-generator:
    <<: [*default-restart, *security-baseline, *resource-low]
    image: alpine:latest
    container_name: mongo-key-generator
    volumes:
      - mongo-key-data:/data/configdb
    command: >
      sh -c "
      if [ ! -f /data/configdb/mongodb.key ]; then
        echo 'Generating MongoDB key file...'
        apk add --no-cache openssl
        openssl rand -base64 756 > /data/configdb/mongodb.key
        chmod 400 /data/configdb/mongodb.key
        chown 999:999 /data/configdb/mongodb.key
      else
        echo 'Key file already exists.'
      fi
      "
    networks:
      - infra_net
    logging: *default-logging

  # ============================================================================
  # Replica Set Members
  # ============================================================================
  mongodb-rep1:
    <<: [*default-restart, *security-baseline, *resource-high]
    image: mongo:8.0.4
    container_name: mongodb-rep1
    command: >
      mongod --replSet rs0 --keyFile /data/configdb/mongodb.key --bind_ip_all
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-admin}
      MONGO_INITDB_DATABASE: admin
    volumes:
      - mongodb-rep1-data:/data/db
      - mongo-key-data:/data/configdb:ro
    networks:
      infra_net:
        ipv4_address: 172.19.0.60
    depends_on:
      mongo-key-generator:
        condition: service_completed_successfully
    healthcheck:
      test:
        [
          'CMD',
          'mongosh',
          '--quiet',
          '--eval',
          'db.adminCommand("ping")',
          '-u',
          '${MONGO_ROOT_USER:-admin}',
          '-p',
          '${MONGO_ROOT_PASSWORD}',
        ]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    logging: *default-logging

  mongodb-rep2:
    <<: [*default-restart, *security-baseline, *resource-high]
    image: mongo:8.0.4
    container_name: mongodb-rep2
    command: >
      mongod --replSet rs0 --keyFile /data/configdb/mongodb.key --bind_ip_all
    volumes:
      - mongodb-rep2-data:/data/db
      - mongo-key-data:/data/configdb:ro
    networks:
      infra_net:
        ipv4_address: 172.19.0.61
    depends_on:
      mongodb-rep1:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'mongosh', '--quiet', '--eval', 'db.adminCommand("ping")']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    logging: *default-logging

  # ============================================================================
  # Arbiter Node
  # ============================================================================
  mongodb-arbiter:
    <<: [*default-restart, *security-baseline, *resource-low]
    image: mongo:8.0.4
    container_name: mongodb-arbiter
    command: >
      mongod --replSet rs0 --keyFile /data/configdb/mongodb.key --bind_ip_all
    volumes:
      - mongodb-arbiter-data:/data/db
      - mongo-key-data:/data/configdb:ro
    networks:
      infra_net:
        ipv4_address: 172.19.0.62
    depends_on:
      mongodb-rep2:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'mongosh', '--quiet', '--eval', 'db.adminCommand("ping")']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    logging: *default-logging

  # ============================================================================
  # MongoDB Management & Export
  # ============================================================================
  mongo-init:
    <<: [*default-restart, *security-baseline, *resource-low]
    image: mongo:8.0.4
    container_name: mongo-init
    depends_on:
      mongodb-rep2:
        condition: service_healthy
      mongodb-arbiter:
        condition: service_healthy
    command: >
      mongosh --host mongodb-rep1:27017 -u ${MONGO_ROOT_USER:-admin} -p ${MONGO_ROOT_PASSWORD} --eval '
      try {
        rs.status();
        console.log("Replica set already initialized.");
      } catch (e) {
        rs.initiate({
          _id: "rs0",
          members: [
            { _id: 0, host: "mongodb-rep1:27017", priority: 2 },
            { _id: 1, host: "mongodb-rep2:27017", priority: 1 },
            { _id: 2, host: "mongodb-arbiter:27017", arbiterOnly: true }
          ]
        });
        console.log("Replica set initiated.");
      }
      '
    networks:
      - infra_net
    logging: *default-logging

  mongo-express:
    <<: [*default-restart, *security-baseline, *resource-med]
    image: mongo-express:1.0.2-alpha.4
    container_name: mongo-express
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${MONGO_ROOT_USER:-admin}
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${MONGO_ROOT_PASSWORD}
      ME_CONFIG_MONGODB_URL: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD}@mongodb-rep1:27017/admin?replicaSet=rs0
      ME_CONFIG_BASICAUTH: 'true'
      ME_CONFIG_BASICAUTH_USERNAME: ${MONGO_EXPRESS_USER:-admin}
      ME_CONFIG_BASICAUTH_PASSWORD: ${MONGO_EXPRESS_PASSWORD}
    ports:
      - '${MONGO_EXPRESS_HOST_PORT:-8081}:${MONGO_EXPRESS_PORT:-8081}'
    networks:
      infra_net:
        ipv4_address: 172.19.0.63
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.mongo-express.rule=Host(`mongo-express.${DEFAULT_URL}`)'
      - 'traefik.http.routers.mongo-express.entrypoints=websecure'
      - 'traefik.http.routers.mongo-express.tls=true'
      - 'traefik.http.services.mongo-express.loadbalancer.server.port=${MONGO_EXPRESS_PORT:-8081}'
    logging: *default-logging

  mongodb-exporter:
    <<: [*default-restart, *security-baseline, *resource-low]
    image: percona/mongodb_exporter:0.40
    container_name: mongodb-exporter
    command:
      - --mongodb.uri=mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD}@mongodb-rep1:27017/admin?replicaSet=rs0
      - --collect-all
    ports:
      - '${MONGO_EXPORTER_HOST_PORT:-9216}:9216'
    networks:
      infra_net:
        ipv4_address: 172.19.0.64
    logging: *default-logging

networks:
  infra_net:
    name: infra_net
    external: true
