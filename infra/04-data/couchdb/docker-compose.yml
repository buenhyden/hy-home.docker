x-common:
  security: &security { security_opt: [no-new-privileges:true], cap_drop: [ALL] }
  logging: &logging { driver: 'json-file', options: { max-size: '5m', max-file: '2' } }
  res-low: &res-low { deploy: { resources: { limits: { cpus: '0.2', memory: 128M }, reservations: { memory: 64M } } } }
  res-med: &res-med { deploy: { resources: { limits: { cpus: '0.5', memory: 512M }, reservations: { memory: 256M } } } }
  res-high: &res-high { deploy: { resources: { limits: { cpus: '1.0', memory: 1G }, reservations: { memory: 512M } } } }
  restart: &restart { restart: unless-stopped }
  labels-base: &labels-base { traefik.enable: 'true', hy-home.managed: 'true' }

name: couchdb
x-logging: &default-logging
volumes:
  couchdb1-data:
  couchdb2-data:
  couchdb3-data:

services:
  couchdb-1:
    profiles:
      - couchdb
    image: couchdb:3.5.1
    container_name: couchdb-1
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    restart: unless-stopped
    environment:
      - COUCHDB_USER=${COUCHDB_USERNAME}
      - NODENAME=couchdb-1.infra_net
    command: >
      bash -c "
      export COUCHDB_PASSWORD=$$(cat /run/secrets/couchdb_password) &&
      export ERL_FLAGS=\"-setcookie $$(cat /run/secrets/couchdb_cookie)\" &&
      exec /opt/couchdb/bin/couchdb
      "
    secrets:
      - couchdb_password
      - couchdb_cookie
    volumes:
      - couchdb1-data:/opt/couchdb/data
    expose:
      - ${COUCHDB_PORT:-5984}
      - ${COUCHDB_ERLANG_MAPPER_PORT:-4369}
      - ${COUCHDB_ERLANG_DISTRIBUTION_PORT:-9100}
    # ports:
    #   - "${COUCHDB_HOST_PORT}:${COUCHDB_PORT}"
    networks:
      infra_net:
        aliases:
          - couchdb-1.infra_net
    healthcheck:
      test:
        - CMD-SHELL
        - export COUCHDB_PASSWORD=$$(cat /run/secrets/couchdb_password) && curl -f http://$$COUCHDB_USER:$$COUCHDB_PASSWORD@localhost:${COUCHDB_PORT:-5984}/_up
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    labels:
      - 'traefik.enable=true'
      # [Router] 도메인 설정: couchdb.${DEFAULT_URL}
      - 'traefik.http.routers.couchdb.rule=Host(`couchdb.${DEFAULT_URL}`)'
      - 'traefik.http.routers.couchdb.entrypoints=websecure'
      - 'traefik.http.routers.couchdb.tls=true'

      # 이 라우터는 'couchdb-cluster'라는 서비스로 트래픽을 보낸다.
      - 'traefik.http.routers.couchdb.service=couchdb-cluster'

      # [3] 서비스 정의 (Load Balancer)
      # 내(Node 1)가 'couchdb-cluster' 서비스의 일원임을 알림
      - 'traefik.http.services.couchdb-cluster.loadbalancer.server.port=${COUCHDB_PORT:-5984}'

      # [4] Sticky Session (중요)
      - 'traefik.http.services.couchdb-cluster.loadbalancer.sticky.cookie=true'
      - 'traefik.http.services.couchdb-cluster.loadbalancer.sticky.cookie.name=couchdb_sticky'
  couchdb-2:
    profiles:
      - couchdb
    image: couchdb:3.5.1
    container_name: couchdb-2
    restart: unless-stopped
    environment:
      - COUCHDB_USER=${COUCHDB_USERNAME}
      - NODENAME=couchdb-2.infra_net
    command: >
      bash -c "
      export COUCHDB_PASSWORD=$$(cat /run/secrets/couchdb_password) &&
      export ERL_FLAGS=\"-setcookie $$(cat /run/secrets/couchdb_cookie)\" &&
      exec /opt/couchdb/bin/couchdb
      "
    secrets:
      - couchdb_password
      - couchdb_cookie
    volumes:
      - couchdb2-data:/opt/couchdb/data
    expose:
      - ${COUCHDB_PORT:-5984}
      - ${COUCHDB_ERLANG_MAPPER_PORT:-4369}
      - ${COUCHDB_ERLANG_DISTRIBUTION_PORT:-9100}
    # ports:
    #   - "${COUCHDB_HOST_PORT}:${COUCHDB_PORT}"
    networks:
      infra_net:
        aliases:
          - couchdb-2.infra_net
    healthcheck:
      test:
        - CMD-SHELL
        - export COUCHDB_PASSWORD=$$(cat /run/secrets/couchdb_password) && curl -f http://$$COUCHDB_USER:$$COUCHDB_PASSWORD@localhost:${COUCHDB_PORT:-5984}/_up
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    labels:
      - 'traefik.enable=true'
      # [중요] 라우터(Host 규칙) 설정은 제거함 (충돌 방지)

      # [서비스 합류]
      # Node 1과 같은 서비스 이름('couchdb-cluster')을 사용하여 로드밸런싱 그룹에 들어감
      - 'traefik.http.services.couchdb-cluster.loadbalancer.server.port=${COUCHDB_PORT:-5984}'

      # Sticky Session 설정은 서비스 레벨이므로 여기도 적어주는 것이 안전함 (병합됨)
      - 'traefik.http.services.couchdb-cluster.loadbalancer.sticky.cookie=true'
      - 'traefik.http.services.couchdb-cluster.loadbalancer.sticky.cookie.name=couchdb_sticky'
  couchdb-3:
    profiles:
      - couchdb
    image: couchdb:3.5.1
    container_name: couchdb-3
    restart: unless-stopped
    environment:
      - COUCHDB_USER=${COUCHDB_USERNAME}
      - NODENAME=couchdb-3.infra_net
    command: >
      bash -c "
      export COUCHDB_PASSWORD=$$(cat /run/secrets/couchdb_password) &&
      export ERL_FLAGS=\"-setcookie $$(cat /run/secrets/couchdb_cookie)\" &&
      exec /opt/couchdb/bin/couchdb
      "
    secrets:
      - couchdb_password
      - couchdb_cookie
    volumes:
      - couchdb3-data:/opt/couchdb/data
    expose:
      - ${COUCHDB_PORT:-5984}
      - ${COUCHDB_ERLANG_MAPPER_PORT:-4369}
      - ${COUCHDB_ERLANG_DISTRIBUTION_PORT:-9100}
    # ports:
    #   - "${COUCHDB_HOST_PORT}:${COUCHDB_PORT}"
    networks:
      infra_net:
        aliases:
          - couchdb-3.infra_net
    healthcheck:
      test:
        - CMD-SHELL
        - export COUCHDB_PASSWORD=$$(cat /run/secrets/couchdb_password) && curl -f http://$$COUCHDB_USER:$$COUCHDB_PASSWORD@localhost:${COUCHDB_PORT:-5984}/_up
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    labels:
      - 'traefik.enable=true'
      # [서비스 합류]
      - 'traefik.http.services.couchdb-cluster.loadbalancer.server.port=${COUCHDB_PORT:-5984}'
      - 'traefik.http.services.couchdb-cluster.loadbalancer.sticky.cookie=true'
      - 'traefik.http.services.couchdb-cluster.loadbalancer.sticky.cookie.name=couchdb_sticky'

  # ============================================================================
  # Cluster Initializer (Setup Assistant)
  # ============================================================================
  couchdb-cluster-init:
    profiles:
      - couchdb
    image: curlimages/curl:8.18.0
    container_name: couchdb-cluster-init
    restart: 'no'
    depends_on:
      couchdb-1:
        condition: service_healthy
      couchdb-2:
        condition: service_healthy
      couchdb-3:
        condition: service_healthy
    networks:
      - infra_net
    secrets:
      - couchdb_password
    # 클러스터 조인 명령을 실행합니다.
    command: >
      /bin/sh -c "
        export COUCHDB_PASSWORD=$$(cat /run/secrets/couchdb_password) &&
        echo 'Waiting for nodes to start...';
        sleep 10;

        # 1. 노드 2를 클러스터(노드 1)에 조인
        echo 'Joining Node 2...';
        curl -X POST -H 'Content-Type: application/json' \
          http://${COUCHDB_USERNAME}:$$COUCHDB_PASSWORD@couchdb-1:${COUCHDB_PORT:-5984}/_cluster_setup \
          -d '{\"action\": \"enable_cluster\", \"bind_address\":\"0.0.0.0\", \"username\": \"${COUCHDB_USERNAME}\", \"password\":\"'$$COUCHDB_PASSWORD'\", \"port\": ${COUCHDB_PORT:-5984}, \"node_count\": \"3\", \"remote_node\": \"couchdb@couchdb-2.infra_net\", \"remote_current_user\": \"${COUCHDB_USERNAME}\", \"remote_current_password\": \"'$$COUCHDB_PASSWORD'\"}';

        curl -X POST -H 'Content-Type: application/json' \
          http://${COUCHDB_USERNAME}:$$COUCHDB_PASSWORD@couchdb-1:${COUCHDB_PORT:-5984}/_cluster_setup \
          -d '{\"action\": \"add_node\", \"host\":\"couchdb-2.infra_net\", \"port\": ${COUCHDB_PORT:-5984}, \"username\": \"${COUCHDB_USERNAME}\", \"password\":\"'$$COUCHDB_PASSWORD'\"}';

        # 2. 노드 3을 클러스터(노드 1)에 조인
        echo 'Joining Node 3...';
        curl -X POST -H 'Content-Type: application/json' \
          http://${COUCHDB_USERNAME}:$$COUCHDB_PASSWORD@couchdb-1:5984/_cluster_setup \
          -d '{\"action\": \"enable_cluster\", \"bind_address\":\"0.0.0.0\", \"username\": \"${COUCHDB_USERNAME}\", \"password\":\"'$$COUCHDB_PASSWORD'\", \"port\": 5984, \"node_count\": \"3\", \"remote_node\": \"couchdb@couchdb-3.infra_net\", \"remote_current_user\": \"${COUCHDB_USERNAME}\", \"remote_current_password\": \"'$$COUCHDB_PASSWORD'\"}';

        curl -X POST -H 'Content-Type: application/json' \
          http://${COUCHDB_USERNAME}:$$COUCHDB_PASSWORD@couchdb-1:5984/_cluster_setup \
          -d '{\"action\": \"add_node\", \"host\":\"couchdb-3.infra_net\", \"port\": 5984, \"username\": \"${COUCHDB_USERNAME}\", \"password\":\"'$$COUCHDB_PASSWORD'\"}';

        # 3. 클러스터 설정 완료 (Finish)
        echo 'Finishing Cluster Setup...';
        curl -X POST -H 'Content-Type: application/json' \
          http://${COUCHDB_USERNAME}:$$COUCHDB_PASSWORD@couchdb-1:5984/_cluster_setup \
          -d '{\"action\": \"finish_cluster\"}';

        # 4. 시스템 DB 생성 (단일 노드때와 동일하게 필요함)
        curl -X PUT http://${COUCHDB_USERNAME}:$$COUCHDB_PASSWORD@couchdb-1:5984/_users;
        curl -X PUT http://${COUCHDB_USERNAME}:$$COUCHDB_PASSWORD@couchdb-1:5984/_replicator;
        curl -X PUT http://${COUCHDB_USERNAME}:$$COUCHDB_PASSWORD@couchdb-1:5984/_global_changes;

        echo 'CouchDB Cluster Setup Complete!';
      "
    logging: *logging

secrets:
  couchdb_password:
    external: true
  couchdb_cookie:
    external: true
