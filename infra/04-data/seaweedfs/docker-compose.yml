# Hy-Home System Optimization Headers (Standardized)
x-security-baseline: &security-baseline
  security_opt:
    - no-new-privileges:true
  cap_drop:
    - ALL

x-logging: &default-logging
  driver: 'json-file'
  options:
    max-size: '5m'
    max-file: '2'

x-resource-low: &resource-low
  deploy:
    resources:
      limits: { cpus: '0.2', memory: 128M }
      reservations: { memory: 64M }

x-resource-med: &resource-med
  deploy:
    resources:
      limits: { cpus: '0.5', memory: 512M }
      reservations: { memory: 256M }

x-resource-high: &resource-high
  deploy:
    resources:
      limits: { cpus: '1.0', memory: 1G }
      reservations: { memory: 512M }

x-restart: &default-restart
  restart: unless-stopped
x-logging: &default-logging
  driver: 'json-file'
  options:
    max-size: '5m'
    max-file: '2'

volumes:
  seaweedfs-master-data:
  seaweedfs-volume-data:

services:
  # ----------------------------------------------------------------
  # SeaweedFS (스토리지 클러스터)
  # ----------------------------------------------------------------
  seaweedfs-master:
    image: chrislusf/seaweedfs:4.05
    container_name: seaweedfs-master
    # ports:
    #   - "9333:${SEAWEEDFS_MASTER_PORT}"
    #   - "19333:19333"
    expose:
      - ${SEAWEEDFS_MASTER_HTTP_PORT:-9333}
      - ${SEAWEEDFS_MASTER_GRPC_PORT:-19333}
    command: '-v=1 master -ip=seaweedfs-master -volumeSizeLimitMB=1024'
    volumes:
      - seaweedfs-master-data:/data
    networks:
      - infra_net
    labels:
      - 'traefik.enable=true'
      # [CDN 용도] Filer는 파일 시스템처럼 접근 가능하므로 정적 에셋 제공에 최적화됨
      - 'traefik.http.routers.seaweedfs-master.rule=Host(`seaweedfs.${DEFAULT_URL}`)'
      - 'traefik.http.routers.seaweedfs-master.entrypoints=websecure'
      - 'traefik.http.routers.seaweedfs-master.tls=true'
      - 'traefik.http.services.seaweedfs-master.loadbalancer.server.port=${SEAWEEDFS_MASTER_HTTP_PORT:-9333}'
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    logging: *default-logging

  seaweedfs-volume:
    image: chrislusf/seaweedfs:4.05
    container_name: seaweedfs-volume
    # ports:
    #   - "8085:${SEAWEEDFS_VOLUME_PORT}" # Host port changed to avoid conflict
    #   - "18080:18080"
    expose:
      - ${SEAWEEDFS_VOLUME_HTTP_PORT:-8085}
      - ${SEAWEEDFS_VOLUME_GRPC_PORT:-18085}
    command: '-v=1 volume -mserver=seaweedfs-master:${SEAWEEDFS_MASTER_HTTP_PORT:-9333} -port=${SEAWEEDFS_VOLUME_HTTP_PORT:-8085} -ip=seaweedfs-volume -preStopSeconds=1 -max=10000'
    volumes:
      - seaweedfs-volume-data:/data
    depends_on:
      seaweedfs-master:
        condition: service_healthy
    networks:
      - infra_net
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    logging: *default-logging

  seaweedfs-filer:
    image: chrislusf/seaweedfs:4.05
    container_name: seaweedfs-filer
    # ports:
    #   - "8888:${SEAWEEDFS_FILER_PORT}"
    #   - "18888:18888"
    expose:
      - ${SEAWEEDFS_FILER_HTTP_PORT:-8888}
      - ${SEAWEEDFS_FILER_GRPC_PORT:-18888}
    command: '-v=1 filer -ip.bind=0.0.0.0 -master=seaweedfs-master:${SEAWEEDFS_MASTER_HTTP_PORT:-9333}'
    depends_on:
      seaweedfs-master:
        condition: service_healthy
      seaweedfs-volume:
        condition: service_healthy
    labels:
      - 'traefik.enable=true'
      # [CDN 용도] Filer는 파일 시스템처럼 접근 가능하므로 정적 에셋 제공에 최적화됨
      - 'traefik.http.routers.cdn.rule=Host(`cdn.${DEFAULT_URL}`)'
      - 'traefik.http.routers.cdn.entrypoints=websecure'
      - 'traefik.http.routers.cdn.tls=true'
      - 'traefik.http.services.cdn.loadbalancer.server.port=${SEAWEEDFS_FILER_HTTP_PORT:-8888}'
    networks:
      - infra_net
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    logging: *default-logging

  seaweedfs-s3:
    image: chrislusf/seaweedfs:4.05
    container_name: seaweedfs-s3
    # ports:
    #   - "8333:${SEAWEEDFS_S3_HTTP_PORT}"
    # S3 API Gateway
    expose:
      - ${SEAWEEDFS_S3_HTTP_PORT:-8333}
    command: '-v=1 s3 -filer=seaweedfs-filer:${SEAWEEDFS_FILER_HTTP_PORT:-8888} -ip.bind=seaweedfs-s3'
    labels:
      - 'traefik.enable=true'
      # [S3 API 용도] Tempo/Loki가 내부적으로 사용할 수도 있고, 외부에서 접근할 수도 있음
      - 'traefik.http.routers.s3.rule=Host(`s3.${DEFAULT_URL}`)'
      - 'traefik.http.routers.s3.entrypoints=websecure'
      - 'traefik.http.routers.s3.tls=true'
      - 'traefik.http.services.s3.loadbalancer.server.port=${SEAWEEDFS_S3_HTTP_PORT:-8333}'
    depends_on:
      seaweedfs-filer:
        condition: service_healthy
    networks:
      - infra_net
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    logging: *default-logging

  seaweedfs-mount:
    image: chrislusf/seaweedfs:4.05
    privileged: true
    cap_add:
      - SYS_ADMIN
    mem_limit: 4096m
    command: '-v=4 mount -filer="seaweedfs-filer:${SEAWEEDFS_FILER_HTTP_PORT:-8888}" -dirAutoCreate -dir=/mnt/seaweedfs -cacheCapacityMB=100 -concurrentWriters=128'
    networks:
      - infra_net
    depends_on:
      seaweedfs-master:
        condition: service_healthy
      seaweedfs-volume:
        condition: service_healthy
      seaweedfs-filer:
        condition: service_healthy
    # privileged + SYS_ADMIN required for mount; cap_drop is intentionally omitted.
    security_opt:
      - no-new-privileges:true
    logging: *default-logging
