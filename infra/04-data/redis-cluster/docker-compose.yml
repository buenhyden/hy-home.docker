name: redic-cluster
services:
  # ##############################################################
  # Redis Cluster Nodes (6개: 3 master + 3 replica)
  # ##############################################################
  redis-node-0:
    profiles:
      - redis-cluster
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          memory: 256M
    image: redis:8.4.0-bookworm # Redis 8.4.x
    container_name: redis-node-0
    secrets:
      - redis_password
    networks:
      infra_net:
        ipv4_address: 172.19.0.60
    restart: unless-stopped
    environment:
      NODE_NAME: redis-node-0
      PORT: ${REDIS0_PORT}
    volumes:
      # 공통 redis.conf
      - ./config/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - ./scripts/redis-start.sh:/usr/local/bin/redis-start.sh:ro
      # 데이터 영속화
      - redis-data-0:/data
    command: ["sh", "/usr/local/bin/redis-start.sh"]
    # 클러스터 내부 통신 포트는 expose
    # expose:
    #   - "${REDIS_PORT}"
    #   - "${REDIS_BUS_PORT}"
    # 호스트에서 디버깅/개발용으로 6379는 0번 노드만 오픈
    ports:
      - "${REDIS0_PORT}:${REDIS0_PORT}"
      - "${REDIS0_BUS_PORT}:${REDIS0_BUS_PORT}"
    healthcheck:
      # secret 파일에서 비밀번호 읽어서 PING 체크
      test: [
          "CMD-SHELL",
          "REDIS_PASSWORD=$(cat /run/secrets/redis_password); redis-cli -a
          $REDIS_PASSWORD -h 127.0.0.1 -p ${REDIS0_PORT} ping | grep PONG",
        ]
      interval: 10s
      timeout: 3s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  redis-node-1:
    profiles:
      - redis-cluster
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          memory: 256M
    image: redis:8.4.0-bookworm
    container_name: redis-node-1
    secrets:
      - redis_password
    networks:
      infra_net:
        ipv4_address: 172.19.0.61
    restart: unless-stopped
    environment:
      NODE_NAME: redis-node-1
      PORT: ${REDIS1_PORT}
    volumes:
      - ./config/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - ./scripts/redis-start.sh:/usr/local/bin/redis-start.sh:ro
      - redis-data-1:/data
    command: ["sh", "/usr/local/bin/redis-start.sh"]
    # expose:
    #   - "${REDIS_PORT}"
    #   - "${REDIS_BUS_PORT}"
    ports:
      - "${REDIS1_PORT}:${REDIS1_PORT}"
      - "${REDIS1_BUS_PORT}:${REDIS1_BUS_PORT}"
    healthcheck:
      test: [
          "CMD-SHELL",
          "REDIS_PASSWORD=$(cat /run/secrets/redis_password); redis-cli -a
          $REDIS_PASSWORD -h 127.0.0.1 -p ${REDIS1_PORT} ping | grep PONG",
        ]
      interval: 10s
      timeout: 3s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  redis-node-2:
    profiles:
      - redis-cluster
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          memory: 256M
    image: redis:8.4.0-bookworm
    container_name: redis-node-2
    secrets:
      - redis_password
    networks:
      infra_net:
        ipv4_address: 172.19.0.62
    restart: unless-stopped
    environment:
      NODE_NAME: redis-node-2
      PORT: ${REDIS2_PORT}
    volumes:
      - ./config/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - ./scripts/redis-start.sh:/usr/local/bin/redis-start.sh:ro
      - redis-data-2:/data
    command: ["sh", "/usr/local/bin/redis-start.sh"]
    # expose:
    #   - "${REDIS_PORT}"
    #   - "${REDIS_BUS_PORT}"
    ports:
      - "${REDIS2_PORT}:${REDIS2_PORT}"
      - "${REDIS2_BUS_PORT}:${REDIS2_BUS_PORT}"
    healthcheck:
      test: [
          "CMD-SHELL",
          "REDIS_PASSWORD=$(cat /run/secrets/redis_password); redis-cli -a
          $REDIS_PASSWORD -h 127.0.0.1 -p ${REDIS2_PORT} ping | grep PONG",
        ]
      interval: 10s
      timeout: 3s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  redis-node-3:
    profiles:
      - redis-cluster
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          memory: 256M
    image: redis:8.4.0-bookworm
    container_name: redis-node-3
    secrets:
      - redis_password
    networks:
      infra_net:
        ipv4_address: 172.19.0.63
    restart: unless-stopped
    environment:
      NODE_NAME: redis-node-3
      PORT: ${REDIS3_PORT}
    volumes:
      - ./config/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - ./scripts/redis-start.sh:/usr/local/bin/redis-start.sh:ro
      - redis-data-3:/data
    command: ["sh", "/usr/local/bin/redis-start.sh"]
    # expose:
    #   - "${REDIS_PORT}"
    #   - "${REDIS_BUS_PORT}"
    ports:
      - "${REDIS3_PORT}:${REDIS3_PORT}"
      - "${REDIS3_BUS_PORT}:${REDIS3_BUS_PORT}"
    healthcheck:
      test: [
          "CMD-SHELL",
          "REDIS_PASSWORD=$(cat /run/secrets/redis_password); redis-cli -a
          $REDIS_PASSWORD -h 127.0.0.1 -p ${REDIS3_PORT} ping | grep PONG",
        ]
      interval: 10s
      timeout: 3s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  redis-node-4:
    profiles:
      - redis-cluster
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          memory: 256M
    image: redis:8.4.0-bookworm
    container_name: redis-node-4
    secrets:
      - redis_password
    networks:
      infra_net:
        ipv4_address: 172.19.0.64
    restart: unless-stopped
    environment:
      NODE_NAME: redis-node-4
      PORT: ${REDIS4_PORT}
    volumes:
      - ./config/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - ./scripts/redis-start.sh:/usr/local/bin/redis-start.sh:ro
      - redis-data-4:/data
    command: ["sh", "/usr/local/bin/redis-start.sh"]
    # expose:
    #   - "${REDIS_PORT}"
    #   - "${REDIS_BUS_PORT}"
    ports:
      - "${REDIS4_PORT}:${REDIS4_PORT}"
      - "${REDIS4_BUS_PORT}:${REDIS4_BUS_PORT}"
    healthcheck:
      test: [
          "CMD-SHELL",
          "REDIS_PASSWORD=$(cat /run/secrets/redis_password); redis-cli -a
          $REDIS_PASSWORD -h 127.0.0.1 -p ${REDIS4_PORT} ping | grep PONG",
        ]
      interval: 10s
      timeout: 3s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  redis-node-5:
    profiles:
      - redis-cluster
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          memory: 256M
    image: redis:8.4.0-bookworm
    container_name: redis-node-5
    secrets:
      - redis_password
    networks:
      infra_net:
        ipv4_address: 172.19.0.65
    restart: unless-stopped
    environment:
      NODE_NAME: redis-node-5
      PORT: ${REDIS5_PORT}
    volumes:
      - ./config/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - ./scripts/redis-start.sh:/usr/local/bin/redis-start.sh:ro
      - redis-data-5:/data
    command: ["sh", "/usr/local/bin/redis-start.sh"]
    # expose:
    #   - "${REDIS_PORT}"
    #   - "${REDIS_BUS_PORT}"
    ports:
      - "${REDIS5_PORT}:${REDIS5_PORT}"
      - "${REDIS5_BUS_PORT}:${REDIS5_BUS_PORT}"
    healthcheck:
      test: [
          "CMD-SHELL",
          "REDIS_PASSWORD=$(cat /run/secrets/redis_password); redis-cli -a
          $REDIS_PASSWORD -h 127.0.0.1 -p ${REDIS5_PORT} ping | grep PONG",
        ]
      interval: 10s
      timeout: 3s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ##############################################################
  # Redis Cluster 초기화용 one-shot 컨테이너
  #   - 처음 한 번 실행해서 cluster create
  #   - 이미 클러스터 구성돼 있으면 noop로 끝나도록 스크립트 작성
  # ##############################################################
  redis-cluster-init:
    profiles:
      - redis-cluster
    image: redis:8.4
    container_name: redis-cluster-init
    secrets:
      - redis_password
    networks:
      infra_net:
        ipv4_address: 172.19.0.66
    restart: "no"
    deploy:
      resources:
        limits:
          cpus: "0.1"
          memory: 128M
    depends_on:
      redis-node-0:
        condition: service_healthy
      redis-node-1:
        condition: service_healthy
      redis-node-2:
        condition: service_healthy
      redis-node-3:
        condition: service_healthy
      redis-node-4:
        condition: service_healthy
      redis-node-5:
        condition: service_healthy
    volumes:
      - ./scripts/redis-cluster-init.sh:/usr/local/bin/redis-cluster-init.sh:ro
    command: ["sh", "/usr/local/bin/redis-cluster-init.sh"]
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
  # ##############################################################
  # Redis Exporter – Prometheus용 메트릭
  # ##############################################################

  redis-exporter:
    profiles:
      - redis-cluster
    deploy:
      resources:
        limits:
          cpus: "0.1"
          memory: 128M
    image: oliver006/redis_exporter:v1.80.1-alpine
    container_name: redis-exporter
    ports:
      - "${REDIS_EXPORTER_HOST_PORT}:${REDIS_EXPORTER_PORT}"
    networks:
      infra_net:
        ipv4_address: 172.19.0.67
    restart: unless-stopped
    secrets:
      - redis_password
    entrypoint:
      - /bin/sh
      - -c
    command:
      - |
        echo "Loading Redis password..."
        export R_PWD=$$(cat /run/secrets/redis_password | tr -d '\n')

        echo "Starting Exporter (Stateless Mode)..."
        # [수정] -redis.addr 옵션을 제거하거나 비워둡니다.
        # 이렇게 하면 Exporter는 단순히 대기 상태로 시작되며,
        # Prometheus가 "어디를 긁어오라(Scrape)"고 시킬 때 작동합니다.
        exec /redis_exporter \
          -redis.addr="redis://redis-node-0:6379" \
          -redis.password="$$R_PWD" \
          -web.listen-address=:${REDIS_EXPORTER_PORT}
    depends_on: # healthcheck를 사용하므로 condition으로 변경 (더 안정적)
      redis-node-0:
        condition: service_healthy
      redis-node-1:
        condition: service_healthy
      redis-node-2:
        condition: service_healthy
      redis-node-3:
        condition: service_healthy
      redis-node-4:
        condition: service_healthy
      redis-node-5:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

volumes:
  redis-data-0:
    # driver: local
    # driver_opts:
    #   o: bind
    #   type: none
    #   device: ${DEFAULT_REDIS_DATA_DIR}/node0
  redis-data-1:
    # driver: local
    # driver_opts:
    #   o: bind
    #   type: none
    #   device: ${DEFAULT_REDIS_DATA_DIR}/node1
  redis-data-2:
    # driver: local
    # driver_opts:
    #   o: bind
    #   type: none
    #   device: ${DEFAULT_REDIS_DATA_DIR}/node2
  redis-data-3:
    # driver: local
    # driver_opts:
    #   o: bind
    #   type: none
    #   device: ${DEFAULT_REDIS_DATA_DIR}/node3
  redis-data-4:
    # driver: local
    # driver_opts:
    #   o: bind
    #   type: none
    #   device: ${DEFAULT_REDIS_DATA_DIR}/node4
  redis-data-5:
    # driver: local
    # driver_opts:
    #   o: bind
    #   type: none
    #   device: ${DEFAULT_REDIS_DATA_DIR}/node5
