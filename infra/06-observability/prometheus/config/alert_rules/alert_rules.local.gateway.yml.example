groups:
  # ============================================================================
  # [9] Gateway & Load Balancers
  # ============================================================================
  - name: gateway_alerts
    rules:
      - alert: HAProxyDown
        expr: up{job="haproxy"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "HAProxy 다운"
          description: "로드밸런서(HAProxy)가 응답하지 않습니다."

      - alert: HAProxyBackendConnectionErrors
        expr:
          sum by (proxy) (rate(haproxy_backend_connection_errors_total[1m])) >
          100
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "HAProxy 백엔드 연결 오류 급증: {{ $labels.proxy }}"
          description:
            "백엔드 {{ $labels.proxy }} 연결 오류가 초당 100회를 초과했습니다."

      - alert: HaproxyHighHttp4xxErrorRateBackend
        expr:
          ((sum by (proxy)
          (rate(haproxy_server_http_responses_total{code="4xx"}[1m])) / sum by
          (proxy) (rate(haproxy_server_http_responses_total[1m]))) * 100) > 5
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "HAProxy 4xx 에러율 높음: {{ $labels.proxy }}"
          description:
            "백엔드 {{ $labels.proxy }}의 4xx 에러율이 5%를 초과했습니다."

      - alert: HaproxyHighHttp5xxErrorRateBackend
        expr:
          ((sum by (proxy)
          (rate(haproxy_server_http_responses_total{code="5xx"}[1m])) / sum by
          (proxy) (rate(haproxy_server_http_responses_total[1m]))) * 100) > 5
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "HAProxy 5xx 에러율 높음: {{ $labels.proxy }}"
          description:
            "백엔드 {{ $labels.proxy }}의 5xx 에러율이 5%를 초과했습니다."

      - alert: HaproxyBackendDown
        expr: haproxy_backend_up == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "HAProxy 백엔드 다운: {{ $labels.proxy }}"
          description:
            "HAProxy 백엔드 {{ $labels.proxy }}의 모든 서버가 다운되었습니다."

      - alert: TraefikDown
        expr: up{job="traefik"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Traefik 다운"
          description: "Traefik 로드밸런서가 응답하지 않습니다."

      - alert: TraefikServiceDown
        expr: max by (service) (traefik_service_server_up) == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Traefik 서비스 다운: {{ $labels.service }}"
          description:
            "Traefik 서비스 {{ $labels.service }}의 모든 백엔드가
            다운되었습니다."

      - alert: TraefikHighHttp4xxErrorRateService
        expr:
          sum(rate(traefik_service_requests_total{code=~"4.*"}[3m])) by
          (service) / sum(rate(traefik_service_requests_total[3m])) by (service)
          * 100 > 20
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Traefik 4xx 에러율 높음: {{ $labels.service }}"
          description:
            "Traefik 서비스 {{ $labels.service }}의 4xx 에러율이 20%를
            초과했습니다."

      - alert: TraefikHighHttp5xxErrorRateService
        expr:
          sum(rate(traefik_service_requests_total{code=~"5.*"}[3m])) by
          (service) / sum(rate(traefik_service_requests_total[3m])) by (service)
          * 100 > 5
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Traefik 5xx 에러율 높음: {{ $labels.service }}"
          description:
            "Traefik 서비스 {{ $labels.service }}의 5xx 에러율이 5%를
            초과했습니다."
