# Hy-Home Observability Stack
# Refactored to use extends pattern for configuration inheritance

x-labels-base: &labels-base
  hy-home.managed: 'true'
  observability.logs: 'true'
  hy-home.tier: observability

x-logging-loki: &logging-loki
  driver: loki
  options:
    loki-url: 'http://localhost:3100/loki/api/v1/push'
    loki-external-labels: 'container_name={{.Name}}'

volumes:
  tempo-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_OBSERVABILITY_DIR}/tempo
  loki-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_OBSERVABILITY_DIR}/loki
  alertmanager-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_OBSERVABILITY_DIR}/alertmanager
  prometheus-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_OBSERVABILITY_DIR}/prometheus
  grafana-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_OBSERVABILITY_DIR}/grafana

services:
  # -------------------------------------------------------
  # 1. Metrics Storage (Prometheus)
  # -------------------------------------------------------
  prometheus:
    extends:
      file: ../common-optimizations.yml
      service: template-infra-high
    image: prom/prometheus:v3.9.0
    container_name: infra-prometheus
    user: '1000:1000'

    entrypoint: ['/bin/sh', '-c']
    command: >
      "OPENSEARCH_PASSWORD=$$(cat /run/secrets/opensearch_exporter_password) &&
      sed \"s|__OPENSEARCH_PASSWORD__|$$OPENSEARCH_PASSWORD|g\" /etc/prometheus/prometheus.yml.template > /tmp/prometheus.yml &&
      exec /bin/prometheus --config.file=/tmp/prometheus.yml
      --storage.tsdb.path=/prometheus
      --web.console.libraries=/usr/share/prometheus/console_libraries
      --web.console.templates=/usr/share/prometheus/consoles
      --web.enable-lifecycle
      --web.enable-remote-write-receiver"
    volumes:
      - ./prometheus/config/prometheus.yml:/etc/prometheus/prometheus.yml.template:ro
      - ./prometheus/config/alert_rules:/etc/prometheus/alert_rules
      - prometheus-data:/prometheus
    networks:
      infra_net:
        ipv4_address: 172.19.0.30
    secrets:
      - opensearch_exporter_password
    healthcheck:
      test:
        [
          'CMD',
          'wget',
          '-q',
          '--tries=1',
          '--spider',
          'http://localhost:${PROMETHEUS_PORT:-9090}/-/healthy',
        ]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 3m
    labels:
      <<: *labels-base
      traefik.enable: 'true'
      traefik.http.routers.prometheus.rule: Host(`prometheus.${DEFAULT_URL}`)
      traefik.http.routers.prometheus.entrypoints: websecure
      traefik.http.routers.prometheus.tls: 'true'
      traefik.http.services.prometheus.loadbalancer.server.port: ${PROMETHEUS_PORT:-9090}
    logging: *logging-loki

  # -------------------------------------------------------
  # 2. Log Storage (Loki)
  # -------------------------------------------------------
  loki:
    extends:
      file: ../common-optimizations.yml
      service: template-infra-high
    image: grafana/loki:3.6.6
    container_name: infra-loki

    entrypoint: ['/bin/sh', '-c']
    command: >
      "export MINIO_APP_USER_PASSWORD=$$(cat /run/secrets/minio_app_user_password) &&
      exec /usr/bin/loki -config.file=/etc/loki/loki-config.yaml -config.expand-env=true"
    networks:
      infra_net:
        ipv4_address: 172.19.0.31
    logging: *logging-loki
    ports:
      - '${LOKI_HOST_PORT:-3100}:${LOKI_PORT:-3100}'
    volumes:
      - ./loki/config/loki-config.yaml:/etc/loki/loki-config.yaml:ro
      - loki-data:/loki
    environment:
      - MINIO_APP_USERNAME=${MINIO_APP_USERNAME}
    secrets:
      - minio_app_user_password
    labels:
      <<: *labels-base
    healthcheck:
      test: ['CMD-SHELL', 'wget -q --spider http://localhost:3100/ready || exit 1']
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 2m

  # -------------------------------------------------------
  # 3. Trace Storage (Tempo)
  # -------------------------------------------------------
  tempo:
    extends:
      file: ../common-optimizations.yml
      service: template-infra-high
    image: grafana/tempo:2.10.1
    container_name: infra-tempo

    entrypoint: ['/bin/sh', '-c']
    command: >
      "export MINIO_APP_USER_PASSWORD=$$(cat /run/secrets/minio_app_user_password) &&
      exec /usr/bin/tempo -config.file=/etc/tempo.yaml -config.expand-env=true"
    volumes:
      - ./tempo/config/tempo.yaml:/etc/tempo.yaml:ro
      - tempo-data:/var/tempo
    networks:
      infra_net:
        ipv4_address: 172.19.0.32
    ports:
      - '${TEMPO_HOST_PORT:-3200}:${TEMPO_PORT:-3200}'
    environment:
      - MINIO_APP_USERNAME=${MINIO_APP_USERNAME}
    secrets:
      - minio_app_user_password
    labels:
      <<: *labels-base
    logging: *logging-loki

  pyroscope:
    extends:
      file: ../common-optimizations.yml
      service: template-infra-med
    image: grafana/pyroscope:1.18.1
    container_name: infra-pyroscope

    ports:
      - '${PYROSCOPE_HOST_PORT:-4040}:${PYROSCOPE_PORT:-4040}'
    networks:
      infra_net:
        ipv4_address: 172.19.0.38
    healthcheck:
      test: ['CMD-SHELL', 'wget -q --spider http://localhost:4040/ready || exit 1']
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 1m
    labels:
      <<: *labels-base
    logging: *logging-loki

  # -------------------------------------------------------
  # 4. Visualization (Grafana)
  # -------------------------------------------------------
  grafana:
    extends:
      file: ../common-optimizations.yml
      service: template-infra-med
    image: grafana/grafana:12.3.3
    container_name: infra-grafana

    environment:
      - GF_SERVER_ROOT_URL=https://grafana.${DEFAULT_URL}
      - GF_SERVER_DOMAIN=grafana.${DEFAULT_URL}
      - GF_AUTH_OAUTH_AUTO_LOGIN=true
      - GF_AUTH_DISABLE_LOGIN_FORM=true
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USERNAME}
      - GF_SECURITY_ADMIN_PASSWORD__FILE=/run/secrets/grafana_admin_password
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_USERS_AUTO_ASSIGN_ORG_ROLE=Editor
      - GF_LOG_LEVEL=info
      - GF_AUTH_GENERIC_OAUTH_ENABLED=true
      - GF_AUTH_GENERIC_OAUTH_NAME=Keycloak
      - GF_AUTH_GENERIC_OAUTH_ALLOW_SIGN_UP=true
      - GF_AUTH_GENERIC_OAUTH_LOGIN_ATTRIBUTE_PATH=preferred_username
      - GF_AUTH_GENERIC_OAUTH_EMAIL_ATTRIBUTE_PATH=email
      - GF_AUTH_GENERIC_OAUTH_NAME_ATTRIBUTE_PATH=name
      - GF_AUTH_GENERIC_OAUTH_CLIENT_ID=${OAUTH2_PROXY_CLIENT_ID}
      - GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET__FILE=/run/secrets/oauth2_proxy_client_secret
      - GF_AUTH_GENERIC_OAUTH_SCOPES=openid profile email offline_access groups
      - GF_AUTH_GENERIC_OAUTH_TLS_SKIP_VERIFY_INSECURE=true
      - GF_DATAPROXY_TIMEOUT=300
      - GF_DATAPROXY_KEEP_ALIVE_SECONDS=300
      - GF_SERVER_READ_TIMEOUT=5m
      - GF_AUTH_GENERIC_OAUTH_AUTH_URL=https://keycloak.${DEFAULT_URL}/realms/hy-home.realm/protocol/openid-connect/auth
      - GF_AUTH_GENERIC_OAUTH_TOKEN_URL=https://keycloak.${DEFAULT_URL}/realms/hy-home.realm/protocol/openid-connect/token
      - GF_AUTH_GENERIC_OAUTH_API_URL=https://keycloak.${DEFAULT_URL}/realms/hy-home.realm/protocol/openid-connect/userinfo
      - GF_AUTH_SIGNOUT_REDIRECT_URL=https://keycloak.${DEFAULT_URL}/realms/hy-home.realm/protocol/openid-connect/logout?post_logout_redirect_uri=https://grafana.${DEFAULT_URL}/login
      - GF_AUTH_GENERIC_OAUTH_ROLE_ATTRIBUTE_PATH=contains(groups[*], '/admins') && 'Admin' || contains(groups[*], '/editors') && 'Editor' || 'Viewer'
      - GF_AUTH_GENERIC_OAUTH_ROLE_ATTRIBUTE_STRICT=true
      - GF_AUTH_GENERIC_OAUTH_ALLOW_ASSIGN_GRAFANA_ADMIN=true
      - GF_AUTH_GENERIC_OAUTH_GRAFANA_ADMIN_ATTRIBUTE_PATH=contains(groups[*], '/admins')
      - GF_FEATURE_TOGGLES_ENABLE=traceqlEditor
      - GF_AUTH_GENERIC_OAUTH_USE_PKCE=true
      - GF_AUTH_GENERIC_OAUTH_CODE_CHALLENGE_METHOD=S256
      - GF_PLUGINS_PREINSTALL_SYNC=grafana-pyroscope-app,hamedkarbasi93-kafka-datasource,redis-datasource,grafana-opensearch-datasource,redis-app,redis-explorer-app
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/etc/grafana/dashboards
      - grafana-data:/var/lib/grafana
    secrets:
      - grafana_admin_password
      - oauth2_proxy_client_secret
    networks:
      infra_net:
        ipv4_address: 172.19.0.33
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'wget -q --spider http://localhost:${GRAFANA_PORT:-3000}/api/health || exit 1',
        ]
      interval: 15s
      timeout: 15s
      retries: 5
      start_period: 30s
    depends_on:
      prometheus:
        condition: service_healthy
      loki:
        condition: service_started
      tempo:
        condition: service_started
    labels:
      <<: *labels-base
      traefik.enable: 'true'
      traefik.http.routers.grafana.rule: Host(`grafana.${DEFAULT_URL}`)
      traefik.http.routers.grafana.entrypoints: websecure
      traefik.http.routers.grafana.tls: 'true'
      traefik.http.services.grafana.loadbalancer.server.port: ${GRAFANA_PORT:-3000}
      traefik.http.routers.grafana.middlewares: sso-auth@file
    logging: *logging-loki

  # -------------------------------------------------------
  # 5. Telemetry Collector (Alloy)
  # -------------------------------------------------------
  alloy:
    extends:
      file: ../common-optimizations.yml
      service: template-infra-med
    image: grafana/Alloy:v1.13.1
    container_name: infra-Alloy

    user: '0:0'
    command:
      ['run', '--server.http.listen-addr=0.0.0.0:${ALLOY_PORT:-12345}', '/etc/alloy/config.alloy']
    volumes:
      - ./alloy/config/config.alloy:/etc/alloy/config.alloy:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - '${ALLOY_OTLP_GRPC_HOST_PORT:-4317}:${ALLOY_OTLP_GRPC_PORT:-4317}'
      - '${ALLOY_OTLP_HTTP_HOST_PORT:-4318}:${ALLOY_OTLP_HTTP_PORT:-4318}'
    networks:
      infra_net:
        ipv4_address: 172.19.0.34
    depends_on:
      prometheus:
        condition: service_healthy
      loki:
        condition: service_started
      tempo:
        condition: service_started
    healthcheck:
      test:
        [
          'CMD-SHELL',
          "bash -c 'exec 3<>/dev/tcp/localhost/12345; printf \"HEAD /-/healthy HTTP/1.1\\r\\nHost: localhost\\r\\n\\r\\n\" >&3; timeout 2 head -1 <&3 | grep -q \"200\"'",
        ]
      interval: 15s
      timeout: 15s
      retries: 5
      start_period: 30s
    labels:
      <<: *labels-base
      traefik.enable: 'true'
      traefik.http.routers.alloy.rule: Host(`alloy.${DEFAULT_URL}`)
      traefik.http.routers.alloy.entrypoints: websecure
      traefik.http.routers.alloy.tls: 'true'
      traefik.http.services.alloy.loadbalancer.server.port: ${ALLOY_PORT:-12345}
    logging: *logging-loki

  cadvisor:
    extends:
      file: ../common-optimizations.yml
      service: base-resource-med
    image: gcr.io/cadvisor/cadvisor:v0.55.1
    command:
      - '--docker_only=true'
      - '--housekeeping_interval=30s'
      - '--max_housekeeping_interval=35s'
      - '--event_storage_event_limit=default=0'
      - '--event_storage_age_limit=default=0'
    container_name: cadvisor
    hostname: cadvisor
    privileged: true
    devices:
      - /dev/kmsg
    expose:
      - ${CADVISOR_PORT:-8080}
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /etc/machine-id:/etc/machine-id:ro
      - /var/lib/dbus/machine-id:/var/lib/dbus/machine-id:ro
    networks:
      infra_net:
        ipv4_address: 172.19.0.35
    labels:
      <<: *labels-base
    logging: *logging-loki

  alertmanager:
    extends:
      file: ../common-optimizations.yml
      service: template-infra-low
    image: prom/alertmanager:v0.30.0
    container_name: infra-alertmanager

    secrets:
      - smtp_username
      - smtp_password
      - slack_webhook
    entrypoint: ['/bin/sh', '-c']
    command: >
      "SMTP_USERNAME=$$(cat /run/secrets/smtp_username) &&
      SMTP_PASSWORD=$$(cat /run/secrets/smtp_password) &&
      SLACK_WEBHOOK_URL=$$(cat /run/secrets/slack_webhook) &&
      sed -e \"s|__SMTP_USERNAME__|$$SMTP_USERNAME|g\" \
          -e \"s|__SMTP_PASSWORD__|$$SMTP_PASSWORD|g\" \
          -e \"s|__SLACK_WEBHOOK_URL__|$$SLACK_WEBHOOK_URL|g\" \
          /etc/alertmanager/config.yml.template > /tmp/config.yml &&
      exec /bin/alertmanager --config.file=/tmp/config.yml --storage.path=/alertmanager"
    volumes:
      - ./alertmanager/config/config.yml:/etc/alertmanager/config.yml.template
      - alertmanager-data:/alertmanager
    depends_on:
      prometheus:
        condition: service_healthy
      grafana:
        condition: service_healthy
    networks:
      infra_net:
        ipv4_address: 172.19.0.36
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'wget -q --spider http://localhost:${ALERTMANAGER_PORT:-9093}/-/ready || exit 1',
        ]
      interval: 15s
      timeout: 15s
      retries: 5
      start_period: 1m
    labels:
      <<: *labels-base
      traefik.enable: 'true'
      traefik.http.routers.alertmanager.rule: Host(`alertmanager.${DEFAULT_URL}`)
      traefik.http.routers.alertmanager.entrypoints: websecure
      traefik.http.routers.alertmanager.tls: 'true'
      traefik.http.services.alertmanager.loadbalancer.server.port: ${ALERTMANAGER_PORT:-9093}
    logging: *logging-loki

  pushgateway:
    extends:
      file: ../common-optimizations.yml
      service: template-infra-low
    image: prom/pushgateway:v1.11.2
    container_name: pushgateway

    expose:
      - ${PUSHGATEWAY_PORT:-9091}
    depends_on:
      prometheus:
        condition: service_healthy
      grafana:
        condition: service_healthy
    networks:
      infra_net:
        ipv4_address: 172.19.0.37
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'wget -q --spider http://localhost:${PUSHGATEWAY_PORT:-9091}/-/ready || exit 1',
        ]
      interval: 15s
      timeout: 15s
      retries: 5
      start_period: 30s
    labels:
      <<: *labels-base
      traefik.enable: 'true'
      traefik.http.routers.pushgateway.rule: Host(`pushgateway.${DEFAULT_URL}`)
      traefik.http.routers.pushgateway.entrypoints: websecure
      traefik.http.routers.pushgateway.tls: 'true'
      traefik.http.services.pushgateway.loadbalancer.server.port: ${PUSHGATEWAY_PORT:-9091}
    logging: *logging-loki

networks:
  infra_net:
    name: infra_net
    external: true

secrets:
  minio_app_user_password:
    external: true
  grafana_admin_password:
    external: true
  oauth2_proxy_client_secret:
    external: true
  smtp_username:
    external: true
  smtp_password:
    external: true
  slack_webhook:
    external: true
  opensearch_exporter_password:
    external: true
