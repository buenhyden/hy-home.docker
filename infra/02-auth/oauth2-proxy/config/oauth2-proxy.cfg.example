## config/oauth2-proxy.cfg

# --- Provider 설정 ---
provider = "keycloak-oidc"
client_id = "proxy-client"
# .env의 변수를 여기서는 쓸 수 없으므로, 직접 값을 넣거나
# 민감한 정보는 docker-compose의 environment에 남겨둬도 됩니다.


# [핵심 추가] 그룹 정보를 가져오기 위해 groups 스코프를 반드시 추가합니다.
scope = "openid email profile offline_access groups"

# Keycloak 내부 주소 (host-gateway)
#oidc_issuer_url = "http://keycloak:8080/realms/hy-home.realm"
# oidc_issuer_url = "https://keycloak.hy-home.local/realms/hy-home.realm"
oidc_issuer_url = "https://keycloak.127.0.0.1.nip.io/realms/hy-home.realm"


# PKCE 설정
code_challenge_method = "S256"

# --- URL 및 응답 설정 ---
# redirect_url = "https://auth.hy-home.local/oauth2/callback"
redirect_url = "https://auth.127.0.0.1.nip.io/oauth2/callback"

# [핵심] 404 방지용 Upstream (리스트 형식 주의)
upstreams = [ "static://200" ]

# --- 쿠키 설정 (CSRF 해결) ---
cookie_name = "__Secure-sso-cookie"


# (쿠키/CSRF가 정상 동작하는지 보고, 그 다음에 여러 서브도메인으로 확장)
cookie_domains = [ ".127.0.0.1.nip.io" ]

cookie_secure = true
cookie_httponly = true
cookie_samesite = "lax"
cookie_path = "/"
cookie_refresh = "1h"
cookie_expire = "12h"

# --- 화이트리스트 및 이메일 ---
# [중요] 리스트 형식 사용
# whitelist_domains = [ "*.hy-home.local" ]
whitelist_domains = [ "*.127.0.0.1.nip.io" ]
email_domains = [ "*" ]

# --- 서버 설정 ---

http_address = "0.0.0.0:4180"
reverse_proxy = true
skip_provider_button = true
# [추가] 헤더를 통해 그룹 정보를 전달하기 위한 설정
# OAuth2 Proxy가 추출한 클레임(Claim)을 상위 애플리케이션(Grafana 등)에 전달합니다.
pass_authorization_header : <REPLACE_ME>
pass_access_token : <REPLACE_ME>
set_xauthrequest = true
# --- SSL 설정 ---
ssl_insecure_skip_verify = false
