name: oauth2-proxy

x-logging: &default-logging
  driver: 'json-file'
  options:
    max-size: '5m'
    max-file: '2'

x-restart: &default-restart
  restart: unless-stopped

# volumes:
#   oauth2-proxy-valkey-data:
#     driver: local
#     driver_opts:
#       o: bind
#       type: none
#       device: ${DEFAULT_AUTH_DIR}/valkey

secrets:
  oauth2_valkey_password:
    external: true

services:
  oauth2-proxy:
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    build:
      context: .
      dockerfile: Dockerfile
    container_name: oauth2-proxy
    security_opt:
      - no-new-privileges:true
    read_only: true
    <<: *default-restart
    secrets:
      - oauth2_valkey_password
    command:
      - '--config'
      - '/etc/oauth2-proxy.cfg'
    environment:
      # [2] 시스템 레벨 환경 변수 (설정 파일로 대체 불가)
      # SSL 인증서 로드는 앱 로직 이전에 Go 언어 런타임에서 처리하므로 Env에 있어야 함
      - SSL_CERT_FILE=/etc/ssl/certs/rootCA.pem
      # 필수 설정: 세션 저장소를 Redis로 변경
      - OAUTH2_PROXY_SESSION_STORE_TYPE=redis
      # 필수 설정: Redis 연결 주소 (서비스명:포트)
      # - OAUTH2_PROXY_REDIS_CONNECTION_URL=redis://oauth2-proxy-valkey:6379
      - OAUTH2_PROXY_REDIS_CONNECTION_URL=redis://mng-valkey:6379
      # 2. 비밀번호를 파일에서 읽도록 지시 (_FILE 접미사 사용)
      - OAUTH2_PROXY_REDIS_PASSWORD_FILE=/run/secrets/oauth2_valkey_password
      - OAUTH2_PROXY_CLIENT_ID=${OAUTH2_PROXY_CLIENT_ID}
      - OAUTH2_PROXY_CLIENT_SECRET=${OAUTH2_PROXY_CLIENT_SECRET}
      - OAUTH2_PROXY_COOKIE_SECRET=${OAUTH2_PROXY_COOKIE_SECRET}
    volumes:
      # 호스트의 mkcert RootCA를 컨테이너 내부로 주입
      - ./config/oauth2-proxy.cfg:/etc/oauth2-proxy.cfg:ro
      - ../../../secrets/certs/rootCA.pem:/etc/ssl/certs/rootCA.pem:ro
    labels:
      - 'traefik.enable=true'
      # OAuth2 콜백 처리를 위한 라우터
      - 'traefik.http.routers.oauth2-proxy.rule=Host(`auth.${DEFAULT_URL}`)'
      - 'traefik.http.routers.oauth2-proxy.entrypoints=websecure'
      - 'traefik.http.routers.oauth2-proxy.tls=true'
      - 'traefik.http.services.oauth2-proxy.loadbalancer.server.port=${OAUTH2_PROXY_PORT}'
    networks:
      infra_net:
        ipv4_address: 172.19.0.28
    logging: *default-logging

  # oauth2-proxy-valkey:
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '0.5'
  #         memory: 256M
  #   image: valkey/valkey:9.0.2-alpine # Valkey 9.0.x
  #   container_name: oauth2-proxy-valkey
  #   secrets:
  #     - oauth2_valkey_password
  #   networks:
  #     infra_net:
  #       ipv4_address: 172.19.0.18
  #   restart: unless-stopped
  #   volumes:
  #     # 공통 valkey.conf
  #     - oauth2-proxy-valkey-data:/data
  #   command: >
  #     sh -c '
  #     valkey-server
  #     --requirepass "$(cat /run/secrets/oauth2_valkey_password)"
  #     --appendonly yes
  #     --port 6379
  #     '
  #   # 클러스터 내부 통신 포트는 expose
  #   expose:
  #     - '${VALKEY_PORT}'
  #     - '${VALKEY_BUS_PORT}'
  #   healthcheck:
  #     test:
  #       [
  #         'CMD-SHELL',
  #         'V_PASS=$$(cat /run/secrets/valkey_password); valkey-cli -a $$V_PASS -h 127.0.0.1 -p 6379 ping | grep PONG',
  #       ]
  #     interval: 15s
  #     timeout: 30s
  #     retries: 5
  #     start_period: 30s
  #   logging: *default-logging

  # oauth2-proxy-valkey-exporter:
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '0.1'
  #         memory: 128M
  #   image: oliver006/redis_exporter:v1.80.1-alpine
  #   container_name: oauth2-proxy-redis-exporter
  #   expose:
  #     - '${VALKEY_EXPORTER_PORT}'
  #   networks:
  #     infra_net:
  #       ipv4_address: 172.19.0.19
  #   restart: unless-stopped
  #   secrets:
  #     - oauth2_valkey_password
  #   entrypoint:
  #     - /bin/sh
  #     - -c
  #   command:
  #     - |
  #       echo "Reading password from secret..."
  #       export VALKEY_PASSWORD=$(cat /run/secrets/oauth2_valkey_password | tr -d '\n')

  #       echo "Starting Valkey Exporter..."
  #       # -redis.password-file 대신 -redis.password 사용
  #       exec /redis_exporter \
  #         -redis.addr=redis://oauth2-proxy-valkey:6379 \
  #         -redis.password="$VALKEY_PASSWORD" \
  #         -web.listen-address=:${VALKEY_EXPORTER_PORT}
  #   depends_on: # healthcheck를 사용하므로 condition으로 변경 (더 안정적)
  #     oauth2-proxy-valkey:
  #       condition: service_healthy
  #   logging: *default-logging
