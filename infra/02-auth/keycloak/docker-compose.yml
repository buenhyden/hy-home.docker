# Hy-Home System Optimization Headers (Standardized)
x-security-baseline: &security-baseline
  security_opt:
    - no-new-privileges:true
  cap_drop:
    - ALL

x-logging: &default-logging
  driver: 'json-file'
  options:
    max-size: '5m'
    max-file: '2'

x-logging-loki: &logging-loki
  driver: 'loki'
  options:
    loki-url: 'http://localhost:3100/loki/api/v1/push'
    loki-external-labels: 'container_name={{.Name}}'

x-labels-base: &labels-base
  traefik.enable: 'true'
  hy-home.managed: 'true'

x-resource-low: &resource-low
  deploy:
    resources:
      limits: { cpus: '0.2', memory: 128M }
      reservations: { memory: 64M }

x-resource-med: &resource-med
  deploy:
    resources:
      limits: { cpus: '0.5', memory: 512M }
      reservations: { memory: 256M }

x-resource-high: &resource-high
  deploy:
    resources:
      limits: { cpus: '1.0', memory: 1G }
      reservations: { memory: 512M }

x-restart: &default-restart
  restart: unless-stopped

name: keycloak

volumes:
  keycloak-config:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_AUTH_DIR}/keycloak/conf
  keycloak-providers:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_AUTH_DIR}/keycloak/providers
  keycloak-themes:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_AUTH_DIR}/keycloak/themes

services:
  keycloak:
    <<: [*default-restart, *security-baseline, *resource-med]
    image: quay.io/keycloak/keycloak:26.1
    hostname: keycloak
    volumes:
      - keycloak-themes:/opt/keycloak/themes
      - keycloak-config:/opt/keycloak/conf
      - keycloak-providers:/opt/keycloak/providers
    command: start-dev
    expose:
      - ${KEYCLOAK_MANAGEMENT_PORT:-9000}
    healthcheck:
      test: [
          'CMD-SHELL',
          "exec 3<>/dev/tcp/127.0.0.1/${KEYCLOAK_MANAGEMENT_PORT:-9000}; \
          printf 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3; \
          cat <&3 | grep -Eq '\"status\"[[:space:]]*:[[:space:]]*\"UP\"' && exit 0 || exit 1",
        ]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 60s
    environment:
      KC_DB: ${KEYCLOAK_DATABASE}
      KC_DB_URL: jdbc:postgresql://${POSTGRES_MNG_HOSTNAME:-mng-pg}:${POSTGRES_PORT:-5432}/${KEYCLOAK_DBNAME}
      KC_DB_USERNAME: ${KEYCLOAK_DB_USER}
      KC_DB_PASSWORD_FILE: /run/secrets/keycloak_db_password
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN_USER}
      KEYCLOAK_ADMIN_PASSWORD_FILE: /run/secrets/keycloak_admin_password
      KC_HOSTNAME: https://keycloak.${DEFAULT_URL}
      KC_PROXY_HEADERS: xforwarded
      KC_DB_POOL_INITIAL_SIZE: 1
      KC_DB_POOL_MIN_SIZE: 1
      KC_DB_POOL_MAX_SIZE: 10
      KC_METRICS_ENABLED: true
      KC_HEALTH_ENABLED: true
      JAVA_OPTS_APPEND: '-Dquarkus.datasource.jdbc.idle-removal-interval=5M -Dquarkus.datasource.jdbc.background-validation-interval=1M'
    labels:
      <<: *labels-base
      traefik.enable: 'true'
      hy-home.tier: auth
      traefik.http.routers.keycloak.rule: Host(`keycloak.${DEFAULT_URL}`)
      traefik.http.routers.keycloak.entrypoints: websecure
      traefik.http.routers.keycloak.tls: 'true'
      traefik.http.services.keycloak.loadbalancer.server.port: '8080'
    networks:
      infra_net:
        ipv4_address: 172.19.0.29
    secrets:
      - keycloak_db_password
      - keycloak_admin_password
    logging: *logging-loki

networks:
  infra_net:
    name: infra_net
    external: true

secrets:
  keycloak_db_password:
    external: true
  keycloak_admin_password:
    external: true
