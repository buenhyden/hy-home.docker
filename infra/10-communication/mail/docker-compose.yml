name: mail
x-logging: &default-logging
  driver: 'json-file'
  options:
    max-size: '5m'
    max-file: '2'

volumes:
  stalwart-data:
  stalwart_certs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DEFAULT_DOCKER_PROJECT_PATH}/secrets/certs
services:
  # ----------------------------------------------------------------
  # Stalwart Mail Server (올인원 메일 서버)
  # ----------------------------------------------------------------
  stalwart:
    image: stalwartlabs/stalwart:v0.14
    container_name: stalwart
    restart: always
    # [포트 설정]
    # 메일 프로토콜 포트는 Traefik을 통하지 않고 호스트에 직접 노출해야 합니다.
    ports:
      - "${SMTP_HOST_PORT:-25}:${SMTP_PORT:-25}"       # SMTP (서버 간 메일 전송 / 릴레이)
      - "${SUBMISSION_HOST_PORT:-587}:${SUBMISSION_PORT:-587}"     # Submission (클라이언트 메일 발송 - StartTLS)
      - "${SMTPS_HOST_PORT:-465}:${SMTPS_PORT:-465}"     # SMTPS (보안 메일 발송 - Implicit TLS)
      - "${IMAPS_HOST_PORT:-993}:${IMAPS_PORT:-993}"     # IMAPS (메일 수신/확인)
      - "${MANAGESIEVE_HOST_PORT:-4190}:${MANAGESIEVE_PORT:-4190}"   # ManageSieve (메일 필터링 규칙 관리)
      # 8080 포트는 Traefik을 통해 라우팅하므로 주석 처리 (직접 접속 필요 시 해제)
      # - "8080:8080"

    # [데이터 영구 저장]
    volumes:
      - stalwart-data:/opt/stalwart
      - stalwart_certs:/opt/stalwart/certs:ro
    networks:
      - infra_net
    # [환경 변수] - 초기 관리자 계정 설정
    environment:
      - STALWART_ADMIN_USER=admin
      - STALWART_ADMIN_PASSWORD=${STALWART_PASSWORD} # [중요] 최초 실행 후 반드시 변경하세요.

    # [Traefik 연동] - 관리자 웹 UI 라우팅
    labels:
      - "traefik.enable=true"
      # 도메인 접속 설정 (http://mail.${DEFAULT_URL})
      - "traefik.http.routers.stalwart-ui.rule=Host(`mail.${DEFAULT_URL}`)"
      - "traefik.http.services.stalwart-ui.loadbalancer.server.port=${STALWART_PORT:-8080}"
      # (선택) 웹 UI에 OAuth2 Proxy 인증을 걸고 싶다면 아래 주석 해제
      # - "traefik.http.routers.stalwart-ui.middlewares=sso-auth@file"
  mailhog:
    profiles:
      - mail
    image: mailhog/mailhog:v1.0.1
    container_name: mailhog
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    # SMTP 포트(1025)는 내부용, UI 포트(8025)는 Traefik으로 노출
    networks:
      - infra_net
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.mailhog.rule=Host(`mail.${DEFAULT_URL}`)' # 메일함 접속 주소
      - 'traefik.http.routers.mailhog.entrypoints=websecure'
      - 'traefik.http.routers.mailhog.tls=true'
      - 'traefik.http.services.mailhog.loadbalancer.server.port=${MAILHOG_UI_PORT:-8025}'
      - 'traefik.http.routers.mailhog.middlewares=sso-auth@file'
    healthcheck:
      test: ['CMD-SHELL', 'wget -q --spider http://localhost:${MAILHOG_UI_PORT:-8025} || exit 1']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    logging: *default-logging
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          memory: 256M
