# Hy-Home System Optimization Headers (Standardized)
x-security-baseline: &security-baseline
  security_opt:
    - no-new-privileges:true
  cap_drop:
    - ALL

x-logging: &default-logging
  driver: 'json-file'
  options:
    max-size: '5m'
    max-file: '2'

x-resource-low: &resource-low
  deploy:
    resources:
      limits: { cpus: '0.2', memory: 128M }
      reservations: { memory: 64M }

x-resource-med: &resource-med
  deploy:
    resources:
      limits: { cpus: '0.5', memory: 512M }
      reservations: { memory: 256M }

x-resource-high: &resource-high
  deploy:
    resources:
      limits: { cpus: '1.0', memory: 1G }
      reservations: { memory: 512M }

x-restart: &default-restart
  restart: unless-stopped

name: mail

volumes:
  stalwart-data:
  stalwart_certs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DEFAULT_DProject_PATH:-.}/secrets/certs

secrets:
  stalwart_password:
    external: true

services:
  stalwart:
    <<: [*default-restart, *security-baseline, *resource-med]
    image: stalwartlabs/stalwart:v0.14
    container_name: stalwart
    ports:
      - '${SMTP_HOST_PORT:-25}:${SMTP_PORT:-25}'
      - '${SUBMISSION_HOST_PORT:-587}:${SUBMISSION_PORT:-587}'
      - '${SMTPS_HOST_PORT:-465}:${SMTPS_PORT:-465}'
      - '${IMAPS_HOST_PORT:-993}:${IMAPS_PORT:-993}'
      - '${MANAGESIEVE_HOST_PORT:-4190}:${MANAGESIEVE_PORT:-4190}'
    volumes:
      - stalwart-data:/opt/stalwart
      - stalwart_certs:/opt/stalwart/certs:ro
    networks:
      - infra_net
    secrets:
      - stalwart_password
    environment:
      - STALWART_ADMIN_USER=admin
    command: >
      sh -c "
      export STALWART_ADMIN_PASSWORD=$$(cat /run/secrets/stalwart_password) &&
      exec /usr/local/bin/stalwart-mail
      "
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.stalwart-ui.rule=Host(`mail.${DEFAULT_URL}`)'
      - 'traefik.http.services.stalwart-ui.loadbalancer.server.port=${STALWART_PORT:-8080}'
    logging: *default-logging

  mailhog:
    <<: [*default-restart, *security-baseline, *resource-low]
    profiles:
      - mail
    image: mailhog/mailhog:v1.0.1
    container_name: mailhog
    networks:
      - infra_net
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.mailhog.rule=Host(`mail.${DEFAULT_URL}`)'
      - 'traefik.http.routers.mailhog.entrypoints=websecure'
      - 'traefik.http.routers.mailhog.tls=true'
      - 'traefik.http.services.mailhog.loadbalancer.server.port=${MAILHOG_UI_PORT:-8025}'
      - 'traefik.http.routers.mailhog.middlewares=sso-auth@file'
    healthcheck:
      test: ['CMD-SHELL', 'wget -q --spider http://localhost:${MAILHOG_UI_PORT:-8025} || exit 1']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 30s
    logging: *default-logging

networks:
  infra_net:
    name: infra_net
    external: true
