name: keycloak
services:
  keycloak:
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          memory: 512M
    image: quay.io/keycloak/keycloak:26.5.0
    container_name: keycloak
    hostname: keycloak
    restart: unless-stopped
    command: start-dev
    expose:
      - ${KEYCLOAK_MANAGEMENT_PORT}
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:${KEYCLOAK_MANAGEMENT_PORT}/health/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    environment:
      KC_DB: ${KEYCLOAK_DATABASE}
      KC_DB_URL: jdbc:postgresql://${POSTGRES_HOSTNAME}:${POSTGRES_PORT}/${KEYCLOAK_DBNAME}
      KC_DB_USERNAME: ${KEYCLOAK_DB_USER}
      KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD}
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN_USER}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      KC_HOSTNAME: https://keycloak.${DEFAULT_URL}
      KC_PROXY_HEADERS: xforwarded
      # DB 연결이 끊겼는지 확인하고, 오래된 연결을 자동으로 정리합니다.
      KC_DB_POOL_INITIAL_SIZE: 1
      KC_DB_POOL_MIN_SIZE: 1
      KC_DB_POOL_MAX_SIZE: 10
      KC_METRICS_ENABLED: true
      KC_HEALTH_ENABLED: true

      # Java 옵션을 통해 Quarkus(Agroal)의 유효성 검사 강제 설정
      # 1. idle 상태가 5분 지나면 연결 끊음 (DB 타임아웃보다 짧게)
      # 2. 연결 가져올 때 유효성 검사 수행 (background)
      JAVA_OPTS_APPEND: "-Dquarkus.datasource.jdbc.idle-removal-interval=5M -Dquarkus.datasource.jdbc.background-validation-interval=1M"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.keycloak.rule=Host(`keycloak.${DEFAULT_URL}`)"
      - "traefik.http.routers.keycloak.entrypoints=websecure"
      - "traefik.http.routers.keycloak.tls=true"
      - "traefik.http.services.keycloak.loadbalancer.server.port=${KEYCLOAK_PORT}"
    networks:
      infra_net:
        ipv4_address: 172.19.0.29
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

networks:
  infra_net:
    external: true